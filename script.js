// --- Â§öÂúãË™ûË®ÄË®≠ÂÆö (i18n) - ÂÆåÊï¥Áâà ---
const i18n = {
    "zh-TW": {
        dateLabel: "üìÖ Á¥ÄÈåÑÊó•ÊúüÔºö", totalIntake: "‰ªäÊó•ÊîùÂèñ", goal: "ÁõÆÊ®ô",
        pro: "ËõãÁôΩË≥™", fat: "ËÑÇËÇ™", carb: "Á¢≥Ê∞¥", sugar: "Á≥ñ", sod: "Èàâ(mg)", sat: "È£ΩÂíåËÑÇ", trans: "ÂèçÂºèËÑÇ", water: "ÁõÆÊ®ôÊ∞¥",
        chartTitle: "üìä ÁáüÈ§äËàáÁÜ±ÈáèÂàÜÊûê", chartMacro: "‰ªäÊó•‰∏âÂ§ßÁáüÈ§äÁ¥† (PFC)", chartWeekly: "Êú¨ÈÄ±ÁÜ±ÈáèË∂®Âã¢",
        aiTitle: "üì∏ AI È£≤È£üÂàÜÊûê", btnPhoto: "üì∏ 1. ÊãçÁÖß / ÈÅ∏ÊìáÂúñÁâá", btnAnalyze: "ÈÄÅÂá∫ÂúñÁâáÂàÜÊûê", aiLoading: "AI Ê≠£Âú®ÂàÜÊûêÈ£üÁâ©ÁáüÈ§äÔºåË´ãÁ®çÂÄô...",
        aiDescPlaceholder: "üìù Ë£úÂÖÖË™™Êòé (‰æãÂ¶ÇÔºöÈÄôÊòØ‰∏ÄÁ¢óÁâõËÇâÈ∫µÔºåÊ≤íÂä†Ëî•)...",
        recordTitle: "È£≤È£üÁ¥ÄÈåÑ", manualLabel: "ÊâãÂãïË£úÂÖÖ (ÂÉÖÁÜ±Èáè)", placeholderName: "È£üÁâ©ÂêçÁ®±", placeholderCal: "Âç°Ë∑ØÈáå",
        btnAdd: "‚ûï Âä†ÂÖ•Á¥ÄÈåÑ", btnFavSave: "Âä†ÂÖ•ÊúÄÊÑõ", btnFavLoad: "ÈÅ∏ÊìáÂ∏∏ÂêÉÈ£üÁâ©", btnFavAi: "Âä†ÂÖ•ÊúÄÊÑõ",
        settingsTitle: "‚öôÔ∏è ÂÄã‰∫∫Êï∏ÊìöË®≠ÂÆö", gender: "ÊÄßÂà•", male: "Áî∑", female: "Â•≥", age: "Âπ¥ÈΩ°", height: "Ë∫´È´ò", weight: "È´îÈáç",
        activity: "Ê¥ªÂãïÈáè", act1: "‰πÖÂùê (Ëæ¶ÂÖ¨ÂÆ§)", act2: "ËºïÂ∫¶ (ÊØèÈÄ±ÈÅãÂãï1-3Â§©)", act3: "‰∏≠Â∫¶ (ÊØèÈÄ±ÈÅãÂãï3-5Â§©)", act4: "È´òÂ∫¶ (ÊØèÈÄ±ÈÅãÂãï6-7Â§©)",
        mealMode: "üçΩÔ∏è ÊØèÊó•È§êÊï∏Ê®°Âºè", mode4: "Ê®ôÊ∫ñ (3È§ê+ÈªûÂøÉ)", mode3: "3È§ê (ÁÑ°ÈªûÂøÉ)", mode2: "2È§ê (168Êñ∑È£ü)", mode1: "1È§ê (OMAD)",
        btnCalc: "üîÑ ÂÑ≤Â≠ò‰∏¶Êõ¥Êñ∞‰ªãÈù¢", resTdee: "TDEE", resTarget: "Ê∏õÈáçÁõÆÊ®ô",
        modalTitle: "AI ÂàÜÊûêÂ†±Âëä", modalAsk: "Ë´ãÂïèÈÄôÊòØÂì™‰∏ÄÈ§êÔºü", btnCancel: "ÂèñÊ∂à",
        favTitle: "Â∏∏ÂêÉÈ£üÁâ©Ê∏ÖÂñÆ", btnClose: "ÈóúÈñâ",
        menuImport: "ÂåØÂÖ•ÈÇÑÂéü", menuExport: "ÂåØÂá∫ÂÇô‰ªΩ", menuTheme: "ÂàáÊèõ‰∏ªÈ°å", menuLang: "Ë™ûË®Ä", menuCollection: "Êî∂ËóèÁ≥ªÁµ±", suggest: "Âª∫Ë≠∞",
        langTitle: "Ë™ûË®Ä", langCancel: "ÂèñÊ∂à",
        meals: { breakfast: "üç≥ Êó©È§ê", lunch: "üç± ÂçàÈ§ê", dinner: "üç≤ ÊôöÈ§ê", snack: "üç™ ÈªûÂøÉ", meal1: "üçΩÔ∏è Á¨¨‰∏ÄÈ§ê", meal2: "üçΩÔ∏è Á¨¨‰∫åÈ§ê", mealBig: "üèÜ ÂîØ‰∏ÄÂ§ßÈ§ê" },
        alertDel: "Á¢∫ÂÆöË¶ÅÂà™Èô§Ôºü", alertFavAdded: "Â∑≤Âä†ÂÖ•ÊúÄÊÑõÔºÅ", alertFavExist: "ÈÄôÂÄãÈ£üÁâ©Â∑≤Á∂ìÂú®ÊúÄÊÑõÊ∏ÖÂñÆÂõâÔºÅ", alertSelImg: "Ë´ãÂÖàÈÅ∏ÊìáÂúñÁâáÔºÅ", alertAiFail: "AI ÂàÜÊûêÂ§±ÊïóÔºö", alertFill: "Ë´ãÂ°´ÂØ´Ë≥áÊñô", alertNameCal: "Ë´ãËº∏ÂÖ•ÂêçÁ®±ËàáÁÜ±Èáè", alertImportOk: "üéâ Ë≥áÊñôÈÇÑÂéüÊàêÂäüÔºÅ", alertImportFail: "‚ùå Ê™îÊ°àÊ†ºÂºèÈåØË™§",
        msgNormal: "‰∏ª‰∫∫Ôºå‰ªäÂ§©ÂêÉ‰ªÄÈ∫ºÔºü", msgHappy: "Â§™Ê£í‰∫ÜÔºÅÊàëË¶∫ÂæóÂÖÖÊªøÊ¥ªÂäõÔºÅ", msgFat: "ÂëÉ...ÊàëÂ•ΩÂÉèÂêÉÂ§™È£Ω‰∫Ü...", msgThirsty: "Ê∞¥...ÊàëË¶ÅÂñùÊ∞¥...", msgSad: "‰∏ª‰∫∫...Âà•Âøò‰∫ÜÁÖßÈ°ßÊàë..."
    },
    "zh-CN": {
        dateLabel: "üìÖ ËÆ∞ÂΩïÊó•ÊúüÔºö", totalIntake: "‰ªäÊó•ÊëÑÂèñ", goal: "ÁõÆÊ†á",
        pro: "ËõãÁôΩË¥®", fat: "ËÑÇËÇ™", carb: "Á¢≥Ê∞¥", sugar: "Á≥ñ", sod: "Èí†(mg)", sat: "È•±ÂíåËÑÇ", trans: "ÂèçÂºèËÑÇ", water: "ÁõÆÊ†áÊ∞¥",
        chartTitle: "üìä Ëê•ÂÖª‰∏éÁÉ≠ÈáèÂàÜÊûê", chartMacro: "‰ªäÊó•‰∏âÂ§ßËê•ÂÖªÁ¥† (PFC)", chartWeekly: "Êú¨Âë®ÁÉ≠ÈáèË∂ãÂäø",
        aiTitle: "üì∏ AI È•ÆÈ£üÂàÜÊûê", btnPhoto: "üì∏ 1. ÊãçÁÖß / ÈÄâÊã©ÂõæÁâá", btnAnalyze: "ÂèëÈÄÅÂõæÁâáÂàÜÊûê", aiLoading: "AI Ê≠£Âú®ÂàÜÊûêÈ£üÁâ©Ëê•ÂÖªÔºåËØ∑Á®çÂÄô...",
        aiDescPlaceholder: "üìù Ë°•ÂÖÖËØ¥Êòé (‰æãÂ¶ÇÔºöËøôÊòØ‰∏ÄÁ¢óÁâõËÇâÈù¢ÔºåÊ≤°Âä†Ëë±)...",
        recordTitle: "È•ÆÈ£üËÆ∞ÂΩï", manualLabel: "ÊâãÂä®Ë°•ÂÖÖ (‰ªÖÁÉ≠Èáè)", placeholderName: "È£üÁâ©ÂêçÁß∞", placeholderCal: "Âç°Ë∑ØÈáå",
        btnAdd: "‚ûï Âä†ÂÖ•ËÆ∞ÂΩï", btnFavSave: "Âä†ÂÖ•Êî∂Ëóè", btnFavLoad: "ÈÄâÊã©Â∏∏ÂêÉÈ£üÁâ©", btnFavAi: "Âä†ÂÖ•Êî∂Ëóè",
        settingsTitle: "‚öôÔ∏è ‰∏™‰∫∫Êï∞ÊçÆËÆæÂÆö", gender: "ÊÄßÂà´", male: "Áî∑", female: "Â•≥", age: "Âπ¥ÈæÑ", height: "Ë∫´È´ò", weight: "‰ΩìÈáç",
        activity: "Ê¥ªÂä®Èáè", act1: "‰πÖÂùê (ÂäûÂÖ¨ÂÆ§)", act2: "ËΩªÂ∫¶ (ÊØèÂë®ËøêÂä®1-3Â§©)", act3: "‰∏≠Â∫¶ (ÊØèÂë®ËøêÂä®3-5Â§©)", act4: "È´òÂ∫¶ (ÊØèÂë®ËøêÂä®6-7Â§©)",
        mealMode: "üçΩÔ∏è ÊØèÊó•È§êÊï∞Ê®°Âºè", mode4: "Ê†áÂáÜ (3È§ê+ÁÇπÂøÉ)", mode3: "3È§ê (Êó†ÁÇπÂøÉ)", mode2: "2È§ê (168Êñ≠È£ü)", mode1: "1È§ê (OMAD)",
        btnCalc: "üîÑ ‰øùÂ≠òÂπ∂Êõ¥Êñ∞ÁïåÈù¢", resTdee: "TDEE", resTarget: "ÂáèÈáçÁõÆÊ†á",
        modalTitle: "AI ÂàÜÊûêÊä•Âëä", modalAsk: "ËØ∑ÈóÆËøôÊòØÂì™‰∏ÄÈ§êÔºü", btnCancel: "ÂèñÊ∂à",
        favTitle: "Â∏∏ÂêÉÈ£üÁâ©Ê∏ÖÂçï", btnClose: "ÂÖ≥Èó≠",
        menuImport: "ÂØºÂÖ•ËøòÂéü", menuExport: "ÂØºÂá∫Â§á‰ªΩ", menuTheme: "ÂàáÊç¢‰∏ªÈ¢ò", menuLang: "ËØ≠Ë®Ä", menuCollection: "Êî∂ËóèÁ≥ªÁªü", suggest: "Âª∫ËÆÆ",
        langTitle: "ËØ≠Ë®Ä", langCancel: "ÂèñÊ∂à",
        meals: { breakfast: "üç≥ Êó©È§ê", lunch: "üç± ÂçàÈ§ê", dinner: "üç≤ ÊôöÈ§ê", snack: "üç™ ÁÇπÂøÉ", meal1: "üçΩÔ∏è Á¨¨‰∏ÄÈ§ê", meal2: "üçΩÔ∏è Á¨¨‰∫åÈ§ê", mealBig: "üèÜ ÂîØ‰∏ÄÂ§ßÈ§ê" },
        alertDel: "Á°ÆÂÆöË¶ÅÂà†Èô§Ôºü", alertFavAdded: "Â∑≤Âä†ÂÖ•Êî∂ËóèÔºÅ", alertFavExist: "Ëøô‰∏™È£üÁâ©Â∑≤ÁªèÂú®Êî∂ËóèÊ∏ÖÂçïÂï∞ÔºÅ", alertSelImg: "ËØ∑ÂÖàÈÄâÊã©ÂõæÁâáÔºÅ", alertAiFail: "AI ÂàÜÊûêÂ§±Ë¥•Ôºö", alertFill: "ËØ∑Â°´ÂÜôËµÑÊñô", alertNameCal: "ËØ∑ËæìÂÖ•ÂêçÁß∞‰∏éÁÉ≠Èáè", alertImportOk: "üéâ ËµÑÊñôËøòÂéüÊàêÂäüÔºÅ", alertImportFail: "‚ùå Ê°£Ê°àÊ†ºÂºèÈîôËØØ",
        msgNormal: "‰∏ª‰∫∫Ôºå‰ªäÂ§©ÂêÉ‰ªÄ‰πàÔºü", msgHappy: "Â§™Ê£í‰∫ÜÔºÅÊàëËßâÂæóÂÖÖÊª°Ê¥ªÂäõÔºÅ", msgFat: "ÂëÉ...ÊàëÂ•ΩÂÉèÂêÉÂ§™È•±‰∫Ü...", msgThirsty: "Ê∞¥...ÊàëË¶ÅÂñùÊ∞¥...", msgSad: "‰∏ª‰∫∫...Âà´Âøò‰∫ÜÁÖßÈ°æÊàë..."
    },
    "en": {
        dateLabel: "üìÖ Date:", totalIntake: "Total Intake", goal: "Goal",
        pro: "Protein", fat: "Fat", carb: "Carb", sugar: "Sugar", sod: "Sodium", sat: "Sat. Fat", trans: "Trans Fat", water: "Water",
        chartTitle: "üìä Nutrition Analysis", chartMacro: "Macros (PFC)", chartWeekly: "Weekly Calories",
        aiTitle: "üì∏ AI Analysis", btnPhoto: "üì∏ 1. Select Photo", btnAnalyze: "Analyze", aiLoading: "AI is analyzing...",
        aiDescPlaceholder: "üìù Optional description (e.g. Beef noodles, no onions)...",
        recordTitle: "Food Log", manualLabel: "Manual Entry (Calorie only)", placeholderName: "Food Name", placeholderCal: "Calories",
        btnAdd: "‚ûï Add Log", btnFavSave: "Save Favorite", btnFavLoad: "Load Favorite", btnFavAi: "Save to Favorites",
        settingsTitle: "‚öôÔ∏è Profile Settings", gender: "Gender", male: "Male", female: "Female", age: "Age", height: "Height", weight: "Weight",
        activity: "Activity Level", act1: "Sedentary", act2: "Lightly Active", act3: "Moderately Active", act4: "Very Active",
        mealMode: "üçΩÔ∏è Meal Mode", mode4: "Standard (3+Snack)", mode3: "3 Meals", mode2: "2 Meals (168)", mode1: "OMAD",
        btnCalc: "üîÑ Save & Update", resTdee: "TDEE", resTarget: "Target",
        modalTitle: "AI Report", modalAsk: "Which meal is this?", btnCancel: "Cancel",
        favTitle: "Favorite Foods", btnClose: "Close",
        menuImport: "Import Data", menuExport: "Export Data", menuTheme: "Switch Theme", menuLang: "Language", menuCollection: "Collection", suggest: "Goal",
        langTitle: "Language", langCancel: "Cancel",
        meals: { breakfast: "üç≥ Breakfast", lunch: "üç± Lunch", dinner: "üç≤ Dinner", snack: "üç™ Snack", meal1: "üçΩÔ∏è Meal 1", meal2: "üçΩÔ∏è Meal 2", mealBig: "üèÜ Big Meal" },
        alertDel: "Delete this item?", alertFavAdded: "Saved to favorites!", alertFavExist: "Already in favorites!", alertSelImg: "Select image first!", alertAiFail: "AI Failed: ", alertFill: "Fill all fields", alertNameCal: "Enter name and calories", alertImportOk: "üéâ Data Restored!", alertImportFail: "‚ùå Invalid File",
        msgNormal: "What are we eating today?", msgHappy: "I feel great!", msgFat: "Ugh... too much food...", msgThirsty: "Water... please...", msgSad: "Don't forget me..."
    },
    "ja": {
        dateLabel: "üìÖ Êó•‰ªòÔºö", totalIntake: "ÊëÇÂèñ„Ç´„É≠„É™„Éº", goal: "ÁõÆÊ®ô",
        pro: "„Çø„É≥„Éë„ÇØË≥™", fat: "ËÑÇË≥™", carb: "ÁÇ≠Ê∞¥ÂåñÁâ©", sugar: "Á≥ñË≥™", sod: "Â°©ÂàÜ", sat: "È£ΩÂíåËÑÇËÇ™", trans: "„Éà„É©„É≥„ÇπËÑÇËÇ™", water: "Ê∞¥ÂàÜÁõÆÊ®ô",
        chartTitle: "üìä Ê†ÑÈ§äÂàÜÊûê", chartMacro: "‰∏âÂ§ßÊ†ÑÈ§äÁ¥† (PFC)", chartWeekly: "ÈÄ±Èñì„Ç´„É≠„É™„Éº",
        aiTitle: "üì∏ AIÈ£ü‰∫ãÂàÜÊûê", btnPhoto: "üì∏ 1. ÂÜôÁúü„ÇíÈÅ∏Êäû", btnAnalyze: "ÂàÜÊûêÈñãÂßã", aiLoading: "AIÂàÜÊûê‰∏≠...",
        aiDescPlaceholder: "üìù Ë£úË∂≥Ë™¨Êòé (‰æã: ÁâõËÇâÈ∫∫„ÄÅ„Éç„ÇÆÊäú„Åç)...",
        recordTitle: "È£ü‰∫ãË®òÈå≤", manualLabel: "ÊâãÂãïÂÖ•Âäõ („Ç´„É≠„É™„Éº„ÅÆ„Åø)", placeholderName: "È£üÂìÅÂêç", placeholderCal: "kcal",
        btnAdd: "‚ûï Ë®òÈå≤ËøΩÂä†", btnFavSave: "„ÅäÊ∞ó„Å´ÂÖ•„Çä‰øùÂ≠ò", btnFavLoad: "„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÈÅ∏Êäû", btnFavAi: "„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´‰øùÂ≠ò",
        settingsTitle: "‚öôÔ∏è „Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö", gender: "ÊÄßÂà•", male: "Áî∑ÊÄß", female: "Â•≥ÊÄß", age: "Âπ¥ÈΩ¢", height: "Ë∫´Èï∑", weight: "‰ΩìÈáç",
        activity: "Ê¥ªÂãï„É¨„Éô„É´", act1: "Â∫ß„Çä‰ªï‰∫ã", act2: "ËªΩ„ÅÑÈÅãÂãï (ÈÄ±1-3)", act3: "‰∏≠Á®ãÂ∫¶„ÅÆÈÅãÂãï (ÈÄ±3-5)", act4: "ÊøÄ„Åó„ÅÑÈÅãÂãï (ÈÄ±6-7)",
        mealMode: "üçΩÔ∏è È£ü‰∫ãÂõûÊï∞", mode4: "Ê®ôÊ∫ñ (3È£ü+ÈñìÈ£ü)", mode3: "3È£ü„ÅÆ„Åø", mode2: "2È£ü (168Êñ≠È£ü)", mode1: "1È£ü (OMAD)",
        btnCalc: "üîÑ ‰øùÂ≠ò„Åó„Å¶Êõ¥Êñ∞", resTdee: "TDEE", resTarget: "ÁõÆÊ®ô",
        modalTitle: "AIÂàÜÊûê„É¨„Éù„Éº„Éà", modalAsk: "„Å©„ÅÆÈ£ü‰∫ã„Åß„Åô„ÅãÔºü", btnCancel: "„Ç≠„É£„É≥„Çª„É´",
        favTitle: "„ÅäÊ∞ó„Å´ÂÖ•„Çä„É™„Çπ„Éà", btnClose: "Èñâ„Åò„Çã",
        menuImport: "Âæ©ÂÖÉ", menuExport: "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó", menuTheme: "„ÉÜ„Éº„ÉûÂàáÊõø", menuLang: "Ë®ÄË™û", menuCollection: "„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥", suggest: "ÁõÆÂÆâ",
        langTitle: "Ë®ÄË™û", langCancel: "„Ç≠„É£„É≥„Çª„É´",
        meals: { breakfast: "üç≥ ÊúùÈ£ü", lunch: "üç± ÊòºÈ£ü", dinner: "üç≤ Â§ïÈ£ü", snack: "üç™ ÈñìÈ£ü", meal1: "üçΩÔ∏è È£ü‰∫ã1", meal2: "üçΩÔ∏è È£ü‰∫ã2", mealBig: "üèÜ Â§ßÁõõ„Çä" },
        alertDel: "ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", alertFavAdded: "„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ", alertFavExist: "Êó¢„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åô", alertSelImg: "ÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ", alertAiFail: "AI„Ç®„É©„Éº: ", alertFill: "ÂÖ®„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", alertNameCal: "ÂêçÁß∞„Å®„Ç´„É≠„É™„Éº„ÇíÂÖ•Âäõ", alertImportOk: "üéâ Âæ©ÂÖÉÂÆå‰∫ÜÔºÅ", alertImportFail: "‚ùå „Éï„Ç°„Ç§„É´„Ç®„É©„Éº",
        msgNormal: "‰ªäÊó•„ÅØ‰Ωï„ÇíÈ£ü„Åπ„Åæ„Åô„ÅãÔºü", msgHappy: "ÊúÄÈ´òÔºÅÂÖÉÊ∞ó„ÅÑ„Å£„Å±„ÅÑ„Åß„ÅôÔºÅ", msgFat: "„ÅÜ„ÅÖ...È£ü„ÅπÈÅé„Åé„Åæ„Åó„Åü...", msgThirsty: "Ê∞¥...Ê∞¥„Çí„Åè„Å†„Åï„ÅÑ...", msgSad: "Âøò„Çå„Å™„ÅÑ„Åß..."
    }
};

let curLang = localStorage.getItem('appLang') || "zh-TW";
let curTheme = localStorage.getItem('appTheme') || "light";

// --- ÂÖ®ÂüüËÆäÊï∏ ---
let foodItems = []; 
let targetCalories = 2000;
let tempAIResult = null;
let selectedDate = new Date().toISOString().split('T')[0];
let currentMealMode = "4";
let favoriteFoods = JSON.parse(localStorage.getItem('myFavorites') || "[]");

const PET_DB = {
    dog: { 
        normal: 'dog_animation/dog_idle.gif', 
        happy: 'dog_animation/dog_happy.gif', 
        sad: 'dog_animation/dog_sad.gif', 
        fat: 'dog_animation/dog_fat.gif',
        eat: 'dog_animation/dog_eat.gif',
        walk: 'dog_animation/dog_walk.gif'
    }
};

const UNLOCKS = [
    { id: 'scarf', name: 'È†òÂ∑æ', day: 3, type: 'acc', icon: 'üß£' },
    { id: 'glasses', name: 'Â¢®Èè°', day: 7, type: 'acc', icon: 'üï∂Ô∏è' }
];

let myPet = JSON.parse(localStorage.getItem('myPetProfile_v3') || "null");
let macroChart = null;
let weeklyChart = null;

// --- ÂàùÂßãÂåñ ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. ÂÖàÁ∂ÅÂÆö‰∫ã‰ª∂
    setupEventListeners();
    
    // 2. ËºâÂÖ•Ë®≠ÂÆö
    setTheme(curTheme);
    setLang(curLang);
    document.getElementById('current-date').value = selectedDate;
    
    // 3. ÂàùÂßãÂåñÂäüËÉΩ
    initPetSystem();
    loadProfile();
    loadFoodData(selectedDate);
    initCharts();
});

// --- ‰∫ã‰ª∂Á∂ÅÂÆö ---
function setupEventListeners() {
    document.getElementById('current-date').addEventListener('change', changeDate);
    document.getElementById('image-upload').addEventListener('change', function() { handleFileSelect(this); });
    document.getElementById('btn-take-photo').addEventListener('click', () => document.getElementById('image-upload').click());
    document.getElementById('analyze-btn').addEventListener('click', startAnalysis);
    
    document.getElementById('btn-add-record').addEventListener('click', addManualFood);
    document.getElementById('btn-fav-save-main').addEventListener('click', saveToFavorites);
    document.getElementById('btn-fav-load-main').addEventListener('click', openFavModal);
    
    document.getElementById('meal-mode').addEventListener('change', () => calculateProfile());
    document.getElementById('btn-calc').addEventListener('click', () => calculateProfile());
    
    document.getElementById('btn-ai-fav-save').addEventListener('click', saveAIResultToFavorites);
    document.getElementById('btn-cancel').addEventListener('click', () => closeModal('analysis-modal'));
    document.getElementById('btn-fav-close').addEventListener('click', () => closeModal('fav-modal'));
    
    document.getElementById('btn-toggle-theme').addEventListener('click', toggleTheme);
    document.getElementById('btn-open-lang').addEventListener('click', openLangModal);
    document.getElementById('btn-open-collection').addEventListener('click', openCollectionModal);
    document.getElementById('import-file').addEventListener('change', function() { importData(this); });
    document.getElementById('btn-export').addEventListener('click', exportData);
    document.getElementById('btn-fab-main').addEventListener('click', toggleFabMenu);
    document.getElementById('btn-lang-cancel').addEventListener('click', () => closeModal('lang-modal'));
    document.getElementById('btn-collection-close').addEventListener('click', () => closeModal('collection-modal'));
    document.getElementById('btn-pet-start').addEventListener('click', savePetProfile);

    document.querySelectorAll('.lang-option').forEach(opt => {
        opt.addEventListener('click', function() {
            setLang(this.getAttribute('data-lang'));
            closeModal('lang-modal');
        });
    });
}

// --- üê∂ ÂØµÁâ©Á≥ªÁµ± ---
function initPetSystem() {
    if (!myPet) {
        document.getElementById('pet-modal').style.display = 'flex';
    } else {
        const todayStr = new Date().toISOString().split('T')[0];
        if (myPet.lastLog !== todayStr) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (myPet.lastLog === yesterdayStr) {
                myPet.streak = (myPet.streak || 0) + 1;
            } else if (myPet.lastLog < yesterdayStr) {
                myPet.streak = 1;
            } else {
                myPet.streak = 1;
            }
            myPet.lastLog = todayStr;
            savePetData();
            checkUnlocks();
        }
        renderPet();
    }
}

function savePetProfile() {
    const name = document.getElementById('pet-name-input').value.trim();
    if (!name) { alert("Ë´ãÂπ´Áâ†ÂèñÂÄãÂêçÂ≠óÔºÅ"); return; }
    myPet = { 
        type: 'dog', name: name, 
        level: 1, exp: 0, streak: 1, lastLog: new Date().toISOString().split('T')[0],
        unlocked: [], equipPet: 'dog', equipAcc: ''
    };
    savePetData();
    document.getElementById('pet-modal').style.display = 'none';
    renderPet();
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
}

function savePetData() {
    localStorage.setItem('myPetProfile_v3', JSON.stringify(myPet));
}

function checkUnlocks() {
    let newUnlock = false;
    UNLOCKS.forEach(item => {
        if (myPet.streak >= item.day && !myPet.unlocked.includes(item.id)) {
            myPet.unlocked.push(item.id);
            alert(`üéâ ÊÅ≠ÂñúÔºÅÈÄ£Á∫åÁ¥ÄÈåÑ ${item.day} Â§©ÔºåËß£Èéñ‰∫Ü„Äå${item.icon} ${item.name}„ÄçÔºÅ`);
            newUnlock = true;
        }
    });
    if(newUnlock) savePetData();
}

function renderPet() {
    if(!myPet) return;
    document.getElementById('pet-name-display').innerText = myPet.name;
    document.getElementById('pet-level').innerText = myPet.level;
    document.getElementById('streak-days').innerText = myPet.streak;
    
    const maxExp = myPet.level * 100;
    const expPct = Math.min(100, (myPet.exp / maxExp) * 100);
    document.getElementById('exp-bar').style.width = `${expPct}%`;

    updatePetStateDisplay();
}

function updatePetStateDisplay() {
    const currentCal = parseFloat(document.getElementById('total-cal-display').innerText) || 0;
    const targetCal = parseFloat(document.getElementById('target-cal-display').innerText) || 2000;
    const ratio = currentCal / targetCal;
    
    const avatarEl = document.getElementById('pet-avatar');
    const msgEl = document.getElementById('pet-msg');
    
    const t = i18n[curLang] || i18n['zh-TW'];
    let mood = 'normal';
    let msg = t.msgNormal;

    if (ratio > 1.1) {
        mood = 'fat'; msg = t.msgFat;
    } else if (ratio >= 0.8 && ratio <= 1.1) {
        mood = 'happy'; msg = t.msgHappy;
    } else if (ratio < 0.2) {
        mood = 'normal'; 
    }

    if (!avatarEl.dataset.isBusy) {
        avatarEl.src = PET_DB['dog'][mood];
    }
    
    const accEl = document.getElementById('pet-accessory');
    accEl.innerText = myPet.equipAcc ? UNLOCKS.find(u=>u.id===myPet.equipAcc)?.icon || '' : '';
    msgEl.innerText = msg;
}

function petInteraction() {
    const avatarEl = document.getElementById('pet-avatar');
    avatarEl.src = PET_DB['dog']['happy'];
    avatarEl.dataset.isBusy = true;
    const msgs = ["Ê±™ÔºÅ", "‚ù§Ô∏è", "ÊàëË¶ÅÂêÉËÇâËÇâÔºÅ", "Âä†Ê≤πÔºÅ"];
    document.getElementById('pet-msg').innerText = msgs[Math.floor(Math.random()*msgs.length)];
    setTimeout(() => {
        avatarEl.dataset.isBusy = false;
        updatePetStateDisplay();
    }, 2000);
}

function playEatAnimation() {
    const avatarEl = document.getElementById('pet-avatar');
    avatarEl.src = PET_DB['dog']['eat'];
    avatarEl.dataset.isBusy = true;
    setTimeout(() => {
        avatarEl.dataset.isBusy = false;
        updatePetStateDisplay();
    }, 3000);
}

function addExp(amount) {
    myPet.exp += amount;
    const maxExp = myPet.level * 100;
    if (myPet.exp >= maxExp) {
        myPet.level++;
        myPet.exp -= maxExp;
        alert(`üéâ ${myPet.name} ÂçáÁ¥ö‰∫ÜÔºÅËÆäÊàê‰∫Ü Lv.${myPet.level}ÔºÅ`);
        confetti({ particleCount: 150, spread: 60 });
    }
    savePetData();
    renderPet();
}

function openCollectionModal() {
    document.getElementById('streak-count-modal').innerText = myPet.streak;
    const grid = document.getElementById('collection-grid');
    grid.innerHTML = '';
    const defaults = [{ id: 'dog', name: 'ÁãóÁãó', type: 'pet', icon: 'üê∂' }];
    const allItems = [...defaults, ...UNLOCKS];
    allItems.forEach(item => {
        const isDefault = (item.id === 'dog');
        const isUnlocked = isDefault || myPet.unlocked.includes(item.id);
        const isActive = (item.type === 'pet' && myPet.equipPet === item.id) || (item.type === 'acc' && myPet.equipAcc === item.id);
        const div = document.createElement('div');
        div.className = `collection-item ${isUnlocked ? 'unlocked' : ''} ${isActive ? 'active' : ''}`;
        div.onclick = () => equipItem(item, isUnlocked);
        let hint = isUnlocked ? 'Â∑≤ÊìÅÊúâ' : `ÈÄ£Á∫å ${item.day} Â§©`;
        if (isDefault) hint = 'È†êË®≠';
        div.innerHTML = `<span class="collection-icon">${isUnlocked ? item.icon : 'üîí'}</span><span class="collection-name">${item.name}</span><span class="lock-hint">${hint}</span>`;
        grid.appendChild(div);
    });
    document.getElementById('collection-modal').style.display = 'flex';
    toggleFabMenu();
}

function equipItem(item, isUnlocked) {
    if (!isUnlocked) { alert(`ÈÇÑÊ≤íËß£ÈéñÂñîÔºÅÈúÄË¶ÅÈÄ£Á∫åÁ¥ÄÈåÑ ${item.day} Â§©„ÄÇ`); return; }
    if (item.type === 'acc') {
        myPet.equipAcc = (myPet.equipAcc === item.id) ? '' : item.id;
    }
    savePetData();
    openCollectionModal();
    renderPet();
}

// --- Ê†∏ÂøÉËàáÂ∑•ÂÖ∑ÂáΩÂºè ---
function toggleTheme() {
    const newTheme = curTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
}
function setTheme(theme) {
    curTheme = theme;
    localStorage.setItem('appTheme', theme);
    document.documentElement.setAttribute('data-theme', theme);
    updateChartTheme(theme);
}
function openLangModal() { document.getElementById('lang-modal').style.display = 'flex'; toggleFabMenu(); }
function setLang(lang) {
    curLang = lang;
    localStorage.setItem('appLang', lang);
    const t = i18n[lang];
    
    // Êõ¥Êñ∞‰ªãÈù¢ÊñáÂ≠ó
    const mapping = {
        'txt-date-label': t.dateLabel, 'txt-total-intake': t.totalIntake, 'txt-goal-label': t.goal,
        'lbl-pro': t.pro, 'lbl-fat': t.fat, 'lbl-carb': t.carb, 'lbl-sugar': t.sugar, 'lbl-sod': t.sod, 'lbl-sat': t.sat, 'lbl-trans': t.trans, 'lbl-water': t.water,
        'txt-chart-title': t.chartTitle, 'txt-chart-macro': t.chartMacro, 'txt-chart-weekly': t.chartWeekly,
        'txt-ai-title': t.aiTitle, 'btn-take-photo': t.btnPhoto, 'txt-analyze-btn': t.btnAnalyze, 'txt-ai-loading': t.aiLoading,
        'txt-record-title': t.recordTitle, 'txt-manual-label': t.manualLabel, 'btn-add-record': t.btnAdd, 'btn-fav-save-main': t.btnFavSave, 'btn-fav-load-main': t.btnFavLoad, 'btn-ai-fav-save': t.btnFavAi,
        'txt-settings-title': t.settingsTitle, 'lbl-gender': t.gender, 'opt-male': t.male, 'opt-female': t.female,
        'lbl-age': t.age, 'lbl-height': t.height, 'lbl-weight': t.weight, 'lbl-activity': t.activity,
        'opt-act-1': t.act1, 'opt-act-2': t.act2, 'opt-act-3': t.act3, 'opt-act-4': t.act4,
        'lbl-meal-mode': t.mealMode, 'opt-mode-4': t.mode4, 'opt-mode-3': t.mode3, 'opt-mode-2': t.mode2, 'opt-mode-1': t.mode1,
        'btn-calc': t.btnCalc, 'txt-res-tdee': t.resTdee, 'txt-res-target': t.resTarget,
        'txt-modal-title': t.modalTitle, 'txt-modal-ask': t.modalAsk, 'btn-cancel': t.btnCancel,
        'txt-fav-title': t.favTitle, 'btn-fav-close': t.btnClose, 'menu-import': t.menuImport, 'menu-export': t.menuExport, 'menu-theme': t.menuTheme, 'menu-lang': t.menuLang, 'menu-collection': t.menuCollection,
        'txt-lang-title': t.langTitle, 'btn-lang-cancel': t.langCancel
    };

    for(let id in mapping) {
        const el = document.getElementById(id);
        if(el) el.innerText = mapping[id];
    }

    document.getElementById('manual-name').placeholder = t.placeholderName;
    document.getElementById('manual-cal').placeholder = t.placeholderCal;
    document.getElementById('ai-desc').placeholder = t.aiDescPlaceholder;
    document.querySelectorAll('.txt-suggest').forEach(el => el.innerText = t.suggest);
    
    updateMealUI(); 
    if(macroChart) {
        macroChart.data.labels = [t.pro, t.fat, t.carb];
        macroChart.update();
    }
}

function toggleFabMenu() { document.getElementById('fab-menu').classList.toggle('show'); }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function confirmAddFood(type) { 
    foodItems.push({ type: type, name: tempAIResult.name, nutri: tempAIResult.nutri }); 
    saveFoodData(); 
    renderListAndStats(); 
    closeModal('analysis-modal');
    addExp(20); 
    playEatAnimation(); 
}

function addManualFood() {
    const name = document.getElementById('manual-name').value; const cal = parseFloat(document.getElementById('manual-cal').value); const type = document.getElementById('manual-type').value;
    if (name && cal) {
        foodItems.push({ type: type, name: name, nutri: { calories: cal, protein:0, fat:0, carbohydrate:0, sugar:0, sodium:0, saturatedFat:0, transFat:0 } });
        saveFoodData(); renderListAndStats();
        document.getElementById('manual-name').value = ''; document.getElementById('manual-cal').value = '';
        addExp(10);
        playEatAnimation(); 
    } else { alert(i18n[curLang].alertNameCal); }
}

function exportData() {
    const data = {};
    for(let i=0; i<localStorage.length; i++) {
        const key = localStorage.key(i);
        if(key.startsWith('record_') || key.startsWith('myProfile') || key === 'myFavorites') {
            data[key] = localStorage.getItem(key);
        }
    }
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `nutrition_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); toggleFabMenu();
}
function importData(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            for(let key in data) localStorage.setItem(key, data[key]);
            alert(i18n[curLang].alertImportOk); location.reload();
        } catch(err) { alert(i18n[curLang].alertImportFail); }
    }; reader.readAsText(file); toggleFabMenu();
}

// --- AI ÂëºÂè´ (ÊÅ¢Âæ©Âº∑Â§ßÊåá‰ª§) ---
async function callCloudflareAI(base64, userDesc) {
    const url = "https://nameless-meadow-cf7b.jtwen12345us.workers.dev/";
    const promptMap = {
        "zh-TW": "‰Ω†ÊòØ‰∏Ä‰ΩçÁáüÈ§äÂ∏´„ÄÇË´ãÂàÜÊûêÂúñÁâáÈ£üÁâ©ÁöÑ„ÄåÂÖ´Â§ßÁáüÈ§äÊåáÊ®ô„Äç„ÄÇÂõûÂÇ≥Á¥î JSON Ê†ºÂºè„ÄÇÊ¨Ñ‰ΩçÔºöfoodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFat„ÄÇ\n\nÈáçË¶ÅË¶èÂâáÔºö\n1. Ë´ãÂãøÈ´ò‰º∞‰ªΩÈáèÔºåËã•‰∏çÁ¢∫ÂÆöË´ãÊé°Áî®„ÄåÊ®ôÊ∫ñÂ∏ÇÂîÆ‰ªΩÈáè„ÄçÊàñ„Äå‰øùÂÆà‰º∞Ë®à„Äç„ÄÇ\n2. Èô§ÈùûÂúñÁâá‰∏≠ÊúâÊòéÈ°ØÂ§ß‰ªΩÈáèÁâπÂæµÔºåÂê¶ÂâáË´ã‰ª•„Äå‰∏Ä‰∫∫‰ªΩ„ÄçÁÇ∫Âü∫Ê∫ñ„ÄÇ\n",
        "zh-CN": "‰Ω†ÊòØ‰∏Ä‰ΩçËê•ÂÖªÂ∏à„ÄÇËØ∑ÂàÜÊûêÂõæÁâáÈ£üÁâ©ÁöÑ„ÄåÂÖ´Â§ßËê•ÂÖªÊåáÊ†á„Äç„ÄÇÂõû‰º†Á∫Ø JSON Ê†ºÂºè„ÄÇÊ†è‰ΩçÔºöfoodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFat„ÄÇ\n\nÈáçË¶ÅËßÑÂàôÔºö\n1. ËØ∑ÂãøÈ´ò‰º∞‰ªΩÈáèÔºåËã•‰∏çÁ°ÆÂÆöËØ∑ÈááÁî®„ÄåÊ†áÂáÜÂ∏ÇÂîÆ‰ªΩÈáè„ÄçÊàñ„Äå‰øùÂÆà‰º∞ËÆ°„Äç„ÄÇ\n2. Èô§ÈùûÂõæÁâá‰∏≠ÊúâÊòéÊòæÂ§ß‰ªΩÈáèÁâπÂæÅÔºåÂê¶ÂàôËØ∑‰ª•„Äå‰∏Ä‰∫∫‰ªΩ„Äç‰∏∫Âü∫ÂáÜ„ÄÇ\n",
        "en": "You are a nutritionist. Analyze the image for 8 nutritional metrics. Return PURE JSON. Fields: foodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFat.\n\nCRITICAL INSTRUCTIONS:\n1. Do NOT overestimate portion sizes. Be conservative.\n2. Assume 'standard single serving' unless the image clearly shows a huge portion.\n",
        "ja": "„ÅÇ„Å™„Åü„ÅØÊ†ÑÈ§äÂ£´„Åß„Åô„ÄÇÁîªÂÉè„ÅÆÈ£üÂìÅ„ÅÆ8„Å§„ÅÆÊ†ÑÈ§äÊåáÊ®ô„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁ¥îÁ≤ã„Å™JSON„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éï„Ç£„Éº„É´„ÉâÔºöfoodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFat„ÄÇ\n\nÈáçË¶Å„Å™„É´„Éº„É´Ôºö\n1. ÂàÜÈáè„ÇíÈÅéÂ§ßË©ï‰æ°„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇÁ¢∫‰ø°„ÅåÊåÅ„Å¶„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄåÊ®ôÊ∫ñÁöÑ„Å™‰∏Ä‰∫∫Ââç„Äç„Åæ„Åü„ÅØ„ÄåÊéß„Åà„ÇÅ„Å™Ë¶ãÁ©ç„ÇÇ„Çä„Äç„ÇíÊé°Áî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n"
    };
    
    let prompt = promptMap[curLang] || promptMap['en'];
    if(userDesc) {
        prompt += `\n\n[User's supplementary description]: ${userDesc}\n(Please adjust the estimation based on this description.)`;
    }

    const resp = await fetch(url, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } } ] }] })
    });
    const data = await resp.json();
    let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
    return JSON.parse(text);
}

// --- ÂÖ∂‰ªñÊ†∏ÂøÉÈÇèËºØ ---
function updateMealUI() {
    const t = i18n[curLang].meals;
    const config = {
        "4": { sections: ['breakfast', 'lunch', 'dinner', 'snack'], titles: { breakfast: t.breakfast, lunch: t.lunch, dinner: t.dinner, snack: t.snack } },
        "3": { sections: ['breakfast', 'lunch', 'dinner'], titles: { breakfast: t.breakfast, lunch: t.lunch, dinner: t.dinner } },
        "2": { sections: ['lunch', 'dinner'], titles: { lunch: t.meal1, dinner: t.meal2 } },
        "1": { sections: ['dinner'], titles: { dinner: t.mealBig } }
    }[currentMealMode];

    const container = document.getElementById('meal-sections-container');
    container.innerHTML = '';
    const manualSelect = document.getElementById('manual-type');
    manualSelect.innerHTML = '';
    const modalBtns = document.getElementById('modal-meal-buttons');
    modalBtns.innerHTML = '';

    config.sections.forEach(type => {
        const section = document.createElement('div');
        section.className = 'meal-section';
        section.innerHTML = `<div class="meal-header"><div><span class="meal-title">${config.titles[type]}</span></div><div class="meal-progress" id="prog-${type}">0 kcal</div></div><ul class="meal-list" id="list-${type}"></ul>`;
        container.appendChild(section);

        const opt = document.createElement('option');
        opt.value = type; opt.text = config.titles[type];
        manualSelect.appendChild(opt);

        const btn = document.createElement('button');
        btn.className = `meal-btn ${type}`;
        btn.innerText = config.titles[type];
        btn.onclick = () => confirmAddFood(type);
        modalBtns.appendChild(btn);
    });
}

function calculateProfile(auto=false) {
    const h = parseFloat(document.getElementById('height').value);
    const w = parseFloat(document.getElementById('weight').value);
    const a = parseFloat(document.getElementById('age').value);
    const act = parseFloat(document.getElementById('activity').value);
    const g = document.getElementById('gender').value;
    const mode = document.getElementById('meal-mode').value;

    if (!h || !w || !a) { if(!auto) alert("Ë´ãÂ°´ÂØ´Ë≥áÊñô"); return; }

    let bmr = (g === 'male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161);
    let tdee = Math.round(bmr * act);
    targetCalories = Math.round(tdee - 500); 
    if(targetCalories < bmr) targetCalories = Math.round(bmr);
    
    currentMealMode = mode;
    document.getElementById('tdee-val').innerText = tdee;
    document.getElementById('target-cal-val').innerText = targetCalories;
    document.getElementById('target-cal-display').innerText = targetCalories;
    document.getElementById('water-val').innerText = Math.round(w * 35);
    document.getElementById('goal-result').style.display = 'block';

    saveProfile(); updateMealUI(); renderListAndStats(); 
}

function handleFileSelect(input) {
    const file = input.files[0]; if (!file) return;
    const preview = document.getElementById('image-preview');
    preview.src = URL.createObjectURL(file); preview.style.display = 'block';
    document.getElementById('analyze-btn').style.display = 'inline-block';
    document.getElementById('ai-desc-group').style.display = 'block';
    document.getElementById('ai-loading').style.display = 'none';
}

function startAnalysis() {
    const input = document.getElementById('image-upload');
    const file = input.files[0]; if (!file) { alert(i18n[curLang].alertSelImg); return; }
    const desc = document.getElementById('ai-desc').value.trim();

    document.getElementById('analyze-btn').style.display = 'none';
    document.getElementById('ai-loading').style.display = 'block';

    toBase64(file).then(base64 => {
        return callCloudflareAI(base64, desc);
    }).then(result => {
        if (result) {
            tempAIResult = {
                name: result.foodName,
                nutri: {
                    calories: Number(result.calories) || 0, protein: Number(result.protein) || 0, fat: Number(result.fat) || 0,
                    carbohydrate: Number(result.carbohydrate) || 0, sugar: Number(result.sugar) || 0, sodium: Number(result.sodium) || 0,
                    saturatedFat: Number(result.saturatedFat) || 0, transFat: Number(result.transFat) || 0
                }
            }; 
            showModal();
        }
    }).catch(e => {
        console.error(e); alert(i18n[curLang].alertAiFail + e.message);
        document.getElementById('analyze-btn').style.display = 'inline-block';
    }).finally(() => {
        document.getElementById('ai-loading').style.display = 'none';
    });
}

function changeDate() { selectedDate = document.getElementById('current-date').value; document.getElementById('display-date-text').innerText = selectedDate; loadFoodData(selectedDate); }
function saveFoodData() { localStorage.setItem(`record_${selectedDate}`, JSON.stringify(foodItems)); }
function loadFoodData(date) { const stored = localStorage.getItem(`record_${date}`); foodItems = stored ? JSON.parse(stored) : []; renderListAndStats(); }

function saveProfile() {
    const profile = { gender: document.getElementById('gender').value, age: document.getElementById('age').value, height: document.getElementById('height').value, weight: document.getElementById('weight').value, activity: document.getElementById('activity').value, mealMode: document.getElementById('meal-mode').value };
    localStorage.setItem('myProfile_v5', JSON.stringify(profile));
}
function loadProfile() {
    const stored = localStorage.getItem('myProfile_v5');
    if (stored) {
        const p = JSON.parse(stored);
        document.getElementById('gender').value = p.gender; document.getElementById('age').value = p.age; document.getElementById('height').value = p.height;
        document.getElementById('weight').value = p.weight; document.getElementById('activity').value = p.activity;
        if(p.mealMode) document.getElementById('meal-mode').value = p.mealMode;
        calculateProfile(true);
    } else { updateMealUI(); }
}

function renderListAndStats() {
    ['breakfast', 'lunch', 'dinner', 'snack'].forEach(type => { const el = document.getElementById(`list-${type}`); if(el) el.innerHTML = ''; });
    let total = { cal:0, pro:0, fat:0, carb:0, sugar:0, sod:0, sat:0, trans:0 };
    let mealTotals = { breakfast:0, lunch:0, dinner:0, snack:0 };

    foodItems.forEach((item, index) => {
        total.cal += (Number(item.nutri.calories) || 0); total.pro += (Number(item.nutri.protein) || 0);
        total.fat += (Number(item.nutri.fat) || 0); total.carb += (Number(item.nutri.carbohydrate) || 0);
        total.sugar += (Number(item.nutri.sugar) || 0); total.sod += (Number(item.nutri.sodium) || 0);
        total.sat += (Number(item.nutri.saturatedFat) || 0); total.trans += (Number(item.nutri.transFat) || 0);
        if(mealTotals[item.type] !== undefined) mealTotals[item.type] += (Number(item.nutri.calories) || 0);
        const li = document.createElement('li');
        li.innerHTML = `<div class="food-info"><div class="name">${item.name}</div><div class="detail">üî•${Math.round(item.nutri.calories)} | P:${item.nutri.protein} F:${item.nutri.fat} C:${item.nutri.carbohydrate}</div></div><button class="btn-delete" onclick="deleteItem(${index})">X</button>`;
        const listEl = document.getElementById(`list-${item.type}`); if(listEl) listEl.appendChild(li);
    });

    for(let type in mealTotals) {
        const el = document.getElementById(`prog-${type}`);
        if(el) el.innerText = `${Math.round(mealTotals[type])} kcal`;
    }

    document.getElementById('total-cal-display').innerText = Math.round(total.cal);
    
    // Êõ¥Êñ∞ÊâÄÊúâÁáüÈ§äÊåáÊ®ô (‰øÆÂæ©)
    document.getElementById('sum-protein').innerText = total.pro.toFixed(1);
    document.getElementById('sum-fat').innerText = total.fat.toFixed(1);
    document.getElementById('sum-carb').innerText = total.carb.toFixed(1);
    document.getElementById('sum-sugar').innerText = total.sugar.toFixed(1);
    document.getElementById('sum-sodium').innerText = Math.round(total.sod);
    document.getElementById('sum-sat-fat').innerText = total.sat.toFixed(1);
    document.getElementById('sum-trans-fat').innerText = total.trans.toFixed(1);
    
    // Ê∞¥ÂàÜ
    const weight = parseFloat(document.getElementById('weight').value) || 60;
    document.getElementById('water-val').innerText = Math.round(weight * 35);

    updateCharts(total);
    updatePetStateDisplay(); 
}

function deleteItem(index) { if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ôºü")) { foodItems.splice(index, 1); saveFoodData(); renderListAndStats(); } }
function toBase64(file) { return new Promise((r, j) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result.split(',')[1]); reader.onerror = j; }); }
