// --- å¤šåœ‹èªè¨€è¨­å®š (i18n) ---
const i18n = {
    "zh-TW": {
        dateLabel: "ğŸ“… ç´€éŒ„æ—¥æœŸï¼š", totalIntake: "ä»Šæ—¥æ”å–", goal: "ç›®æ¨™",
        pro: "è›‹ç™½è³ª", fat: "è„‚è‚ª", carb: "ç¢³æ°´", sugar: "ç³–", sod: "éˆ‰(mg)", sat: "é£½å’Œè„‚", trans: "åå¼è„‚", water: "ç›®æ¨™æ°´",
        chartTitle: "ğŸ“Š ç‡Ÿé¤Šèˆ‡ç†±é‡åˆ†æ", chartMacro: "ä»Šæ—¥ä¸‰å¤§ç‡Ÿé¤Šç´  (PFC)", chartWeekly: "æœ¬é€±ç†±é‡è¶¨å‹¢",
        aiTitle: "ğŸ“¸ AI é£²é£Ÿåˆ†æ", btnPhoto: "ğŸ“¸ 1. æ‹ç…§ / é¸æ“‡åœ–ç‰‡", btnAnalyze: "é€å‡ºåœ–ç‰‡åˆ†æ", aiLoading: "AI æ­£åœ¨åˆ†æé£Ÿç‰©ç‡Ÿé¤Šï¼Œè«‹ç¨å€™...",
        aiDescPlaceholder: "ğŸ“ è£œå……èªªæ˜ (ä¾‹å¦‚ï¼šé€™æ˜¯ä¸€ç¢—ç‰›è‚‰éºµï¼Œæ²’åŠ è”¥)...",
        recordTitle: "é£²é£Ÿç´€éŒ„", manualLabel: "æ‰‹å‹•è£œå…… (åƒ…ç†±é‡)", placeholderName: "é£Ÿç‰©åç¨±", placeholderCal: "å¡è·¯é‡Œ",
        btnAdd: "â• åŠ å…¥ç´€éŒ„", btnFavSave: "åŠ å…¥æœ€æ„›", btnFavLoad: "é¸æ“‡å¸¸åƒé£Ÿç‰©", btnFavAi: "åŠ å…¥æœ€æ„›",
        settingsTitle: "âš™ï¸ å€‹äººæ•¸æ“šè¨­å®š", gender: "æ€§åˆ¥", male: "ç”·", female: "å¥³", age: "å¹´é½¡", height: "èº«é«˜", weight: "é«”é‡",
        activity: "æ´»å‹•é‡", act1: "ä¹…å (è¾¦å…¬å®¤)", act2: "è¼•åº¦ (æ¯é€±é‹å‹•1-3å¤©)", act3: "ä¸­åº¦ (æ¯é€±é‹å‹•3-5å¤©)", act4: "é«˜åº¦ (æ¯é€±é‹å‹•6-7å¤©)",
        mealMode: "ğŸ½ï¸ æ¯æ—¥é¤æ•¸æ¨¡å¼", mode4: "æ¨™æº– (3é¤+é»å¿ƒ)", mode3: "3é¤ (ç„¡é»å¿ƒ)", mode2: "2é¤ (168æ–·é£Ÿ)", mode1: "1é¤ (OMAD)",
        btnCalc: "ğŸ”„ å„²å­˜ä¸¦æ›´æ–°ä»‹é¢", resTdee: "TDEE", resTarget: "æ¸›é‡ç›®æ¨™",
        modalTitle: "AI åˆ†æå ±å‘Š", modalAsk: "è«‹å•é€™æ˜¯å“ªä¸€é¤ï¼Ÿ", btnCancel: "å–æ¶ˆ",
        favTitle: "å¸¸åƒé£Ÿç‰©æ¸…å–®", btnClose: "é—œé–‰",
        menuImport: "åŒ¯å…¥é‚„åŸ", menuExport: "åŒ¯å‡ºå‚™ä»½", menuTheme: "åˆ‡æ›ä¸»é¡Œ", menuLang: "èªè¨€", menuCollection: "æ”¶è—ç³»çµ±", suggest: "å»ºè­°",
        langTitle: "èªè¨€", langCancel: "å–æ¶ˆ",
        meals: { breakfast: "ğŸ³ æ—©é¤", lunch: "ğŸ± åˆé¤", dinner: "ğŸ² æ™šé¤", snack: "ğŸª é»å¿ƒ", meal1: "ğŸ½ï¸ ç¬¬ä¸€é¤", meal2: "ğŸ½ï¸ ç¬¬äºŒé¤", mealBig: "ğŸ† å”¯ä¸€å¤§é¤" },
        alertDel: "ç¢ºå®šè¦åˆªé™¤ï¼Ÿ", alertFavAdded: "å·²åŠ å…¥æœ€æ„›ï¼", alertFavExist: "é€™å€‹é£Ÿç‰©å·²ç¶“åœ¨æœ€æ„›æ¸…å–®å›‰ï¼", alertSelImg: "è«‹å…ˆé¸æ“‡åœ–ç‰‡ï¼", alertAiFail: "AI åˆ†æå¤±æ•—ï¼š", alertFill: "è«‹å¡«å¯«è³‡æ–™", alertNameCal: "è«‹è¼¸å…¥åç¨±èˆ‡ç†±é‡", alertImportOk: "ğŸ‰ è³‡æ–™é‚„åŸæˆåŠŸï¼", alertImportFail: "âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤",
        msgNormal: "ä¸»äººï¼Œä»Šå¤©åƒä»€éº¼ï¼Ÿ", msgHappy: "å¤ªæ£’äº†ï¼æˆ‘è¦ºå¾—å……æ»¿æ´»åŠ›ï¼", msgFat: "å‘ƒ...æˆ‘å¥½åƒåƒå¤ªé£½äº†...", msgThirsty: "æ°´...æˆ‘è¦å–æ°´...", msgSad: "ä¸»äºº...åˆ¥å¿˜äº†ç…§é¡§æˆ‘..."
    },
    // ... (å…¶ä»–èªè¨€çœç•¥ä»¥ç¯€çœç¯‡å¹…ï¼Œä¿ç•™ä¹‹å‰çš„ç¿»è­¯å³å¯) ...
    "en": {
        dateLabel: "ğŸ“… Date:", totalIntake: "Total Intake", goal: "Goal",
        // ... (çœç•¥)
        msgNormal: "What are we eating today?", msgHappy: "I feel great!", msgFat: "Ugh... too much food...", msgThirsty: "Water... please...", msgSad: "Don't forget me..."
    }
};

let curLang = localStorage.getItem('appLang') || "zh-TW";
let curTheme = localStorage.getItem('appTheme') || "light";

// --- å…¨åŸŸè®Šæ•¸ ---
let foodItems = []; 
let targetCalories = 2000;
let tempAIResult = null;
let selectedDate = new Date().toISOString().split('T')[0];
let currentMealMode = "4";
let favoriteFoods = JSON.parse(localStorage.getItem('myFavorites') || "[]");

// --- ğŸ¶ å¯µç‰©ç³»çµ±è®Šæ•¸ ---
// GIF æª”æ¡ˆè·¯å¾‘è¨­å®š
const PET_DB = {
    dog: { 
        normal: 'dog_animation/dog_idle.gif', 
        happy: 'dog_animation/dog_happy.gif', 
        sad: 'dog_animation/dog_sad.gif', 
        fat: 'dog_animation/dog_fat.gif',
        eat: 'dog_animation/dog_eat.gif',
        walk: 'dog_animation/dog_walk.gif'
    }
    // æœªä¾†å¯ä»¥æ–°å¢ cat: { ... }
};

const UNLOCKS = [
    { id: 'scarf', name: 'é ˜å·¾', day: 3, type: 'acc', icon: 'ğŸ§£' },
    { id: 'glasses', name: 'å¢¨é¡', day: 7, type: 'acc', icon: 'ğŸ•¶ï¸' }
    // å¯ä»¥ç¹¼çºŒæ“´å……
];

let myPet = JSON.parse(localStorage.getItem('myPetProfile_v3') || "null");
let macroChart = null;
let weeklyChart = null;

// --- åˆå§‹åŒ– ---
document.addEventListener('DOMContentLoaded', () => {
    setTheme(curTheme);
    setLang(curLang);
    initPetSystem();
    document.getElementById('current-date').value = selectedDate;
    loadProfile();
    loadFoodData(selectedDate);
    initCharts();
    setupEventListeners();
});

// --- äº‹ä»¶ç¶å®š ---
function setupEventListeners() {
    document.getElementById('current-date').addEventListener('change', changeDate);
    document.getElementById('image-upload').addEventListener('change', function() { handleFileSelect(this); });
    document.getElementById('btn-take-photo').addEventListener('click', () => document.getElementById('image-upload').click());
    document.getElementById('analyze-btn').addEventListener('click', startAnalysis);
    
    document.getElementById('btn-add-record').addEventListener('click', addManualFood);
    document.getElementById('btn-fav-save-main').addEventListener('click', saveToFavorites);
    document.getElementById('btn-fav-load-main').addEventListener('click', openFavModal);
    
    document.getElementById('meal-mode').addEventListener('change', () => calculateProfile());
    document.getElementById('btn-calc').addEventListener('click', () => calculateProfile());
    
    document.getElementById('btn-ai-fav-save').addEventListener('click', saveAIResultToFavorites);
    document.getElementById('btn-cancel').addEventListener('click', () => closeModal('analysis-modal'));
    document.getElementById('btn-fav-close').addEventListener('click', () => closeModal('fav-modal'));
    
    document.getElementById('btn-toggle-theme').addEventListener('click', toggleTheme);
    document.getElementById('btn-open-lang').addEventListener('click', openLangModal);
    document.getElementById('btn-open-collection').addEventListener('click', openCollectionModal);
    document.getElementById('import-file').addEventListener('change', function() { importData(this); });
    document.getElementById('btn-export').addEventListener('click', exportData);
    document.getElementById('btn-fab-main').addEventListener('click', toggleFabMenu);
    document.getElementById('btn-lang-cancel').addEventListener('click', () => closeModal('lang-modal'));
    document.getElementById('btn-collection-close').addEventListener('click', () => closeModal('collection-modal'));
    document.getElementById('btn-pet-start').addEventListener('click', savePetProfile);

    document.querySelectorAll('.lang-option').forEach(opt => {
        opt.addEventListener('click', function() {
            setLang(this.getAttribute('data-lang'));
            closeModal('lang-modal');
        });
    });
}

// --- ğŸ¶ å¯µç‰©ç³»çµ±æ ¸å¿ƒ ---
function initPetSystem() {
    if (!myPet) {
        document.getElementById('pet-modal').style.display = 'flex';
    } else {
        // æª¢æŸ¥ç°½åˆ°
        const todayStr = new Date().toISOString().split('T')[0];
        if (myPet.lastLog !== todayStr) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (myPet.lastLog === yesterdayStr) {
                myPet.streak = (myPet.streak || 0) + 1;
            } else if (myPet.lastLog < yesterdayStr) {
                myPet.streak = 1; // æ–·ç°½
            } else {
                myPet.streak = 1; // é¦–æ¬¡
            }
            myPet.lastLog = todayStr;
            savePetData();
            checkUnlocks();
        }
        renderPet();
    }
}

function savePetProfile() {
    const name = document.getElementById('pet-name-input').value.trim();
    if (!name) { alert("è«‹å¹«ç‰ å–å€‹åå­—ï¼"); return; }
    myPet = { 
        type: 'dog', name: name, 
        level: 1, exp: 0, streak: 1, lastLog: new Date().toISOString().split('T')[0],
        unlocked: [], equipPet: 'dog', equipAcc: ''
    };
    savePetData();
    document.getElementById('pet-modal').style.display = 'none';
    renderPet();
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
}

function savePetData() {
    localStorage.setItem('myPetProfile_v3', JSON.stringify(myPet));
}

function checkUnlocks() {
    let newUnlock = false;
    UNLOCKS.forEach(item => {
        if (myPet.streak >= item.day && !myPet.unlocked.includes(item.id)) {
            myPet.unlocked.push(item.id);
            alert(`ğŸ‰ æ­å–œï¼é€£çºŒç´€éŒ„ ${item.day} å¤©ï¼Œè§£é–äº†ã€Œ${item.icon} ${item.name}ã€ï¼`);
            newUnlock = true;
        }
    });
    if(newUnlock) savePetData();
}

function renderPet() {
    if(!myPet) return;
    
    document.getElementById('pet-name-display').innerText = myPet.name;
    document.getElementById('pet-level').innerText = myPet.level;
    document.getElementById('streak-days').innerText = myPet.streak;
    
    // ç¶“é©—å€¼æ¢
    const maxExp = myPet.level * 100;
    const expPct = Math.min(100, (myPet.exp / maxExp) * 100);
    document.getElementById('exp-bar').style.width = `${expPct}%`;

    updatePetStateDisplay();
}

function updatePetStateDisplay() {
    const currentCal = parseFloat(document.getElementById('total-cal-display').innerText) || 0;
    const targetCal = parseFloat(document.getElementById('target-cal-display').innerText) || 2000;
    const ratio = currentCal / targetCal;
    
    const avatarEl = document.getElementById('pet-avatar');
    const msgEl = document.getElementById('pet-msg');
    
    // é è¨­èªè¨€åŒ…å…œåº•
    const t = i18n[curLang] || i18n['zh-TW'];
    
    let mood = 'normal';
    let msg = t.msgNormal;

    // æƒ…ç·’é‚è¼¯
    if (ratio > 1.1) {
        mood = 'fat'; msg = t.msgFat;
    } else if (ratio >= 0.8 && ratio <= 1.1) {
        mood = 'happy'; msg = t.msgHappy;
    } else if (ratio < 0.2) {
        mood = 'normal'; 
    }

    // åœ–ç‰‡è·¯å¾‘åˆ‡æ›
    // å¦‚æœæœ‰æ­£åœ¨é€²è¡Œçš„ç‰¹æ®Šå‹•ä½œ (ä¾‹å¦‚åƒé£¯)ï¼Œå‰‡ä¸è¦†è“‹
    if (!avatarEl.dataset.isBusy) {
        avatarEl.src = PET_DB['dog'][mood];
    }
    
    // é…ä»¶
    const accEl = document.getElementById('pet-accessory');
    accEl.innerText = myPet.equipAcc ? UNLOCKS.find(u=>u.id===myPet.equipAcc)?.icon || '' : '';

    msgEl.innerText = msg;
}

function petInteraction() {
    // é»æ“Šäº’å‹•ï¼šæ’­æ”¾é–‹å¿ƒå‹•ç•« 2 ç§’
    const avatarEl = document.getElementById('pet-avatar');
    const originalSrc = avatarEl.src;
    
    avatarEl.src = PET_DB['dog']['happy'];
    avatarEl.dataset.isBusy = true;
    
    // éš¨æ©Ÿå°è©±
    const msgs = ["æ±ªï¼", "â¤ï¸", "æˆ‘è¦åƒè‚‰è‚‰ï¼", "åŠ æ²¹ï¼"];
    document.getElementById('pet-msg').innerText = msgs[Math.floor(Math.random()*msgs.length)];

    setTimeout(() => {
        avatarEl.dataset.isBusy = false;
        updatePetStateDisplay(); // å›å¾©åŸæœ¬ç‹€æ…‹
    }, 2000);
}

function playEatAnimation() {
    // åƒé£¯å‹•ç•«ï¼šæ’­æ”¾ 3 ç§’
    const avatarEl = document.getElementById('pet-avatar');
    avatarEl.src = PET_DB['dog']['eat'];
    avatarEl.dataset.isBusy = true;
    setTimeout(() => {
        avatarEl.dataset.isBusy = false;
        updatePetStateDisplay();
    }, 3000);
}

function addExp(amount) {
    myPet.exp += amount;
    const maxExp = myPet.level * 100;
    if (myPet.exp >= maxExp) {
        myPet.level++;
        myPet.exp -= maxExp;
        alert(`ğŸ‰ ${myPet.name} å‡ç´šäº†ï¼è®Šæˆäº† Lv.${myPet.level}ï¼`);
        confetti({ particleCount: 150, spread: 60 });
    }
    savePetData();
    renderPet();
}

// --- æ”¶è—è¦–çª— ---
function openCollectionModal() {
    document.getElementById('streak-count-modal').innerText = myPet.streak;
    const grid = document.getElementById('collection-grid');
    grid.innerHTML = '';

    const defaults = [{ id: 'dog', name: 'ç‹—ç‹—', type: 'pet', icon: 'ğŸ¶' }];
    const allItems = [...defaults, ...UNLOCKS];

    allItems.forEach(item => {
        const isDefault = (item.id === 'dog');
        const isUnlocked = isDefault || myPet.unlocked.includes(item.id);
        const isActive = (item.type === 'pet' && myPet.equipPet === item.id) || (item.type === 'acc' && myPet.equipAcc === item.id);

        const div = document.createElement('div');
        div.className = `collection-item ${isUnlocked ? 'unlocked' : ''} ${isActive ? 'active' : ''}`;
        div.onclick = () => equipItem(item, isUnlocked);
        
        let hint = isUnlocked ? 'å·²æ“æœ‰' : `é€£çºŒ ${item.day} å¤©`;
        if (isDefault) hint = 'é è¨­';

        div.innerHTML = `
            <span class="collection-icon">${isUnlocked ? item.icon : 'ğŸ”’'}</span>
            <span class="collection-name">${item.name}</span>
            <span class="lock-hint">${hint}</span>
        `;
        grid.appendChild(div);
    });

    document.getElementById('collection-modal').style.display = 'flex';
    toggleFabMenu();
}

function equipItem(item, isUnlocked) {
    if (!isUnlocked) { alert(`é‚„æ²’è§£é–å–”ï¼éœ€è¦é€£çºŒç´€éŒ„ ${item.day} å¤©ã€‚`); return; }
    if (item.type === 'acc') {
        myPet.equipAcc = (myPet.equipAcc === item.id) ? '' : item.id;
    }
    savePetData();
    openCollectionModal();
    renderPet();
}

// --- æ ¸å¿ƒèˆ‡å·¥å…·å‡½å¼ ---
function toggleTheme() {
    const newTheme = curTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
}
function setTheme(theme) {
    curTheme = theme;
    localStorage.setItem('appTheme', theme);
    document.documentElement.setAttribute('data-theme', theme);
    updateChartTheme(theme);
}
function openLangModal() { document.getElementById('lang-modal').style.display = 'flex'; toggleFabMenu(); }
function setLang(lang) {
    curLang = lang;
    localStorage.setItem('appLang', lang);
    // ... (é€™è£¡çœç•¥äº†é‡è¤‡çš„ mapping ä»£ç¢¼ï¼Œè«‹ä½¿ç”¨å‰é¢çš„ mapping é‚è¼¯) ...
    const t = i18n[lang];
    document.getElementById('txt-date-label').innerText = t.dateLabel;
    // ... è«‹ç¢ºä¿é€™è£¡æœ‰å®Œæ•´çš„æ–‡å­—æ›´æ–°é‚è¼¯ ...
    updateMealUI();
    if(macroChart) { macroChart.data.labels = [t.pro, t.fat, t.carb]; macroChart.update(); }
}

function toggleFabMenu() { document.getElementById('fab-menu').classList.toggle('show'); }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function confirmAddFood(type) { 
    foodItems.push({ type: type, name: tempAIResult.name, nutri: tempAIResult.nutri }); 
    saveFoodData(); 
    renderListAndStats(); 
    closeModal('analysis-modal');
    addExp(20); 
    playEatAnimation(); // æ’­æ”¾åƒé£¯å‹•ç•«
}

function addManualFood() {
    const name = document.getElementById('manual-name').value; const cal = parseFloat(document.getElementById('manual-cal').value); const type = document.getElementById('manual-type').value;
    if (name && cal) {
        foodItems.push({ type: type, name: name, nutri: { calories: cal, protein:0, fat:0, carbohydrate:0, sugar:0, sodium:0, saturatedFat:0, transFat:0 } });
        saveFoodData(); renderListAndStats();
        document.getElementById('manual-name').value = ''; document.getElementById('manual-cal').value = '';
        addExp(10);
        playEatAnimation(); // æ’­æ”¾åƒé£¯å‹•ç•«
    } else { alert(i18n[curLang].alertNameCal); }
}

// --- PWA èˆ‡æª”æ¡ˆè™•ç† ---
function exportData() {
    const data = {};
    for(let i=0; i<localStorage.length; i++) {
        const key = localStorage.key(i);
        if(key.startsWith('record_') || key.startsWith('myProfile') || key === 'myFavorites' || key.startsWith('myPetProfile')) {
            data[key] = localStorage.getItem(key);
        }
    }
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `nutrition_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); toggleFabMenu();
}
function importData(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            for(let key in data) localStorage.setItem(key, data[key]);
            alert(i18n[curLang].alertImportOk); location.reload();
        } catch(err) { alert(i18n[curLang].alertImportFail); }
    }; reader.readAsText(file); toggleFabMenu();
}

// --- AI å‘¼å« ---
async function callCloudflareAI(base64, userDesc) {
    const url = "https://nameless-meadow-cf7b.jtwen12345us.workers.dev/";
    const prompt = `Analyze food image. Return JSON: foodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFat. ${userDesc ? 'Note: '+userDesc : ''}`;
    
    const resp = await fetch(url, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } } ] }] })
    });
    const data = await resp.json();
    let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
    return JSON.parse(text);
}

// --- å…¶ä»–æ ¸å¿ƒé‚è¼¯ (è¨ˆç®—ã€åœ–è¡¨ç­‰) ---
// ... (ä¿ç•™ä¸Šä¸€ç‰ˆ script.js ä¸­çš„ initCharts, updateCharts, loadProfile, calculateProfile, renderListAndStats, changeDate, saveFoodData, loadFoodData, deleteItem, toBase64 ç­‰å‡½å¼) ...
// ç‚ºäº†ç‰ˆé¢ç°¡æ½”ï¼Œé€™äº›é‚è¼¯å®Œå…¨ä¸ç”¨è®Šï¼Œè«‹ç›´æ¥å¾ä¸Šä¸€ç‰ˆè¤‡è£½éä¾†æ”¾åœ¨ä¸‹é¢ã€‚
