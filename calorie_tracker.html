<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚å¯µç‰©ç‡Ÿé¤Šç®¡å®¶</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <link rel="apple-touch-icon" href="calorie_icon.png">
    <link rel="icon" type="image/png" href="calorie_icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('App æº–å‚™å°±ç·’'))
                .catch((error) => console.log('App è¨»å†Šå¤±æ•—:', error));
        }
    </script>

    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ (CSS è®Šæ•¸ç³»çµ±) --- */
        :root {
            --primary-color: #2ecc71; 
            --primary-dark: #27ae60;
            --accent-color: #6c5ce7;  
            --bg-color: #f0f2f5;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --meal-header-bg: #f1f8e9;
            --input-bg: #ffffff;
            --input-border: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.05);
            --modal-bg: #ffffff;
            --lang-modal-bg: #ffffff;
            --lang-text: #2c3e50;
            --lang-opt-bg: #f8f9fa;
            --lang-opt-border: #e0e0e0;
            --lang-cancel-color: #666;
        }

        [data-theme="dark"] {
            --primary-color: #2ecc71; 
            --primary-dark: #27ae60; 
            --accent-color: #a29bfe;  
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --meal-header-bg: #2d3436;
            --input-bg: #2d2d2d;
            --input-border: #444444;
            --shadow-color: rgba(0,0,0,0.5);
            --modal-bg: #2d2d2d;
            --lang-modal-bg: #2d3436;
            --lang-text: #ffffff;
            --lang-opt-bg: rgba(255,255,255,0.1);
            --lang-opt-border: rgba(255,255,255,0.2);
            --lang-cancel-color: #aaa;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
            display: flex;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { max-width: 800px; width: 100%; display: grid; gap: 20px; }

        /* --- ğŸ¶ é›»å­é›å¯µç‰©å€ (æ ¸å¿ƒæ–°åŠŸèƒ½) --- */
        .pet-room-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            padding: 20px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        .pet-stats-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 20px;
            font-size: 0.9em; margin-bottom: 15px; backdrop-filter: blur(5px);
        }

        .pet-stage {
            height: 180px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; position: relative;
        }

        .pet-avatar {
            font-size: 80px; cursor: pointer; transition: all 0.3s ease;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
            position: relative; z-index: 2;
        }

        /* å¯µç‰©é£¾å“ */
        .pet-accessory {
            position: absolute; font-size: 40px; top: -10px; right: -10px; z-index: 3;
            animation: float 3s ease-in-out infinite; pointer-events: none;
        }

        /* å¯µç‰©å‹•ç•«ç‹€æ…‹ */
        .pet-anim-breathe { animation: breathe 3s ease-in-out infinite; }
        .pet-anim-happy { animation: bounce 0.6s infinite alternate; }
        .pet-anim-fat { transform: scaleX(1.5) scaleY(0.8); transition: transform 0.5s; }
        .pet-anim-sick { filter: grayscale(1) blur(1px); opacity: 0.8; animation: shake 2s infinite; }
        .pet-anim-eating { animation: chew 0.3s infinite; }

        .pet-speech-bubble {
            background: white; color: #333; padding: 8px 15px; border-radius: 15px;
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            font-size: 14px; font-weight: bold; opacity: 0; transition: opacity 0.3s;
            white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 5;
        }
        .pet-speech-bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            border-width: 6px 6px 0; border-style: solid; border-color: white transparent transparent transparent;
        }
        .pet-stage:hover .pet-speech-bubble { opacity: 1; top: 0px; }

        /* ç¶“é©—å€¼æ¢ */
        .exp-container {
            width: 80%; height: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;
            margin: 10px auto 0; overflow: hidden; position: relative;
        }
        .exp-bar {
            height: 100%; background: #f1c40f; width: 0%; transition: width 0.5s ease;
        }
        
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-15px); } }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        @keyframes chew { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.9, 1.1); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- ä¸€èˆ¬å¡ç‰‡èˆ‡ä»‹é¢ --- */
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 12px var(--shadow-color); transition: background-color 0.3s;
        }
        
        .dashboard-header {
            /* éš±è—èˆŠç‰ˆå„€è¡¨æ¿çš„å¤§ç¶ è‰²å¡Šï¼Œæ”¹ç”¨ç°¡ç´„é¢¨æ ¼èå…¥å¯µç‰©ä¸‹æ–¹ */
            display: none; 
        }
        
        /* æ–°ç‰ˆè¿·ä½ å„€è¡¨æ¿ */
        .mini-dashboard {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px;
        }
        .nutri-box {
            background: var(--input-bg); border: 1px solid var(--input-border);
            padding: 8px 4px; border-radius: 8px; text-align: center;
        }
        .nutri-box .n-val { display: block; font-weight: bold; font-size: 1.1em; color: var(--text-color); }
        .nutri-box .n-label { font-size: 0.75em; color: var(--text-color); opacity: 0.7; }

        /* --- å…¶ä»–æ—¢æœ‰æ¨£å¼ --- */
        .date-control { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; color: var(--text-color); }
        .date-control input { width: auto; padding: 8px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); border-radius: 8px; }
        
        .meal-section { border: 1px solid var(--input-border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
        .meal-header { background-color: var(--meal-header-bg); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--input-border); }
        .meal-list li { padding: 12px 15px; border-bottom: 1px solid var(--input-border); display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); }
        .food-info .name { font-weight: bold; } .food-info .detail { font-size: 0.8em; color: #888; margin-top: 2px; }
        
        .form-group { margin-bottom: 15px; } label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        
        button { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button.btn-ai { background: linear-gradient(135deg, #6c5ce7 0%, #5b4cc4 100%); }
        button.btn-analyze { background: linear-gradient(135deg, #ff7675 0%, #d63031 100%); margin-top: 15px; display: none; }
        button.btn-delete { width: auto; padding: 4px 10px; background-color: #ff7675; font-size: 12px; border-radius: 6px; margin-left: 10px; }
        
        .fav-controls { display: flex; gap: 8px; margin-top: 8px; }
        .btn-fav-save { background-color: #ff7675; width: auto; padding: 10px; flex:1; font-size: 14px; }
        .btn-fav-load { background-color: #0984e3; width: auto; padding: 10px; flex:1; font-size: 14px; }
        .fav-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--input-border); }
        .fav-item-name { font-weight: bold; cursor: pointer; flex-grow: 1; color: var(--text-color); }

        .chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 600px) { .chart-grid { grid-template-columns: 1fr 1fr; } }
        .chart-title { text-align:center; font-size:0.9em; color: #888; }
        [data-theme="dark"] .chart-title { color: #bbb; }

        /* --- å½ˆè·³è¦–çª— --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal { background: var(--modal-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; text-align: center; color: var(--text-color); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* æ”¶è—ç³»çµ±è¦–çª— */
        .collection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .collection-item { border: 2px solid var(--input-border); border-radius: 10px; padding: 10px; cursor: pointer; opacity: 0.5; filter: grayscale(1); transition: all 0.3s; }
        .collection-item.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--primary-color); background: rgba(46, 204, 113, 0.1); }
        .collection-item.active { border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); }
        .collection-icon { font-size: 30px; display: block; margin-bottom: 5px; }
        .collection-name { font-size: 12px; display: block; }
        .lock-hint { font-size: 10px; color: #888; margin-top: 2px; }

        /* èªè¨€è¦–çª— */
        .lang-modal-box { background: var(--lang-modal-bg); width: 85%; max-width: 350px; border-radius: 12px; padding: 20px; text-align: center; color: var(--lang-text); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .lang-list { display: flex; flex-direction: column; gap: 10px; }
        .lang-option { background: var(--lang-opt-bg); border: 1px solid var(--lang-opt-border); padding: 15px; border-radius: 8px; font-size: 16px; cursor: pointer; text-align: left; color: var(--lang-text); }
        .lang-cancel-btn { background: transparent; border: 1px solid var(--lang-opt-border); margin-top: 20px; width: 100%; padding: 12px; color: var(--lang-cancel-color); border-radius: 8px; cursor: pointer; }

        /* å¯µç‰©é¸æ“‡æ¨£å¼ */
        .pet-choice-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .pet-option { border: 2px solid var(--input-border); border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.2s; font-size: 40px; }
        .pet-option.selected { border-color: var(--primary-color); background-color: rgba(46, 204, 113, 0.1); transform: scale(1.05); }

        /* æ‡¸æµ®é¸å–® */
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 999; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 10px; }
        .fab-main { width: 56px; height: 56px; background-color: var(--text-color); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--card-bg); font-size: 24px; transition: transform 0.3s; }
        .fab-menu { display: none; flex-direction: column; gap: 10px; align-items: flex-end; }
        .fab-menu.show { display: flex; }
        .fab-item { background-color: var(--card-bg); color: var(--text-color); padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 14px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; border: 1px solid var(--input-border); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="pet-room-card">
        <div class="pet-stats-bar">
            <span>ğŸ… Lv.<span id="pet-level">1</span> <span id="pet-name-display">å¯µç‰©</span></span>
            <span>ğŸ”¥ é€£çºŒ <span id="streak-days">0</span> å¤©</span>
        </div>
        
        <div class="pet-stage" onclick="petInteraction()">
            <div class="pet-speech-bubble" id="pet-msg">ä¸»äººï¼Œä»Šå¤©åƒä»€éº¼ï¼Ÿ</div>
            <div class="pet-avatar pet-anim-breathe" id="pet-avatar">ğŸ¶</div>
            <div class="pet-accessory" id="pet-accessory"></div> </div>

        <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">
            ä»Šæ—¥æ”å–: <span id="total-cal-display">0</span> / <span id="target-cal-display">--</span> kcal
        </div>
        
        <div class="exp-container">
            <div class="exp-bar" id="exp-bar"></div>
        </div>
    </div>

    <div class="mini-dashboard">
        <div class="nutri-box"><span class="n-val" id="sum-protein">0</span><span class="n-label" id="lbl-pro">è›‹ç™½è³ª</span></div>
        <div class="nutri-box"><span class="n-val" id="sum-fat">0</span><span class="n-label" id="lbl-fat">è„‚è‚ª</span></div>
        <div class="nutri-box"><span class="n-val" id="sum-carb">0</span><span class="n-label" id="lbl-carb">ç¢³æ°´</span></div>
        <div class="nutri-box"><span class="n-val" id="water-val">--</span><span class="n-label" id="lbl-water">ç›®æ¨™æ°´</span></div>
    </div>

    <div class="date-control">
        <label id="txt-date-label">ğŸ“… ç´€éŒ„æ—¥æœŸï¼š</label>
        <input type="date" id="current-date" onchange="changeDate()">
    </div>

    <div class="card">
        <h3 id="txt-chart-title">ğŸ“Š ç‡Ÿé¤Šèˆ‡ç†±é‡åˆ†æ</h3>
        <div class="chart-grid">
            <div>
                <h4 class="chart-title" id="txt-chart-macro">ä»Šæ—¥ä¸‰å¤§ç‡Ÿé¤Šç´  (PFC)</h4>
                <div class="chart-container"><canvas id="macroChart"></canvas></div>
            </div>
            <div>
                <h4 class="chart-title" id="txt-chart-weekly">æœ¬é€±ç†±é‡è¶¨å‹¢</h4>
                <div class="chart-container"><canvas id="weeklyChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 style="color: var(--accent-color);" id="txt-ai-title">ğŸ“¸ AI é£²é£Ÿåˆ†æ</h2>
        <div style="text-align: center;">
            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleFileSelect(this)">
            <button class="btn-ai" onclick="document.getElementById('image-upload').click()" id="btn-take-photo">ğŸ“¸ 1. æ‹ç…§ / é¸æ“‡åœ–ç‰‡</button>
            <div id="ai-desc-group" style="display:none; margin-top: 15px;">
                <textarea id="ai-desc" rows="2" style="width:100%;" placeholder=""></textarea>
            </div>
            <button id="analyze-btn" class="btn-analyze" onclick="startAnalysis()">âœ¨ 2. <span id="txt-analyze-btn">é€å‡ºåœ–ç‰‡åˆ†æ</span></button>
        </div>
        <div class="loading-spinner" id="ai-loading">ğŸ¤– <span id="txt-ai-loading">AI æ­£åœ¨åˆ†æ...</span></div>
        <img id="image-preview">
    </div>

    <div class="card">
        <h3>ğŸ½ï¸ <span id="display-date-text">ä»Šæ—¥</span> <span id="txt-record-title">é£²é£Ÿç´€éŒ„</span></h3>
        <div id="meal-sections-container"></div> <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd;">
            <label id="txt-manual-label">æ‰‹å‹•è£œå…… (åƒ…ç†±é‡)</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="manual-name" placeholder="é£Ÿç‰©åç¨±">
                <input type="number" id="manual-cal" placeholder="å¡è·¯é‡Œ">
            </div>
            <select id="manual-type" style="margin-bottom: 10px;"></select>
            <button onclick="addManualFood()" style="background-color: #95a5a6;" id="btn-add-record">â• åŠ å…¥ç´€éŒ„</button>
            <div class="fav-controls">
                <button class="btn-fav-save" onclick="saveToFavorites()">â¤ï¸ <span id="btn-fav-save">åŠ å…¥æœ€æ„›</span></button>
                <button class="btn-fav-load" onclick="openFavModal()">ğŸ“‚ <span id="btn-fav-load">é¸æ“‡å¸¸åƒé£Ÿç‰©</span></button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 id="txt-settings-title">âš™ï¸ å€‹äººæ•¸æ“šè¨­å®š</h3>
        <div class="form-group">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label id="lbl-gender">æ€§åˆ¥</label><select id="gender"><option value="male" id="opt-male">ç”·</option><option value="female" id="opt-female">å¥³</option></select></div>
                <div><label id="lbl-age">å¹´é½¡</label><input type="number" id="age" placeholder="25"></div>
                <div><label id="lbl-height">èº«é«˜</label><input type="number" id="height" placeholder="170"></div>
                <div><label id="lbl-weight">é«”é‡</label><input type="number" id="weight" placeholder="60"></div>
            </div>
            <label style="margin-top: 10px;" id="lbl-activity">æ´»å‹•é‡</label>
            <select id="activity">
                <option value="1.2" id="opt-act-1">ä¹…å</option><option value="1.375" id="opt-act-2">è¼•åº¦</option>
                <option value="1.55" id="opt-act-3">ä¸­åº¦</option><option value="1.725" id="opt-act-4">é«˜åº¦</option>
            </select>
            <label style="margin-top: 10px; color: var(--accent-color);" id="lbl-meal-mode">ğŸ½ï¸ æ¯æ—¥é¤æ•¸æ¨¡å¼</label>
            <select id="meal-mode" onchange="calculateProfile()">
                <option value="4" selected id="opt-mode-4">æ¨™æº–</option><option value="3" id="opt-mode-3">3é¤</option>
                <option value="2" id="opt-mode-2">2é¤</option><option value="1" id="opt-mode-1">1é¤</option>
            </select>
            <button onclick="calculateProfile()" style="margin-top: 15px;" id="btn-calc">ğŸ”„ å„²å­˜ä¸¦æ›´æ–°ä»‹é¢</button>
        </div>
        <div id="goal-result" class="goal-section">
            <span id="txt-res-tdee">TDEE</span>ï¼š<span id="tdee-val">0</span> kcal | <span id="txt-res-target">æ¸›é‡ç›®æ¨™</span>ï¼š<span id="target-cal-val">0</span> kcal
        </div>
    </div>
</div>

<div class="modal-overlay" id="collection-modal" style="display:none;">
    <div class="modal">
        <h3>ğŸ† å¯µç‰©èˆ‡é…ä»¶æ”¶è—</h3>
        <p>ç›®å‰é€£çºŒç°½åˆ°ï¼š<span style="color:var(--primary-color); font-weight:bold; font-size:1.2em;" id="streak-count-modal">0</span> å¤©</p>
        <div class="collection-grid" id="collection-grid">
            </div>
        <button onclick="closeModal('collection-modal')" style="margin-top: 15px; background: #95a5a6;">é—œé–‰</button>
    </div>
</div>

<div class="modal-overlay" id="pet-modal" style="display:none; z-index:2000;">
    <div class="modal">
        <h3>âœ¨ æ­¡è¿ä¾†åˆ°å¿«æ¨‚å¯µç‰©ï¼</h3>
        <p>è«‹é¸æ“‡æ‚¨çš„ç¬¬ä¸€éš»å¤¥ä¼´ä¸¦ç‚ºç‰ å‘½åï¼š</p>
        <div class="pet-choice-container">
            <div class="pet-option selected" id="opt-dog" onclick="selectPetType('dog')">ğŸ¶ <span class="pet-label">ç‹—ç‹—</span></div>
            <div class="pet-option" id="opt-cat" onclick="selectPetType('cat')">ğŸ± <span class="pet-label">è²“è²“</span></div>
        </div>
        <div style="margin-top: 20px;">
            <input type="text" id="pet-name-input" placeholder="ä¾‹å¦‚ï¼šçš®çš®" style="font-size: 18px; text-align: center;">
        </div>
        <button onclick="savePetProfile()" style="margin-top: 20px;">ğŸš€ é–‹å§‹æ—…ç¨‹</button>
    </div>
</div>

<div class="modal-overlay" id="analysis-modal">
    <div class="modal">
        <h3>âœ¨ <span id="txt-modal-title">AI åˆ†æå ±å‘Š</span></h3>
        <div class="analysis-result" id="analysis-content"></div>
        <button onclick="saveAIResultToFavorites()" class="btn-fav-save" style="margin-bottom: 15px; width: 100%;">â¤ï¸ <span id="btn-fav-ai">åŠ å…¥æœ€æ„›</span></button>
        <p id="txt-modal-ask">è«‹å•é€™æ˜¯å“ªä¸€é¤ï¼Ÿ</p>
        <div class="meal-selector" id="modal-meal-buttons"></div>
        <button onclick="closeModal('analysis-modal')" style="margin-top: 15px; background: #95a5a6;" id="btn-cancel">å–æ¶ˆ</button>
    </div>
</div>

<div class="modal-overlay" id="fav-modal">
    <div class="modal">
        <h3>â¤ï¸ <span id="txt-fav-title">å¸¸åƒé£Ÿç‰©æ¸…å–®</span></h3>
        <div style="max-height: 300px; overflow-y: auto; text-align: left;" id="fav-list-container"></div>
        <button onclick="closeModal('fav-modal')" style="margin-top: 15px; background: #95a5a6;" id="btn-fav-close">é—œé–‰</button>
    </div>
</div>

<div class="modal-overlay" id="lang-modal" style="display:none;">
    <div class="lang-modal-box">
        <div class="lang-modal-title" id="txt-lang-title">èªè¨€</div>
        <div class="lang-list">
            <div class="lang-option" onclick="setLang('zh-TW'); closeModal('lang-modal')">ç¹é«”ä¸­æ–‡</div>
            <div class="lang-option" onclick="setLang('zh-CN'); closeModal('lang-modal')">ç®€ä½“ä¸­æ–‡</div>
            <div class="lang-option" onclick="setLang('en'); closeModal('lang-modal')">English</div>
            <div class="lang-option" onclick="setLang('ja'); closeModal('lang-modal')">æ—¥æœ¬èª</div>
        </div>
        <button class="lang-cancel-btn" onclick="closeModal('lang-modal')" id="btn-lang-cancel">å–æ¶ˆ</button>
    </div>
</div>

<div class="fab-container">
    <div class="fab-menu" id="fab-menu">
        <div class="fab-item" onclick="openCollectionModal()">ğŸ† <span id="menu-collection">æ”¶è—ç³»çµ±</span></div>
        <div class="fab-item" onclick="toggleTheme()">ğŸŒ“ <span id="menu-theme">æ·±è‰²æ¨¡å¼</span></div>
        <div class="fab-item" onclick="openLangModal()">ğŸŒ <span id="menu-lang">èªè¨€</span></div>
        <label class="fab-item" onclick="triggerImport()">ğŸ“¥ <span id="menu-import">åŒ¯å…¥é‚„åŸ</span><input type="file" id="import-file" style="display:none" onchange="importData(this)" accept=".json"></label>
        <div class="fab-item" onclick="exportData()">ğŸ“¤ <span id="menu-export">åŒ¯å‡ºå‚™ä»½</span></div>
    </div>
    <div class="fab-main" onclick="toggleFabMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </div>
</div>

<script>
    // --- éŠæˆ²è³‡æ–™åº«èˆ‡è¨­å®š ---
    const PET_DB = {
        dog: { normal: 'ğŸ¶', happy: 'ğŸ¶', sad: 'ğŸ¤•', fat: 'ğŸŒ­' },
        cat: { normal: 'ğŸ±', happy: 'ğŸ±', sad: 'ğŸ™€', fat: 'ğŸ' },
        shiba: { normal: 'ğŸ•', happy: 'ğŸ•', sad: 'ğŸ¥€', fat: 'ğŸŒ­' },
        corgi: { normal: 'ğŸ¥”', happy: 'ğŸ¥”', sad: 'ğŸ¤•', fat: 'ğŸ' }
    };
    
    const UNLOCKS = [
        { id: 'scarf', name: 'é ˜å·¾', day: 3, type: 'acc', icon: 'ğŸ§£' },
        { id: 'shiba', name: 'æŸ´çŠ¬', day: 7, type: 'pet', icon: 'ğŸ•' },
        { id: 'corgi', name: 'æŸ¯åŸº', day: 14, type: 'pet', icon: 'ğŸ¥”' }, // æŸ¯åŸºæš«ç”¨é¦¬éˆ´è–¯ä»£æ›¿
        { id: 'glasses', name: 'å¢¨é¡', day: 30, type: 'acc', icon: 'ğŸ•¶ï¸' }
    ];

    let myPet = JSON.parse(localStorage.getItem('myPetProfile_v2') || "null");
    // é è¨­å¯µç‰©ç‹€æ…‹çµæ§‹: { type:'dog', name:'çš®çš®', level:1, exp:0, streak:0, lastLog:'', unlocked:[], equipPet:'dog', equipAcc:'' }
    
    // --- å¤šåœ‹èªè¨€è¨­å®š ---
    const i18n = {
        "zh-TW": {
            dateLabel: "ğŸ“… ç´€éŒ„æ—¥æœŸï¼š", totalIntake: "ä»Šæ—¥æ”å–", goal: "ç›®æ¨™",
            pro: "è›‹ç™½è³ª", fat: "è„‚è‚ª", carb: "ç¢³æ°´", sugar: "ç³–", sod: "éˆ‰(mg)", sat: "é£½å’Œè„‚", trans: "åå¼è„‚", water: "ç›®æ¨™æ°´",
            chartTitle: "ğŸ“Š ç‡Ÿé¤Šèˆ‡ç†±é‡åˆ†æ", chartMacro: "ä»Šæ—¥ä¸‰å¤§ç‡Ÿé¤Šç´  (PFC)", chartWeekly: "æœ¬é€±ç†±é‡è¶¨å‹¢",
            aiTitle: "ğŸ“¸ AI é£²é£Ÿåˆ†æ", btnPhoto: "ğŸ“¸ 1. æ‹ç…§ / é¸æ“‡åœ–ç‰‡", btnAnalyze: "é€å‡ºåœ–ç‰‡åˆ†æ", aiLoading: "AI æ­£åœ¨åˆ†æé£Ÿç‰©ç‡Ÿé¤Šï¼Œè«‹ç¨å€™...",
            aiDescPlaceholder: "ğŸ“ è£œå……èªªæ˜ (ä¾‹å¦‚ï¼šé€™æ˜¯ä¸€ç¢—ç‰›è‚‰éºµï¼Œæ²’åŠ è”¥)...",
            recordTitle: "é£²é£Ÿç´€éŒ„", manualLabel: "æ‰‹å‹•è£œå…… (åƒ…ç†±é‡)", placeholderName: "é£Ÿç‰©åç¨±", placeholderCal: "å¡è·¯é‡Œ",
            btnAdd: "â• åŠ å…¥ç´€éŒ„", btnFavSave: "åŠ å…¥æœ€æ„›", btnFavLoad: "é¸æ“‡å¸¸åƒé£Ÿç‰©", btnFavAi: "åŠ å…¥æœ€æ„›",
            settingsTitle: "âš™ï¸ å€‹äººæ•¸æ“šè¨­å®š", gender: "æ€§åˆ¥", male: "ç”·", female: "å¥³", age: "å¹´é½¡", height: "èº«é«˜", weight: "é«”é‡",
            activity: "æ´»å‹•é‡", act1: "ä¹…å (è¾¦å…¬å®¤)", act2: "è¼•åº¦ (æ¯é€±é‹å‹•1-3å¤©)", act3: "ä¸­åº¦ (æ¯é€±é‹å‹•3-5å¤©)", act4: "é«˜åº¦ (æ¯é€±é‹å‹•6-7å¤©)",
            mealMode: "ğŸ½ï¸ æ¯æ—¥é¤æ•¸æ¨¡å¼", mode4: "æ¨™æº– (3é¤+é»å¿ƒ)", mode3: "3é¤ (ç„¡é»å¿ƒ)", mode2: "2é¤ (168æ–·é£Ÿ)", mode1: "1é¤ (OMAD)",
            btnCalc: "ğŸ”„ å„²å­˜ä¸¦æ›´æ–°ä»‹é¢", resTdee: "TDEE", resTarget: "æ¸›é‡ç›®æ¨™",
            modalTitle: "AI åˆ†æå ±å‘Š", modalAsk: "è«‹å•é€™æ˜¯å“ªä¸€é¤ï¼Ÿ", btnCancel: "å–æ¶ˆ",
            favTitle: "å¸¸åƒé£Ÿç‰©æ¸…å–®", btnClose: "é—œé–‰",
            menuImport: "åŒ¯å…¥é‚„åŸ", menuExport: "åŒ¯å‡ºå‚™ä»½", menuTheme: "åˆ‡æ›ä¸»é¡Œ", menuLang: "èªè¨€", menuCollection: "æ”¶è—ç³»çµ±", suggest: "å»ºè­°",
            langTitle: "èªè¨€", langCancel: "å–æ¶ˆ",
            meals: { breakfast: "ğŸ³ æ—©é¤", lunch: "ğŸ± åˆé¤", dinner: "ğŸ² æ™šé¤", snack: "ğŸª é»å¿ƒ", meal1: "ğŸ½ï¸ ç¬¬ä¸€é¤", meal2: "ğŸ½ï¸ ç¬¬äºŒé¤", mealBig: "ğŸ† å”¯ä¸€å¤§é¤" },
            alertDel: "ç¢ºå®šè¦åˆªé™¤ï¼Ÿ", alertFavAdded: "å·²åŠ å…¥æœ€æ„›ï¼", alertFavExist: "é€™å€‹é£Ÿç‰©å·²ç¶“åœ¨æœ€æ„›æ¸…å–®å›‰ï¼", alertSelImg: "è«‹å…ˆé¸æ“‡åœ–ç‰‡ï¼", alertAiFail: "AI åˆ†æå¤±æ•—ï¼š", alertFill: "è«‹å¡«å¯«è³‡æ–™", alertNameCal: "è«‹è¼¸å…¥åç¨±èˆ‡ç†±é‡", alertImportOk: "ğŸ‰ è³‡æ–™é‚„åŸæˆåŠŸï¼", alertImportFail: "âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤",
            msgNormal: "ä¸»äººï¼Œä»Šå¤©åƒä»€éº¼ï¼Ÿ", msgHappy: "å¤ªæ£’äº†ï¼æˆ‘è¦ºå¾—å……æ»¿æ´»åŠ›ï¼", msgFat: "å‘ƒ...æˆ‘å¥½åƒåƒå¤ªé£½äº†...", msgThirsty: "æ°´...æˆ‘è¦å–æ°´...", msgSad: "ä¸»äºº...åˆ¥å¿˜äº†ç…§é¡§æˆ‘..."
        },
        "zh-CN": {
            dateLabel: "ğŸ“… è®°å½•æ—¥æœŸï¼š", totalIntake: "ä»Šæ—¥æ‘„å–", goal: "ç›®æ ‡",
            pro: "è›‹ç™½è´¨", fat: "è„‚è‚ª", carb: "ç¢³æ°´", sugar: "ç³–", sod: "é’ (mg)", sat: "é¥±å’Œè„‚", trans: "åå¼è„‚", water: "ç›®æ ‡æ°´",
            chartTitle: "ğŸ“Š è¥å…»ä¸çƒ­é‡åˆ†æ", chartMacro: "ä»Šæ—¥ä¸‰å¤§è¥å…»ç´  (PFC)", chartWeekly: "æœ¬å‘¨çƒ­é‡è¶‹åŠ¿",
            aiTitle: "ğŸ“¸ AI é¥®é£Ÿåˆ†æ", btnPhoto: "ğŸ“¸ 1. æ‹ç…§ / é€‰æ‹©å›¾ç‰‡", btnAnalyze: "å‘é€å›¾ç‰‡åˆ†æ", aiLoading: "AI æ­£åœ¨åˆ†æé£Ÿç‰©è¥å…»ï¼Œè¯·ç¨å€™...",
            aiDescPlaceholder: "ğŸ“ è¡¥å……è¯´æ˜ (ä¾‹å¦‚ï¼šè¿™æ˜¯ä¸€ç¢—ç‰›è‚‰é¢ï¼Œæ²¡åŠ è‘±)...",
            recordTitle: "é¥®é£Ÿè®°å½•", manualLabel: "æ‰‹åŠ¨è¡¥å…… (ä»…çƒ­é‡)", placeholderName: "é£Ÿç‰©åç§°", placeholderCal: "å¡è·¯é‡Œ",
            btnAdd: "â• åŠ å…¥è®°å½•", btnFavSave: "åŠ å…¥æ”¶è—", btnFavLoad: "é€‰æ‹©å¸¸åƒé£Ÿç‰©", btnFavAi: "åŠ å…¥æ”¶è—",
            settingsTitle: "âš™ï¸ ä¸ªäººæ•°æ®è®¾å®š", gender: "æ€§åˆ«", male: "ç”·", female: "å¥³", age: "å¹´é¾„", height: "èº«é«˜", weight: "ä½“é‡",
            activity: "æ´»åŠ¨é‡", act1: "ä¹…å (åŠå…¬å®¤)", act2: "è½»åº¦ (æ¯å‘¨è¿åŠ¨1-3å¤©)", act3: "ä¸­åº¦ (æ¯å‘¨è¿åŠ¨3-5å¤©)", act4: "é«˜åº¦ (æ¯å‘¨è¿åŠ¨6-7å¤©)",
            mealMode: "ğŸ½ï¸ æ¯æ—¥é¤æ•°æ¨¡å¼", mode4: "æ ‡å‡† (3é¤+ç‚¹å¿ƒ)", mode3: "3é¤ (æ— ç‚¹å¿ƒ)", mode2: "2é¤ (168æ–­é£Ÿ)", mode1: "1é¤ (OMAD)",
            btnCalc: "ğŸ”„ ä¿å­˜å¹¶æ›´æ–°ç•Œé¢", resTdee: "TDEE", resTarget: "å‡é‡ç›®æ ‡",
            modalTitle: "AI åˆ†ææŠ¥å‘Š", modalAsk: "è¯·é—®è¿™æ˜¯å“ªä¸€é¤ï¼Ÿ", btnCancel: "å–æ¶ˆ",
            favTitle: "å¸¸åƒé£Ÿç‰©æ¸…å•", btnClose: "å…³é—­",
            menuImport: "å¯¼å…¥è¿˜åŸ", menuExport: "å¯¼å‡ºå¤‡ä»½", menuTheme: "åˆ‡æ¢ä¸»é¢˜", menuLang: "è¯­è¨€", menuCollection: "æ”¶è—ç³»ç»Ÿ", suggest: "å»ºè®®",
            langTitle: "è¯­è¨€", langCancel: "å–æ¶ˆ",
            meals: { breakfast: "ğŸ³ æ—©é¤", lunch: "ğŸ± åˆé¤", dinner: "ğŸ² æ™šé¤", snack: "ğŸª ç‚¹å¿ƒ", meal1: "ğŸ½ï¸ ç¬¬ä¸€é¤", meal2: "ğŸ½ï¸ ç¬¬äºŒé¤", mealBig: "ğŸ† å”¯ä¸€å¤§é¤" },
            alertDel: "ç¡®å®šè¦åˆ é™¤ï¼Ÿ", alertFavAdded: "å·²åŠ å…¥æ”¶è—ï¼", alertFavExist: "è¿™ä¸ªé£Ÿç‰©å·²ç»åœ¨æ”¶è—æ¸…å•å•°ï¼", alertSelImg: "è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼", alertAiFail: "AI åˆ†æå¤±è´¥ï¼š", alertFill: "è¯·å¡«å†™èµ„æ–™", alertNameCal: "è¯·è¾“å…¥åç§°ä¸çƒ­é‡", alertImportOk: "ğŸ‰ èµ„æ–™è¿˜åŸæˆåŠŸï¼", alertImportFail: "âŒ æ¡£æ¡ˆæ ¼å¼é”™è¯¯",
            msgNormal: "ä¸»äººï¼Œä»Šå¤©åƒä»€ä¹ˆï¼Ÿ", msgHappy: "å¤ªæ£’äº†ï¼æˆ‘è§‰å¾—å……æ»¡æ´»åŠ›ï¼", msgFat: "å‘ƒ...æˆ‘å¥½åƒåƒå¤ªé¥±äº†...", msgThirsty: "æ°´...æˆ‘è¦å–æ°´...", msgSad: "ä¸»äºº...åˆ«å¿˜äº†ç…§é¡¾æˆ‘..."
        },
        "en": {
            dateLabel: "ğŸ“… Date:", totalIntake: "Total Intake", goal: "Goal",
            pro: "Protein", fat: "Fat", carb: "Carb", sugar: "Sugar", sod: "Sodium", sat: "Sat. Fat", trans: "Trans Fat", water: "Water",
            chartTitle: "ğŸ“Š Nutrition Analysis", chartMacro: "Macros (PFC)", chartWeekly: "Weekly Calories",
            aiTitle: "ğŸ“¸ AI Analysis", btnPhoto: "ğŸ“¸ 1. Select Photo", btnAnalyze: "Analyze", aiLoading: "AI is analyzing...",
            aiDescPlaceholder: "ğŸ“ Optional description (e.g. Beef noodles, no onions)...",
            recordTitle: "Food Log", manualLabel: "Manual Entry (Calorie only)", placeholderName: "Food Name", placeholderCal: "Calories",
            btnAdd: "â• Add Log", btnFavSave: "Save Favorite", btnFavLoad: "Load Favorite", btnFavAi: "Save to Favorites",
            settingsTitle: "âš™ï¸ Profile Settings", gender: "Gender", male: "Male", female: "Female", age: "Age", height: "Height", weight: "Weight",
            activity: "Activity Level", act1: "Sedentary", act2: "Lightly Active", act3: "Moderately Active", act4: "Very Active",
            mealMode: "ğŸ½ï¸ Meal Mode", mode4: "Standard (3+Snack)", mode3: "3 Meals", mode2: "2 Meals (168)", mode1: "OMAD",
            btnCalc: "ğŸ”„ Save & Update", resTdee: "TDEE", resTarget: "Target",
            modalTitle: "AI Report", modalAsk: "Which meal is this?", btnCancel: "Cancel",
            favTitle: "Favorite Foods", btnClose: "Close",
            menuImport: "Import Data", menuExport: "Export Data", menuTheme: "Switch Theme", menuLang: "Language", menuCollection: "Collection", suggest: "Goal",
            langTitle: "Language", langCancel: "Cancel",
            meals: { breakfast: "ğŸ³ Breakfast", lunch: "ğŸ± Lunch", dinner: "ğŸ² Dinner", snack: "ğŸª Snack", meal1: "ğŸ½ï¸ Meal 1", meal2: "ğŸ½ï¸ Meal 2", mealBig: "ğŸ† Big Meal" },
            alertDel: "Delete this item?", alertFavAdded: "Saved to favorites!", alertFavExist: "Already in favorites!", alertSelImg: "Select image first!", alertAiFail: "AI Failed: ", alertFill: "Fill all fields", alertNameCal: "Enter name and calories", alertImportOk: "ğŸ‰ Data Restored!", alertImportFail: "âŒ Invalid File",
            msgNormal: "What are we eating today?", msgHappy: "I feel great!", msgFat: "Ugh... too much food...", msgThirsty: "Water... please...", msgSad: "Don't forget me..."
        },
        "ja": {
            dateLabel: "ğŸ“… æ—¥ä»˜ï¼š", totalIntake: "æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼", goal: "ç›®æ¨™",
            pro: "ã‚¿ãƒ³ãƒ‘ã‚¯è³ª", fat: "è„‚è³ª", carb: "ç‚­æ°´åŒ–ç‰©", sugar: "ç³–è³ª", sod: "å¡©åˆ†", sat: "é£½å’Œè„‚è‚ª", trans: "ãƒˆãƒ©ãƒ³ã‚¹è„‚è‚ª", water: "æ°´åˆ†ç›®æ¨™",
            chartTitle: "ğŸ“Š æ „é¤Šåˆ†æ", chartMacro: "ä¸‰å¤§æ „é¤Šç´  (PFC)", chartWeekly: "é€±é–“ã‚«ãƒ­ãƒªãƒ¼",
            aiTitle: "ğŸ“¸ AIé£Ÿäº‹åˆ†æ", btnPhoto: "ğŸ“¸ 1. å†™çœŸã‚’é¸æŠ", btnAnalyze: "åˆ†æé–‹å§‹", aiLoading: "AIåˆ†æä¸­...",
            aiDescPlaceholder: "ğŸ“ è£œè¶³èª¬æ˜ (ä¾‹: ç‰›è‚‰éººã€ãƒã‚®æŠœã)...",
            recordTitle: "é£Ÿäº‹è¨˜éŒ²", manualLabel: "æ‰‹å‹•å…¥åŠ› (ã‚«ãƒ­ãƒªãƒ¼ã®ã¿)", placeholderName: "é£Ÿå“å", placeholderCal: "kcal",
            btnAdd: "â• è¨˜éŒ²è¿½åŠ ", btnFavSave: "ãŠæ°—ã«å…¥ã‚Šä¿å­˜", btnFavLoad: "ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰é¸æŠ", btnFavAi: "ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜",
            settingsTitle: "âš™ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š", gender: "æ€§åˆ¥", male: "ç”·æ€§", female: "å¥³æ€§", age: "å¹´é½¢", height: "èº«é•·", weight: "ä½“é‡",
            activity: "æ´»å‹•ãƒ¬ãƒ™ãƒ«", act1: "åº§ã‚Šä»•äº‹", act2: "è»½ã„é‹å‹• (é€±1-3)", act3: "ä¸­ç¨‹åº¦ã®é‹å‹• (é€±3-5)", act4: "æ¿€ã—ã„é‹å‹• (é€±6-7)",
            mealMode: "ğŸ½ï¸ é£Ÿäº‹å›æ•°", mode4: "æ¨™æº– (3é£Ÿ+é–“é£Ÿ)", mode3: "3é£Ÿã®ã¿", mode2: "2é£Ÿ (168æ–­é£Ÿ)", mode1: "1é£Ÿ (OMAD)",
            btnCalc: "ğŸ”„ ä¿å­˜ã—ã¦æ›´æ–°", resTdee: "TDEE", resTarget: "ç›®æ¨™",
            modalTitle: "AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ", modalAsk: "ã©ã®é£Ÿäº‹ã§ã™ã‹ï¼Ÿ", btnCancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
            favTitle: "ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ", btnClose: "é–‰ã˜ã‚‹",
            menuImport: "å¾©å…ƒ", menuExport: "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—", menuTheme: "ãƒ†ãƒ¼ãƒåˆ‡æ›¿", menuLang: "è¨€èª", menuCollection: "ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³", suggest: "ç›®å®‰",
            langTitle: "è¨€èª", langCancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
            meals: { breakfast: "ğŸ³ æœé£Ÿ", lunch: "ğŸ± æ˜¼é£Ÿ", dinner: "ğŸ² å¤•é£Ÿ", snack: "ğŸª é–“é£Ÿ", meal1: "ğŸ½ï¸ é£Ÿäº‹1", meal2: "ğŸ½ï¸ é£Ÿäº‹2", mealBig: "ğŸ† å¤§ç››ã‚Š" },
            alertDel: "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", alertFavAdded: "ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜ã—ã¾ã—ãŸï¼", alertFavExist: "æ—¢ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™", alertSelImg: "ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„", alertAiFail: "AIã‚¨ãƒ©ãƒ¼: ", alertFill: "å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", alertNameCal: "åç§°ã¨ã‚«ãƒ­ãƒªãƒ¼ã‚’å…¥åŠ›", alertImportOk: "ğŸ‰ å¾©å…ƒå®Œäº†ï¼", alertImportFail: "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼",
            msgNormal: "ä»Šæ—¥ã¯ä½•ã‚’é£Ÿã¹ã¾ã™ã‹ï¼Ÿ", msgHappy: "æœ€é«˜ï¼å…ƒæ°—ã„ã£ã±ã„ã§ã™ï¼", msgFat: "ã†ã…...é£Ÿã¹éãã¾ã—ãŸ...", msgThirsty: "æ°´...æ°´ã‚’ãã ã•ã„...", msgSad: "å¿˜ã‚Œãªã„ã§..."
        }
    };

    let curLang = localStorage.getItem('appLang') || "zh-TW";
    let curTheme = localStorage.getItem('appTheme') || "light";

    // --- å…¨åŸŸè®Šæ•¸ ---
    let foodItems = []; 
    let targetCalories = 2000;
    let tempAIResult = null;
    let selectedDate = new Date().toISOString().split('T')[0];
    let currentMealMode = "4";
    let favoriteFoods = JSON.parse(localStorage.getItem('myFavorites') || "[]");
    let selectedPetTypeTemp = 'dog'; // è‡¨æ™‚è®Šæ•¸ç”¨

    let macroChart = null;
    let weeklyChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        setTheme(curTheme);
        setLang(curLang);
        initPetSystem(); // åˆå§‹åŒ–å¯µç‰©ç³»çµ±
        document.getElementById('current-date').value = selectedDate;
        loadProfile();
        loadFoodData(selectedDate);
        initCharts();
    });

    // --- ğŸ¶ å¯µç‰©èˆ‡æ”¶è—ç³»çµ± (æ ¸å¿ƒ) ---
    function initPetSystem() {
        if (!myPet) {
            document.getElementById('pet-modal').style.display = 'flex';
        } else {
            // æª¢æŸ¥é€£çºŒç°½åˆ° (Streak)
            const todayStr = new Date().toISOString().split('T')[0];
            if (myPet.lastLog !== todayStr) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (myPet.lastLog === yesterdayStr) {
                    myPet.streak = (myPet.streak || 0) + 1;
                } else if (myPet.lastLog < yesterdayStr) {
                    myPet.streak = 1; // æ–·ç°½é‡ç®—
                } else {
                    // ç¬¬ä¸€æ¬¡ä½¿ç”¨
                    myPet.streak = 1;
                }
                myPet.lastLog = todayStr;
                savePetData();
                checkUnlocks(); // æª¢æŸ¥æ˜¯å¦æœ‰æ–°è§£é–
            }
            renderPet();
        }
    }

    function selectPetType(type) {
        selectedPetTypeTemp = type;
        document.querySelectorAll('.pet-option').forEach(el => el.classList.remove('selected'));
        document.getElementById(`opt-${type}`).classList.add('selected');
    }

    function savePetProfile() {
        const name = document.getElementById('pet-name-input').value.trim();
        if (!name) { alert("è«‹å¹«ç‰ å–å€‹åå­—ï¼"); return; }
        myPet = { 
            type: selectedPetTypeTemp, name: name, 
            level: 1, exp: 0, streak: 1, lastLog: new Date().toISOString().split('T')[0],
            unlocked: [], equipPet: selectedPetTypeTemp, equipAcc: ''
        };
        savePetData();
        document.getElementById('pet-modal').style.display = 'none';
        renderPet();
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }

    function savePetData() {
        localStorage.setItem('myPetProfile_v2', JSON.stringify(myPet));
    }

    function checkUnlocks() {
        let newUnlock = false;
        UNLOCKS.forEach(item => {
            if (myPet.streak >= item.day && !myPet.unlocked.includes(item.id)) {
                myPet.unlocked.push(item.id);
                alert(`ğŸ‰ æ­å–œï¼é€£çºŒç´€éŒ„ ${item.day} å¤©ï¼Œè§£é–äº†ã€Œ${item.icon} ${item.name}ã€ï¼`);
                newUnlock = true;
            }
        });
        if(newUnlock) savePetData();
    }

    function renderPet() {
        if(!myPet) return;
        
        // 1. åŸºæœ¬è³‡è¨Š
        document.getElementById('pet-name-display').innerText = myPet.name;
        document.getElementById('pet-level').innerText = myPet.level;
        document.getElementById('streak-days').innerText = myPet.streak;
        
        // 2. ç¶“é©—å€¼æ¢
        const maxExp = myPet.level * 100;
        const expPct = Math.min(100, (myPet.exp / maxExp) * 100);
        document.getElementById('exp-bar').style.width = `${expPct}%`;

        // 3. ç‹€æ…‹åˆ¤æ–· (æ±ºå®šè¡¨æƒ…)
        updatePetStateDisplay();
    }

    function updatePetStateDisplay() {
        const currentCal = parseFloat(document.getElementById('total-cal-display').innerText) || 0;
        const targetCal = parseFloat(document.getElementById('target-cal-display').innerText) || 2000;
        const ratio = currentCal / targetCal;
        
        const avatarEl = document.getElementById('pet-avatar');
        const msgEl = document.getElementById('pet-msg');
        const t = i18n[curLang];
        
        // é‡ç½®å‹•ç•« class
        avatarEl.className = 'pet-avatar'; 
        let mood = 'normal';
        let msg = t.msgNormal;

        // ç°¡å–®çš„æƒ…ç·’é‚è¼¯
        if (ratio > 1.1) {
            mood = 'fat'; msg = t.msgFat;
            avatarEl.classList.add('pet-anim-fat');
        } else if (ratio >= 0.8 && ratio <= 1.1) {
            mood = 'happy'; msg = t.msgHappy;
            avatarEl.classList.add('pet-anim-happy');
        } else if (ratio < 0.2) {
            // åƒå¤ªå°‘æˆ–å‰›é–‹å§‹
            mood = 'normal'; 
            avatarEl.classList.add('pet-anim-breathe');
        }

        // é¡¯ç¤ºå°æ‡‰çš„ Emoji
        const petType = myPet.equipPet || myPet.type || 'dog';
        avatarEl.innerText = PET_DB[petType][mood];
        
        // é¡¯ç¤ºé…ä»¶
        const accEl = document.getElementById('pet-accessory');
        accEl.innerText = myPet.equipAcc ? UNLOCKS.find(u=>u.id===myPet.equipAcc)?.icon || '' : '';

        // é¡¯ç¤ºå°è©±
        msgEl.innerText = msg;
    }

    function petInteraction() {
        // é»æ“Šå¯µç‰©æ™‚çš„äº’å‹•
        const avatarEl = document.getElementById('pet-avatar');
        avatarEl.classList.remove('pet-anim-happy');
        void avatarEl.offsetWidth; // trigger reflow
        avatarEl.classList.add('pet-anim-happy');
        
        // éš¨æ©Ÿå°è©± (ç°¡å–®ç‰ˆ)
        const msgs = ["æ±ªï¼", "â¤ï¸", "æˆ‘è¦åƒè‚‰è‚‰ï¼", "åŠ æ²¹ï¼"];
        document.getElementById('pet-msg').innerText = msgs[Math.floor(Math.random()*msgs.length)];
    }

    function addExp(amount) {
        myPet.exp += amount;
        const maxExp = myPet.level * 100;
        if (myPet.exp >= maxExp) {
            myPet.level++;
            myPet.exp -= maxExp;
            alert(`ğŸ‰ ${myPet.name} å‡ç´šäº†ï¼è®Šæˆäº† Lv.${myPet.level}ï¼`);
            confetti({ particleCount: 150, spread: 60 });
        }
        savePetData();
        renderPet();
    }

    // --- æ”¶è—è¦–çª—é‚è¼¯ ---
    function openCollectionModal() {
        document.getElementById('streak-count-modal').innerText = myPet.streak;
        const grid = document.getElementById('collection-grid');
        grid.innerHTML = '';

        // é è¨­å¯µç‰© (ç‹—/è²“) æ°¸é è§£é–
        const defaults = [
            { id: 'dog', name: 'ç‹—ç‹—', type: 'pet', icon: 'ğŸ¶' },
            { id: 'cat', name: 'è²“è²“', type: 'pet', icon: 'ğŸ±' }
        ];

        // åˆä½µé è¨­èˆ‡è§£é–æ¸…å–®
        const allItems = [...defaults, ...UNLOCKS];

        allItems.forEach(item => {
            // åˆ¤æ–·æ˜¯å¦è§£é– (é è¨­oråœ¨è§£é–æ¸…å–®ä¸­)
            const isDefault = (item.id === 'dog' || item.id === 'cat');
            const isUnlocked = isDefault || myPet.unlocked.includes(item.id);
            const isActive = (item.type === 'pet' && myPet.equipPet === item.id) || (item.type === 'acc' && myPet.equipAcc === item.id);

            const div = document.createElement('div');
            div.className = `collection-item ${isUnlocked ? 'unlocked' : ''} ${isActive ? 'active' : ''}`;
            div.onclick = () => equipItem(item, isUnlocked);
            
            let hint = isUnlocked ? 'å·²æ“æœ‰' : `é€£çºŒ ${item.day} å¤©`;
            if (isDefault) hint = 'é è¨­';

            div.innerHTML = `
                <span class="collection-icon">${isUnlocked ? item.icon : 'ğŸ”’'}</span>
                <span class="collection-name">${item.name}</span>
                <span class="lock-hint">${hint}</span>
            `;
            grid.appendChild(div);
        });

        document.getElementById('collection-modal').style.display = 'flex';
        toggleFabMenu();
    }

    function equipItem(item, isUnlocked) {
        if (!isUnlocked) { alert(`é‚„æ²’è§£é–å–”ï¼éœ€è¦é€£çºŒç´€éŒ„ ${item.day} å¤©ã€‚åŠ æ²¹ï¼`); return; }
        
        if (item.type === 'pet') {
            myPet.equipPet = item.id;
        } else if (item.type === 'acc') {
            // å¦‚æœå·²ç¶“è£å‚™ï¼Œå‰‡å¸ä¸‹
            myPet.equipAcc = (myPet.equipAcc === item.id) ? '' : item.id;
        }
        savePetData();
        openCollectionModal(); // åˆ·æ–°ä»‹é¢ç‹€æ…‹
        renderPet(); // åˆ·æ–°ä¸»ç•«é¢
    }

    // --- ä»¥ä¸‹ç‚ºæ—¢æœ‰æ ¸å¿ƒé‚è¼¯ (æ•´åˆ EXP å¢åŠ ) ---
    // ... (ä¿ç•™ toggleTheme, setLang, initCharts ç­‰åŠŸèƒ½ï¼Œä»£ç¢¼éé•·çœç•¥éƒ¨åˆ†æœªè®Šå‹•é‚è¼¯) ...
    // é‡è¦ä¿®æ”¹ï¼šåœ¨æ–°å¢ç´€éŒ„æ™‚å¢åŠ  EXP

    function confirmAddFood(type) { 
        foodItems.push({ type: type, name: tempAIResult.name, nutri: tempAIResult.nutri }); 
        saveFoodData(); 
        renderListAndStats(); 
        closeModal('analysis-modal');
        addExp(20); // AI åˆ†æåŠ  20 åˆ†
    }

    function addManualFood() {
        const name = document.getElementById('manual-name').value; const cal = parseFloat(document.getElementById('manual-cal').value); const type = document.getElementById('manual-type').value;
        if (name && cal) {
            foodItems.push({ type: type, name: name, nutri: { calories: cal, protein:0, fat:0, carbohydrate:0, sugar:0, sodium:0, saturatedFat:0, transFat:0 } });
            saveFoodData(); renderListAndStats();
            document.getElementById('manual-name').value = ''; document.getElementById('manual-cal').value = '';
            addExp(10); // æ‰‹å‹•è¼¸å…¥åŠ  10 åˆ†
        } else { alert(i18n[curLang].alertNameCal); }
    }

    // --- (å…¶é¤˜æ—¢æœ‰å‡½å¼ä¿æŒä¸è®Šï¼Œç‚ºç¯€çœç¯‡å¹…åƒ…åˆ—å‡ºéœ€è¦çš„) ---
    function updateMealUI() {
        const t = i18n[curLang].meals;
        const config = {
            "4": { sections: ['breakfast', 'lunch', 'dinner', 'snack'], titles: { breakfast: t.breakfast, lunch: t.lunch, dinner: t.dinner, snack: t.snack } },
            "3": { sections: ['breakfast', 'lunch', 'dinner'], titles: { breakfast: t.breakfast, lunch: t.lunch, dinner: t.dinner } },
            "2": { sections: ['lunch', 'dinner'], titles: { lunch: t.meal1, dinner: t.meal2 } },
            "1": { sections: ['dinner'], titles: { dinner: t.mealBig } }
        }[currentMealMode];

        const container = document.getElementById('meal-sections-container');
        container.innerHTML = '';
        const manualSelect = document.getElementById('manual-type');
        manualSelect.innerHTML = '';
        const modalBtns = document.getElementById('modal-meal-buttons');
        modalBtns.innerHTML = '';

        config.sections.forEach(type => {
            // å»ºç«‹æ¸…å–®å€å¡Š
            const section = document.createElement('div');
            section.className = 'meal-section';
            section.innerHTML = `
                <div class="meal-header">
                    <div><span class="meal-title">${config.titles[type]}</span></div>
                    <div class="meal-progress" id="prog-${type}">0 kcal</div>
                </div>
                <ul class="meal-list" id="list-${type}"></ul>
            `;
            container.appendChild(section);

            // å»ºç«‹ä¸‹æ‹‰é¸é …
            const opt = document.createElement('option');
            opt.value = type; opt.text = config.titles[type];
            manualSelect.appendChild(opt);

            // å»ºç«‹ AI æŒ‰éˆ•
            const btn = document.createElement('button');
            btn.className = `meal-btn ${type}`;
            btn.innerText = config.titles[type];
            btn.onclick = () => confirmAddFood(type);
            modalBtns.appendChild(btn);
        });
    }

    function renderListAndStats() {
        // æ¸…ç©ºåˆ—è¡¨
        document.querySelectorAll('.meal-list').forEach(el => el.innerHTML = '');
        
        let total = { cal:0, pro:0, fat:0, carb:0, sugar:0, sod:0, sat:0, trans:0 };
        let mealTotals = {};

        foodItems.forEach((item, index) => {
            total.cal += (Number(item.nutri.calories) || 0); total.pro += (Number(item.nutri.protein) || 0);
            total.fat += (Number(item.nutri.fat) || 0); total.carb += (Number(item.nutri.carbohydrate) || 0);
            total.sugar += (Number(item.nutri.sugar) || 0); total.sod += (Number(item.nutri.sodium) || 0);
            total.sat += (Number(item.nutri.saturatedFat) || 0); total.trans += (Number(item.nutri.transFat) || 0);
            
            if(!mealTotals[item.type]) mealTotals[item.type] = 0;
            mealTotals[item.type] += (Number(item.nutri.calories) || 0);

            const li = document.createElement('li');
            li.innerHTML = `<div class="food-info"><div class="name">${item.name}</div><div class="detail">ğŸ”¥${Math.round(item.nutri.calories)}</div></div><button class="btn-delete" onclick="deleteItem(${index})">X</button>`;
            const listEl = document.getElementById(`list-${item.type}`);
            if(listEl) listEl.appendChild(li);
        });

        // æ›´æ–°å„é¤ç¸½è¨ˆ
        for(let type in mealTotals) {
            const el = document.getElementById(`prog-${type}`);
            if(el) el.innerText = `${Math.round(mealTotals[type])} kcal`;
        }

        document.getElementById('total-cal-display').innerText = Math.round(total.cal);
        ['pro','fat','carb'].forEach((k,i) => {
            document.getElementById(`sum-${k}`).innerText = Object.values(total)[i+1].toFixed(1);
        });
        document.getElementById('water-val').innerText = Math.round((parseFloat(document.getElementById('weight').value)||60)*35);

        updateCharts(total);
        updatePetStateDisplay(); // æ›´æ–°å¯µç‰©å¿ƒæƒ…
    }

    // --- å…¶ä»–å¿…å‚™å‡½å¼ (ç°¡åŒ–ç‰ˆ) ---
    function toggleTheme() { const t = curTheme==='light'?'dark':'light'; setTheme(t); }
    function setTheme(t) { curTheme=t; localStorage.setItem('appTheme',t); document.documentElement.setAttribute('data-theme',t); updateChartTheme(t); }
    function openLangModal() { document.getElementById('lang-modal').style.display='flex'; toggleFabMenu(); }
    function setLang(l) { curLang=l; localStorage.setItem('appLang',l); /* ...update texts... */ updateMealUI(); } 
    // (æ³¨æ„ï¼šé€™è£¡çœç•¥äº† setLang å…§éƒ¨çš„æ–‡å­—æ›´æ–°å°æ‡‰è¡¨ä»¥ç¯€çœç¯‡å¹…ï¼Œå¯¦éš›é‹ä½œéœ€åŒ…å«ä¸Šä¸€ç‰ˆçš„å®Œæ•´ mapping)
    function toggleFabMenu() { document.getElementById('fab-menu').classList.toggle('show'); }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function changeDate() { selectedDate = document.getElementById('current-date').value; document.getElementById('display-date-text').innerText = selectedDate; loadFoodData(selectedDate); }
    function saveFoodData() { localStorage.setItem(`record_${selectedDate}`, JSON.stringify(foodItems)); }
    function loadFoodData(date) { const stored = localStorage.getItem(`record_${date}`); foodItems = stored ? JSON.parse(stored) : []; renderListAndStats(); }
    function deleteItem(index) { if(confirm("Del?")) { foodItems.splice(index, 1); saveFoodData(); renderListAndStats(); } }
    
    // åˆå§‹åŒ–å‘¼å«
    function initCharts() {
        const ctxMacro = document.getElementById('macroChart').getContext('2d');
        macroChart = new Chart(ctxMacro, { type: 'doughnut', data: { labels: ['P','F','C'], datasets: [{ data:[0,0,0], backgroundColor:['#ff7675','#fdcb6e','#74b9ff'] }] }, options: { maintainAspectRatio:false } });
        const ctxWeekly = document.getElementById('weeklyChart').getContext('2d');
        weeklyChart = new Chart(ctxWeekly, { type: 'bar', data: { labels:[], datasets:[{ label:'kcal', data:[], backgroundColor:'#2ecc71', borderRadius:5 }] }, options: { maintainAspectRatio:false } });
    }
    function updateCharts(t) { if(macroChart){ macroChart.data.datasets[0].data=[t.pro,t.fat,t.carb]; macroChart.update(); } }
    function updateChartTheme(t) { Chart.defaults.color = t==='dark'?'#e0e0e0':'#2c3e50'; if(weeklyChart) weeklyChart.update(); if(macroChart) macroChart.update(); }
    
    // è£œé½Š Profile
    function loadProfile() { 
        const p = JSON.parse(localStorage.getItem('myProfile_v5')); 
        if(p) { 
            document.getElementById('gender').value=p.gender; document.getElementById('age').value=p.age; 
            document.getElementById('height').value=p.height; document.getElementById('weight').value=p.weight;
            document.getElementById('activity').value=p.activity; if(p.mealMode) document.getElementById('meal-mode').value=p.mealMode;
            calculateProfile(true);
        } else updateMealUI(); 
    }
    function calculateProfile(auto=false) {
        const h = parseFloat(document.getElementById('height').value), w = parseFloat(document.getElementById('weight').value), a = parseFloat(document.getElementById('age').value);
        if(!h||!w||!a) return;
        const bmr = (document.getElementById('gender').value==='male')?(10*w+6.25*h-5*a+5):(10*w+6.25*h-5*a-161);
        targetCalories = Math.round(bmr * parseFloat(document.getElementById('activity').value)) - 500;
        if(targetCalories<bmr) targetCalories=Math.round(bmr);
        currentMealMode = document.getElementById('meal-mode').value;
        document.getElementById('target-cal-display').innerText = targetCalories;
        document.getElementById('tdee-val').innerText = Math.round(bmr*parseFloat(document.getElementById('activity').value));
        document.getElementById('target-cal-val').innerText = targetCalories;
        localStorage.setItem('myProfile_v5', JSON.stringify({ gender:document.getElementById('gender').value, age:a, height:h, weight:w, activity:document.getElementById('activity').value, mealMode:currentMealMode }));
        updateMealUI(); renderListAndStats();
    }

    // AI & åœ–ç‰‡
    function handleFileSelect(input) { const f=input.files[0]; if(!f)return; document.getElementById('image-preview').src=URL.createObjectURL(f); document.getElementById('image-preview').style.display='block'; document.getElementById('analyze-btn').style.display='inline-block'; document.getElementById('ai-desc-group').style.display='block'; document.getElementById('ai-loading').style.display='none'; }
    async function startAnalysis() { /* ...åŒå‰ä¸€ç‰ˆ... */ }
    function toBase64(file) { return new Promise((r, j) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result.split(',')[1]); reader.onerror = j; }); }
    async function callCloudflareAI(b,d) { /* ...åŒå‰ä¸€ç‰ˆ... */ return {foodName:'Test Food', nutri:{calories:500,protein:20,fat:10,carbohydrate:50}}; } // é€™è£¡åƒ…ç‚ºç¤ºæ„ï¼Œéœ€è£œå›å®Œæ•´ fetch
    
    // è£œå› AI å‘¼å«å®Œæ•´ä»£ç¢¼ä»¥ç¢ºä¿åŠŸèƒ½æ­£å¸¸
    async function callCloudflareAI(base64, userDesc) {
        const url = "https://nameless-meadow-cf7b.jtwen12345us.workers.dev/";
        const prompt = `Analyze food image. Return JSON: foodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFat. ${userDesc ? 'Note: '+userDesc : ''}`;
        const resp = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } } ] }] }) });
        const data = await resp.json();
        let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        return JSON.parse(text);
    }
</script>
</body>
</html>
