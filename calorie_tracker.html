<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ å¿«æ¨‚å°ç‹—ç‡Ÿé¤Šç®¡å®¶ (å››é¤ç®¡ç†ç‰ˆ)</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        :root {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --accent: #6c5ce7;
            --bg: #f4f7f6;
            --text: #2c3e50;
            --card-bg: #ffffff;
            --meal-header-bg: #e8f8f5;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        .container { max-width: 900px; width: 100%; display: grid; gap: 20px; }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h2, h3 { margin-top: 0; color: var(--primary-dark); text-align: center; }

        /* --- å„€è¡¨æ¿ --- */
        .dashboard-header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }
        .big-cal { font-size: 2.5em; font-weight: bold; }
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .nutri-box {
            background: rgba(255,255,255,0.2);
            padding: 5px;
            border-radius: 8px;
            font-size: 0.9em;
            text-align: center;
        }
        .nutri-box span { display: block; font-weight: bold; }

        /* --- é¤é»å€å¡Š (Accordion style) --- */
        .meal-section {
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .meal-header {
            background-color: var(--meal-header-bg);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .meal-target { font-size: 0.85em; color: #7f8c8d; font-weight: normal; }
        .meal-body { padding: 10px; background: white; }
        .meal-list { list-style: none; padding: 0; margin: 0; }
        .meal-list li {
            padding: 8px;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }

        /* --- æŒ‰éˆ•èˆ‡è¡¨å–® --- */
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }
        button:hover { background-color: var(--primary-dark); }
        button.btn-ai { background: var(--accent); }
        button.btn-del { width: auto; padding: 4px 8px; background: #e74c3c; font-size: 12px; margin: 0; }

        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px;
        }

        /* --- AI é è¦½å€ --- */
        #preview-container { display: none; margin-top: 15px; text-align: center; }
        #image-preview { max-width: 100%; border-radius: 10px; margin-bottom: 10px; }
        .loading { display: none; color: var(--accent); font-weight: bold; margin: 10px 0; }

        /* --- å½ˆçª— (Modal) --- */
        .modal {
            display: none; 
            position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px;
            max-height: 80vh; overflow-y: auto;
        }
        .nutri-report p { margin: 5px 0; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-group button { margin-top: 0; }
    </style>
</head>
<body>

<div class="container">

    <div class="dashboard-header">
        <div style="font-size: 0.9em;">ä»Šæ—¥ç¸½æ”å– / ç›®æ¨™</div>
        <div>
            <span class="big-cal" id="total-intake">0</span> 
            <span style="font-size: 1.2em; opacity: 0.8;"> / <span id="goal-intake">--</span> kcal</span>
        </div>
        
        <div class="nutrition-grid">
            <div class="nutri-box"><span id="sum-pro">0</span>è›‹ç™½è³ª(g)</div>
            <div class="nutri-box"><span id="sum-fat">0</span>è„‚è‚ª(g)</div>
            <div class="nutri-box"><span id="sum-carb">0</span>ç¢³æ°´(g)</div>
            <div class="nutri-box"><span id="sum-sugar">0</span>ç³–(g)</div>
            <div class="nutri-box"><span id="sum-sod">0</span>éˆ‰(mg)</div>
            <div class="nutri-box"><span id="sum-sat">0</span>é£½å’Œè„‚(g)</div>
            <div class="nutri-box"><span id="sum-trans">0</span>åå¼è„‚(g)</div>
            <div class="nutri-box"><span id="water-goal">2000</span>ç›®æ¨™æ°´(ml)</div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“¸ AI é£²é£Ÿç´€éŒ„</h3>
        <div style="text-align: center;">
            <input type="file" id="image-upload" accept="image/*" capture="environment" style="display: none;" onchange="showPreview(this)">
            <button class="btn-ai" onclick="document.getElementById('image-upload').click()">1. é¸æ“‡/æ‹æ”ç…§ç‰‡</button>
        </div>

        <div id="preview-container">
            <img id="image-preview">
            <div class="loading" id="ai-loading">ğŸ¤– AI æ­£åœ¨åˆ†æé£Ÿç‰©ç‡Ÿé¤Š...</div>
            <button id="btn-start-analyze" onclick="startAnalyze()">2. é–‹å§‹ AI è¾¨è­˜</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ½ï¸ ä»Šæ—¥é¤é»ç´€éŒ„</h3>
        
        <div class="meal-section">
            <div class="meal-header">
                <span>ğŸ³ æ—©é¤ <span class="meal-target" id="target-breakfast">(å»ºè­°: 0)</span></span>
                <span id="cal-breakfast">0 kcal</span>
            </div>
            <div class="meal-body">
                <ul class="meal-list" id="list-breakfast"></ul>
                <button style="background-color: #eee; color: #555; font-size: 0.9em; padding: 8px;" onclick="openManualAdd('breakfast')">+ æ‰‹å‹•åŠ å…¥æ—©é¤</button>
            </div>
        </div>

        <div class="meal-section">
            <div class="meal-header">
                <span>ğŸ± åˆé¤ <span class="meal-target" id="target-lunch">(å»ºè­°: 0)</span></span>
                <span id="cal-lunch">0 kcal</span>
            </div>
            <div class="meal-body">
                <ul class="meal-list" id="list-lunch"></ul>
                <button style="background-color: #eee; color: #555; font-size: 0.9em; padding: 8px;" onclick="openManualAdd('lunch')">+ æ‰‹å‹•åŠ å…¥åˆé¤</button>
            </div>
        </div>

        <div class="meal-section">
            <div class="meal-header">
                <span>ğŸ¥— æ™šé¤ <span class="meal-target" id="target-dinner">(å»ºè­°: 0)</span></span>
                <span id="cal-dinner">0 kcal</span>
            </div>
            <div class="meal-body">
                <ul class="meal-list" id="list-dinner"></ul>
                <button style="background-color: #eee; color: #555; font-size: 0.9em; padding: 8px;" onclick="openManualAdd('dinner')">+ æ‰‹å‹•åŠ å…¥æ™šé¤</button>
            </div>
        </div>

        <div class="meal-section">
            <div class="meal-header">
                <span>ğŸ° é»å¿ƒ <span class="meal-target" id="target-snack">(å»ºè­°: 0)</span></span>
                <span id="cal-snack">0 kcal</span>
            </div>
            <div class="meal-body">
                <ul class="meal-list" id="list-snack"></ul>
                <button style="background-color: #eee; color: #555; font-size: 0.9em; padding: 8px;" onclick="openManualAdd('snack')">+ æ‰‹å‹•åŠ å…¥é»å¿ƒ</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>âš™ï¸ å€‹äººæª”æ¡ˆ (è¨­å®šç›®æ¨™)</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="number" id="age" placeholder="å¹´é½¡">
            <select id="gender"><option value="male">ç”·</option><option value="female">å¥³</option></select>
            <input type="number" id="height" placeholder="èº«é«˜(cm)">
            <input type="number" id="weight" placeholder="é«”é‡(kg)">
        </div>
        <select id="activity">
            <option value="1.2">ä¹…å (è¾¦å…¬å®¤)</option>
            <option value="1.375">è¼•åº¦æ´»å‹• (æ¯é€±1-3æ¬¡)</option>
            <option value="1.55">ä¸­åº¦æ´»å‹• (æ¯é€±3-5æ¬¡)</option>
            <option value="1.725">é«˜åº¦æ´»å‹• (æ¯é€±6-7æ¬¡)</option>
        </select>
        <button onclick="calculateProfile()">ğŸ”„ æ›´æ–°ç›®æ¨™ç†±é‡</button>
    </div>

</div>

<div id="resultModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“Š AI åˆ†æå ±å‘Š</h3>
        <div id="ai-report-content" class="nutri-report"></div>
        
        <label style="margin-top: 15px;">è«‹å•é€™é“é£Ÿç‰©è¦åŠ å…¥å“ªä¸€é¤ï¼Ÿ</label>
        <select id="meal-select">
            <option value="breakfast">ğŸ³ æ—©é¤</option>
            <option value="lunch" selected>ğŸ± åˆé¤</option>
            <option value="dinner">ğŸ¥— æ™šé¤</option>
            <option value="snack">ğŸ° é»å¿ƒ</option>
        </select>
        
        <div class="btn-group">
            <button onclick="confirmAddAI()" style="background: var(--primary);">âœ… åŠ å…¥ç´€éŒ„</button>
            <button onclick="closeModal()" style="background: #95a5a6;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="manualModal" class="modal">
    <div class="modal-content">
        <h3 id="manual-title">æ‰‹å‹•åŠ å…¥</h3>
        <input type="text" id="m-name" placeholder="é£Ÿç‰©åç¨±">
        <input type="number" id="m-cal" placeholder="ç†±é‡ (kcal)">
        <input type="hidden" id="m-type"> <div class="btn-group">
            <button onclick="confirmManualAdd()">åŠ å…¥</button>
            <button onclick="document.getElementById('manualModal').style.display='none'" style="background: #95a5a6;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    // è³‡æ–™çµæ§‹ï¼š { breakfast: [], lunch: [], dinner: [], snack: [] }
    let mealsData = { breakfast: [], lunch: [], dinner: [], snack: [] };
    let currentAIResult = null; // æš«å­˜ AI åˆ†æçµæœ
    let dailyGoal = 0;

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    // --- 1. è³‡æ–™å­˜å–èˆ‡è¨ˆç®— ---
    function saveData() {
        localStorage.setItem('myMealsData', JSON.stringify(mealsData));
        const profile = {
            age: document.getElementById('age').value,
            gender: document.getElementById('gender').value,
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            activity: document.getElementById('activity').value
        };
        localStorage.setItem('myProfile', JSON.stringify(profile));
    }

    function loadData() {
        const storedMeals = localStorage.getItem('myMealsData');
        if (storedMeals) mealsData = JSON.parse(storedMeals);

        const storedProfile = localStorage.getItem('myProfile');
        if (storedProfile) {
            const p = JSON.parse(storedProfile);
            document.getElementById('age').value = p.age;
            document.getElementById('gender').value = p.gender;
            document.getElementById('height').value = p.height;
            document.getElementById('weight').value = p.weight;
            document.getElementById('activity').value = p.activity;
            calculateProfile(true); // è‡ªå‹•è¨ˆç®—ç›®æ¨™
        }
        renderAll();
    }

    function calculateProfile(auto=false) {
        const h = parseFloat(document.getElementById('height').value);
        const w = parseFloat(document.getElementById('weight').value);
        const a = parseFloat(document.getElementById('age').value);
        const act = parseFloat(document.getElementById('activity').value);
        const g = document.getElementById('gender').value;

        if (!h || !w || !a) {
            if(!auto) alert("è«‹å®Œæ•´å¡«å¯«å€‹äººè³‡æ–™ä»¥è¨ˆç®—ç›®æ¨™ï¼");
            return;
        }

        // BMR å…¬å¼
        let bmr = (g === 'male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161);
        let tdee = Math.round(bmr * act);
        dailyGoal = tdee - 500; // æ¸›é‡ç›®æ¨™
        if (dailyGoal < bmr) dailyGoal = Math.round(bmr); // ä¸ä½æ–¼åŸºç¤ä»£è¬

        // æ›´æ–° UI ç›®æ¨™
        document.getElementById('goal-intake').innerText = dailyGoal;
        document.getElementById('water-goal').innerText = Math.round(w * 35);

        // åˆ†é…å„é¤å»ºè­° (æ—©30%, åˆ35%, æ™š25%, é»å¿ƒ10%)
        document.getElementById('target-breakfast').innerText = `(å»ºè­°: ${Math.round(dailyGoal*0.3)})`;
        document.getElementById('target-lunch').innerText = `(å»ºè­°: ${Math.round(dailyGoal*0.35)})`;
        document.getElementById('target-dinner').innerText = `(å»ºè­°: ${Math.round(dailyGoal*0.25)})`;
        document.getElementById('target-snack').innerText = `(å»ºè­°: ${Math.round(dailyGoal*0.1)})`;

        saveData();
    }

    // --- 2. æ¸²æŸ“ç•«é¢ ---
    function renderAll() {
        let dailyTotal = { cal:0, pro:0, fat:0, carb:0, sugar:0, sod:0, sat:0, trans:0 };

        // éæ­·å››é¤
        ['breakfast', 'lunch', 'dinner', 'snack'].forEach(type => {
            const listEl = document.getElementById(`list-${type}`);
            const calEl = document.getElementById(`cal-${type}`);
            listEl.innerHTML = '';
            let mealCal = 0;

            mealsData[type].forEach((item, idx) => {
                // ç´¯åŠ æ•¸å€¼
                mealCal += (Number(item.cal) || 0);
                dailyTotal.cal += (Number(item.cal) || 0);
                dailyTotal.pro += (Number(item.pro) || 0);
                dailyTotal.fat += (Number(item.fat) || 0);
                dailyTotal.carb += (Number(item.carb) || 0);
                dailyTotal.sugar += (Number(item.sugar) || 0);
                dailyTotal.sod += (Number(item.sod) || 0);
                dailyTotal.sat += (Number(item.sat) || 0);
                dailyTotal.trans += (Number(item.trans) || 0);

                // ç”¢ç”Ÿåˆ—è¡¨
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <strong>${item.name}</strong> <small style="color:#666">(${Math.round(item.cal)} kcal)</small><br>
                        <small style="font-size:0.8em; color:#999">P:${item.pro} F:${item.fat} C:${item.carb}</small>
                    </div>
                    <button class="btn-del" onclick="deleteFood('${type}', ${idx})">X</button>
                `;
                listEl.appendChild(li);
            });
            calEl.innerText = Math.round(mealCal) + " kcal";
        });

        // æ›´æ–°ç¸½å„€è¡¨æ¿
        document.getElementById('total-intake').innerText = Math.round(dailyTotal.cal);
        document.getElementById('sum-pro').innerText = dailyTotal.pro.toFixed(1);
        document.getElementById('sum-fat').innerText = dailyTotal.fat.toFixed(1);
        document.getElementById('sum-carb').innerText = dailyTotal.carb.toFixed(1);
        document.getElementById('sum-sugar').innerText = dailyTotal.sugar.toFixed(1);
        document.getElementById('sum-sod').innerText = Math.round(dailyTotal.sod);
        document.getElementById('sum-sat').innerText = dailyTotal.sat.toFixed(1);
        document.getElementById('sum-trans').innerText = dailyTotal.trans.toFixed(1);
    }

    function deleteFood(type, idx) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ")) {
            mealsData[type].splice(idx, 1);
            saveData();
            renderAll();
        }
    }

    // --- 3. AI è¾¨è­˜æµç¨‹ ---
    let currentFile = null;

    function showPreview(input) {
        if (input.files && input.files[0]) {
            currentFile = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('preview-container').style.display = 'block';
                document.getElementById('btn-start-analyze').style.display = 'inline-block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function startAnalyze() {
        if (!currentFile) return;
        
        document.getElementById('btn-start-analyze').style.display = 'none';
        document.getElementById('ai-loading').style.display = 'block';

        try {
            const base64 = await toBase64(currentFile);
            const result = await callCloudflareAI(base64);
            
            // æš«å­˜çµæœä¸¦é–‹å•Ÿå½ˆçª—
            currentAIResult = {
                name: result.foodName,
                cal: Number(result.calories) || 0,
                pro: Number(result.protein) || 0,
                fat: Number(result.fat) || 0,
                carb: Number(result.carbohydrate) || 0,
                sugar: Number(result.sugar) || 0,
                sod: Number(result.sodium) || 0,
                sat: Number(result.saturatedFat) || 0,
                trans: Number(result.transFat) || 0
            };

            showReportModal();

        } catch (e) {
            alert("åˆ†æå¤±æ•—ï¼š" + e.message);
            document.getElementById('btn-start-analyze').style.display = 'inline-block';
        } finally {
            document.getElementById('ai-loading').style.display = 'none';
        }
    }

    function showReportModal() {
        const r = currentAIResult;
        const html = `
            <p><strong>é£Ÿç‰©åç¨±ï¼š</strong> ${r.name}</p>
            <p><strong>ğŸ”¥ ç†±é‡ï¼š</strong> ${r.cal} kcal</p>
            <p>ğŸ¥© è›‹ç™½è³ªï¼š${r.pro} g</p>
            <p>ğŸ¥‘ è„‚è‚ªï¼š${r.fat} g</p>
            <p>ğŸ ç¢³æ°´ï¼š${r.carb} g</p>
            <small style="color:#666">ç³–:${r.sugar}g / éˆ‰:${r.sod}mg</small>
        `;
        document.getElementById('ai-report-content').innerHTML = html;
        document.getElementById('resultModal').style.display = 'flex';
    }

    function confirmAddAI() {
        const mealType = document.getElementById('meal-select').value;
        if (currentAIResult) {
            mealsData[mealType].push(currentAIResult);
            saveData();
            renderAll();
            closeModal();
            // é‡ç½®é è¦½
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('image-upload').value = '';
        }
    }

    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
        document.getElementById('manualModal').style.display = 'none';
    }

    async function callCloudflareAI(base64) {
        // ğŸ‘‡ æ‚¨çš„ Cloudflare Worker ç¶²å€
        const url = "https://nameless-meadow-cf7b.jtwen12345us.workers.dev/";

        const prompt = `
        ä½ æ˜¯ä¸€ä½ç‡Ÿé¤Šå¸«ã€‚è«‹åˆ†æåœ–ç‰‡é£Ÿç‰©çš„ã€Œå…«å¤§ç‡Ÿé¤ŠæŒ‡æ¨™ã€ã€‚
        å›å‚³ç´” JSON æ ¼å¼ï¼Œä¸è¦ Markdownã€‚
        æ¬„ä½ï¼šfoodName(å­—ä¸²), calories(æ•¸å€¼), protein(æ•¸å€¼g), fat(æ•¸å€¼g), carbohydrate(æ•¸å€¼g), sugar(æ•¸å€¼g), sodium(æ•¸å€¼mg), saturatedFat(æ•¸å€¼g), transFat(æ•¸å€¼g)ã€‚
        å¦‚æœç„¡æ³•ç²¾ç¢ºï¼Œè«‹ä¼°ç®—ã€‚
        `;

        const resp = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: base64 } }
                    ]
                }]
            })
        });

        const data = await resp.json();
        if (data.error) throw new Error(JSON.stringify(data.error));
        let text = data.candidates[0].content.parts[0].text;
        text = text.replace(/```json|```/g, '').trim();
        return JSON.parse(text);
    }

    function toBase64(file) {
        return new Promise((r, j) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => r(reader.result.split(',')[1]);
            reader.onerror = j;
        });
    }

    // --- 4. æ‰‹å‹•åŠ å…¥åŠŸèƒ½ ---
    function openManualAdd(type) {
        document.getElementById('m-type').value = type;
        document.getElementById('manual-title').innerText = `æ‰‹å‹•åŠ å…¥ - ${getMealName(type)}`;
        document.getElementById('manualModal').style.display = 'flex';
    }

    function confirmManualAdd() {
        const type = document.getElementById('m-type').value;
        const name = document.getElementById('m-name').value;
        const cal = parseFloat(document.getElementById('m-cal').value);

        if (name && cal) {
            mealsData[type].push({
                name: name,
                cal: cal,
                pro:0, fat:0, carb:0, sugar:0, sod:0, sat:0, trans:0 // æ‰‹å‹•ç°¡åŒ–ç‰ˆ
            });
            saveData();
            renderAll();
            closeModal();
            document.getElementById('m-name').value = '';
            document.getElementById('m-cal').value = '';
        } else {
            alert("è«‹è¼¸å…¥åç¨±èˆ‡ç†±é‡");
        }
    }

    function getMealName(type) {
        const names = { breakfast:'æ—©é¤', lunch:'åˆé¤', dinner:'æ™šé¤', snack:'é»å¿ƒ' };
        return names[type];
    }

</script>

</body>
</html>
