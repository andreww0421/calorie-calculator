<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚å°ç‹—æ‰“æ“Šå¡è·¯é‡Œ</title>
    <style>
        /* CSS ç¾åŒ–å€åŸŸ */
        :root {
            --primary-color: #2ecc71; /* å¥åº·ç¶  */
            --secondary-color: #27ae60;
            --accent-color: #6c5ce7; /* AI ç´« */
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            display: grid;
            gap: 20px;
        }

        h1, h2 { text-align: center; color: var(--secondary-color); margin-bottom: 10px;}
        
        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* AI å€å¡Šæ¨£å¼ */
        .ai-section {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            border: 2px dashed var(--accent-color);
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; 
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        button:hover { background-color: var(--secondary-color); }

        button.btn-ai {
            background-color: var(--accent-color);
        }
        button.btn-ai:hover {
            background-color: #5b4cc4;
        }

        /* çµæœå„€è¡¨æ¿ç¶²æ ¼ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .stat-box {
            background: #e8f8f5;
            padding: 15px;
            border-radius: 10px;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: var(--secondary-color); }
        .stat-label { font-size: 14px; color: #7f8c8d; }

        /* é£Ÿç‰©æ¸…å–® */
        #food-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        #food-list li {
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .total-cal {
            text-align: right;
            font-size: 20px;
            margin-top: 15px;
            font-weight: bold;
        }
        
        .advice-box {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            color: #856404;
            border-radius: 5px;
            display: none; 
        }

        /* é£Ÿç‰©è¼¸å…¥å€å¡Šä½ˆå±€å„ªåŒ– */
        .food-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
        }
        .food-manual-input {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .search-button {
            background-color: #3498db;
            color: white;
            width: auto;
            padding: 5px 10px;
            font-size: 14px;
            margin-top: 0;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            color: var(--accent-color);
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¶å¡è·¯é‡Œå„€è¡¨æ¿ğŸ¶</h1>

    <div class="card">
        <h2>æ­¥é©Ÿä¸€ï¼šè¨­å®šå€‹äººæª”æ¡ˆ</h2>
        <div class="form-group">
            <label>æ€§åˆ¥</label>
            <select id="gender">
                <option value="male">ç”·</option>
                <option value="female">å¥³</option>
            </select>
        </div>
        <div class="form-group">
            <label>å¹´é½¡ (æ­²)</label>
            <input type="number" id="age" placeholder="ä¾‹å¦‚: 25">
        </div>
        <div class="form-group">
            <label>èº«é«˜ (cm)</label>
            <input type="number" id="height" placeholder="ä¾‹å¦‚: 175">
        </div>
        <div class="form-group">
            <label>é«”é‡ (kg)</label>
            <input type="number" id="weight" placeholder="ä¾‹å¦‚: 70">
        </div>
        <div class="form-group">
            <label>æ—¥å¸¸æ´»å‹•é‡</label>
            <select id="activity">
                <option value="1.2">ä¹…å (å¹¾ä¹ä¸é‹å‹•)</option>
                <option value="1.375">è¼•åº¦æ´»å‹• (æ¯é€±é‹å‹• 1-3 å¤©)</option>
                <option value="1.55">ä¸­åº¦æ´»å‹• (æ¯é€±é‹å‹• 3-5 å¤©)</option>
                <option value="1.725">é«˜åº¦æ´»å‹• (æ¯é€±é‹å‹• 6-7 å¤©)</option>
            </select>
        </div>
        <button onclick="calculateProfile()">è¨ˆç®—æˆ‘çš„å¥åº·æ•¸æ“š</button>
    </div>

    <div class="card" id="result-section" style="display:none;">
        <h2>æ‚¨çš„æ¯æ—¥ç›®æ¨™</h2>
        <div class="dashboard-grid">
            <div class="stat-box">
                <div class="stat-value" id="tdee-val">0</div>
                <div class="stat-label">TDEE (ç¶­æŒé«”é‡)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="water-val">0</div>
                <div class="stat-label">å»ºè­°é£²æ°´é‡ (ml)</div>
            </div>
            <div class="stat-box" style="background-color: #d4edda;">
                <div class="stat-value" id="diet-cal-val">0</div>
                <div class="stat-label">æ¸›é‡å»ºè­°æ”å–</div>
            </div>
        </div>
        <div class="advice-box" id="advice-text"></div>
    </div>

    <div class="card ai-section">
        <h2 style="color: var(--accent-color);">ğŸ“¸ æ­¥é©ŸäºŒï¼šAI é£²é£Ÿç´€éŒ„</h2>
        
        <div style="text-align: center; margin-top: 10px;">
            <input type="file" id="image-upload" accept="image/*" capture="environment" style="display: none;" onchange="previewAndAnalyze(this)">
            <button class="btn-ai" onclick="document.getElementById('image-upload').click()">ğŸ“¸ æ‹ç…§æˆ–ä¸Šå‚³é£Ÿç‰©åœ–ç‰‡</button>
        </div>

        <div class="loading-spinner" id="ai-loading">
            ğŸ¤– AI æ­£åœ¨åˆ†æå…«å¤§ç‡Ÿé¤ŠæŒ‡æ¨™ä¸­ï¼Œè«‹ç¨å€™... â³
        </div>
        <img id="image-preview" style="max-width: 100%; border-radius: 10px; display: none; margin-top: 15px; margin-bottom: 15px;">
    </div>

    <div class="card">
        <h3>ğŸ“ æ‰‹å‹•è£œå…… / å¿«é€Ÿç´€éŒ„</h3>

        <div class="form-group">
            <label>é¸æ“‡å¸¸è¦‹é£Ÿç‰©ï¼ˆå¿«é€Ÿç´€éŒ„ï¼‰</label>
            <div style="display: flex; gap: 10px;">
                <select id="quick-food" onchange="fillCalorie()" style="flex: 2;">
                    <option value="0">--- è«‹é¸æ“‡é£Ÿç‰© ---</option>
                </select>
                <input type="number" id="quick-food-cal" placeholder="ç†±é‡ (å¡)" disabled style="flex: 1; background-color: #eee;">
            </div>
            <button onclick="addQuickFood()">åŠ å…¥æ¸…å–® (é¸å–®)</button>
        </div>

        <div class="food-manual-input">
            <label>æ‰‹å‹•è¼¸å…¥é£Ÿç‰©ï¼ˆæ™ºæ…§æœå°‹ç†±é‡ï¼‰</label>
            <div class="food-input-group">
                <input type="text" id="food-name" placeholder="é£Ÿç‰©åç¨± (ä¾‹å¦‚: çç å¥¶èŒ¶)">
                <input type="number" id="food-cal" placeholder="ç†±é‡ (å¤§å¡)">
                <button onclick="searchCalorie()" class="search-button">æ™ºæ…§æœå°‹ç†±é‡ ğŸ”</button>
                <button onclick="addFood()">åŠ å…¥æ¸…å–® (æ‰‹å‹•)</button>
            </div>
        </div>

        <ul id="food-list">
        </ul>
        
        <div class="total-cal">
            ä»Šæ—¥å·²æ”å–: <span id="total-intake" style="color: var(--primary-color);">0</span> kcal
            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                æ¸›é‡ç›®æ¨™å‰©é¤˜é¡åº¦: <span id="remaining-cal">è«‹å…ˆè¨ˆç®—å€‹äººæ•¸æ“š</span> kcal
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†å„²å­˜è¨ˆç®—çµæœ
    let currentTDEE = 0;
    let dietCalories = 0;
    let totalIntake = 0;
    // æ–°å¢ï¼šå„²å­˜æ‰€æœ‰é£Ÿç‰©ç‰©ä»¶çš„é™£åˆ—ï¼Œç”¨æ–¼LocalStorageè¨˜æ†¶
    let foodItems = []; 

    // é£Ÿç‰©è³‡æ–™åº« (Food Database)
    const FOOD_DB = {
        'æ°´ç…®è›‹ (1é¡†)': 78,
        'é¦™è•‰ (1æ ¹)': 105,
        'å¾¡é£¯ç³° (é®ªé­š)': 200,
        'é›èƒ¸è‚‰ (100å…‹)': 165,
        'ç™½é£¯ (1ç¢—/200å…‹)': 280,
        'æ»·è‚‰é£¯ (1ç¢—)': 650,
        'é›è…¿ä¾¿ç•¶ (å»çš®)': 600,
        'çç å¥¶èŒ¶ (å…¨ç³–)': 550,
        'ç¾å¼å’–å•¡ (å¤§æ¯)': 10
    };

    // --- è¼‰å…¥èˆ‡å„²å­˜å€‹äººè³‡æ–™åŠé£²é£Ÿç´€éŒ„åŠŸèƒ½ ---

    document.addEventListener('DOMContentLoaded', (event) => {
        // ç”Ÿæˆé£Ÿç‰©é¸å–®
        const select = document.getElementById('quick-food');
        for (const [name, cal] of Object.entries(FOOD_DB)) {
            const option = document.createElement('option');
            option.value = cal;
            option.textContent = name;
            select.appendChild(option);
        }
        
        // è¼‰å…¥æ‰€æœ‰è³‡æ–™ (å€‹äººæª”æ¡ˆ + é£Ÿç‰©æ¸…å–®)
        loadProfile();
    });

    // å„²å­˜è³‡æ–™å‡½æ•¸ï¼šåŒ…å«å€‹äººæª”æ¡ˆå’Œé£Ÿç‰©æ¸…å–®
    function saveProfile() {
        // 1. å„²å­˜å€‹äººæª”æ¡ˆ
        const profileFields = ['gender', 'age', 'height', 'weight', 'activity'];
        profileFields.forEach(id => {
            const value = document.getElementById(id).value;
            localStorage.setItem(id, value);
        });

        // 2. å„²å­˜é£Ÿç‰©æ¸…å–® (å°‡ foodItems é™£åˆ—è½‰æ›æˆ JSON å­—ä¸²)
        localStorage.setItem('foodItems', JSON.stringify(foodItems));
    }

    // è¼‰å…¥è³‡æ–™å‡½æ•¸ï¼šåŒ…å«å€‹äººæª”æ¡ˆå’Œé£Ÿç‰©æ¸…å–®
    function loadProfile() {
        // 1. è¼‰å…¥å€‹äººæª”æ¡ˆ
        const profileFields = ['gender', 'age', 'height', 'weight', 'activity'];
        profileFields.forEach(id => {
            const value = localStorage.getItem(id);
            const element = document.getElementById(id);
            if (value && element) {
                element.value = value;
            }
        });

        // 2. è¼‰å…¥é£Ÿç‰©æ¸…å–®
        const storedFoods = localStorage.getItem('foodItems');
        if (storedFoods) {
            foodItems = JSON.parse(storedFoods); // å°‡ JSON å­—ä¸²è½‰å›é™£åˆ—
            // é‡æ–°è¨ˆç®—ç¸½ç†±é‡ä¸¦æ¸²æŸ“æ¸…å–®
            totalIntake = 0;
            foodItems.forEach(item => {
                // é‡æ–°æ¸²æŸ“é£Ÿç‰©æ¸…å–®åˆ° DOM (å‚³å…¥ false è¡¨ç¤ºé€™æ¬¡æ˜¯è¼‰å…¥ï¼Œä¸éœ€è¦å†æ¬¡å„²å­˜)
                addFoodToDOM(item.name, item.cal, false); 
            });
            document.getElementById('total-intake').innerText = totalIntake;
        }

        // 3. å˜—è©¦è‡ªå‹•è¨ˆç®—å€‹äººæ•¸æ“š
        if (localStorage.getItem('age') && localStorage.getItem('height') && localStorage.getItem('weight')) {
             // å‚³å…¥ true è¡¨ç¤ºæ˜¯è¼‰å…¥æ™‚çš„è‡ªå‹•è¨ˆç®—ï¼Œé€™æ¨£å°±ä¸æœƒè·³å‡ºè­¦å‘Šè¦–çª—
             calculateProfile(true); 
        }
    }


    // åŠŸèƒ½ 1 & 2 & 4: è¨ˆç®—å€‹äººæ•¸æ“š (BMR, TDEE, æ°´)
    function calculateProfile(isAutoLoad = false) {
        const gender = document.getElementById('gender').value;
        const age = parseFloat(document.getElementById('age').value);
        const height = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);
        const activity = parseFloat(document.getElementById('activity').value);

        // å¦‚æœä¸æ˜¯è‡ªå‹•è¼‰å…¥ï¼Œä¸”æœ‰æ¬„ä½æ˜¯ç©ºçš„ï¼Œå°±è·³å‡ºè­¦å‘Š
        if (!isAutoLoad && (!age || !height || !weight || age <= 0 || height <= 0 || weight <= 0)) {
            alert("è«‹å®Œæ•´å¡«å¯«æœ‰æ•ˆçš„å€‹äººè³‡æ–™ (å¹´é½¡ã€èº«é«˜ã€é«”é‡å¿…é ˆå¤§æ–¼ 0)ï¼");
            return;
        }

        // åªæœ‰ç•¶ä½¿ç”¨è€…æ‰‹å‹•é»æ“Šè¨ˆç®—æˆ–æˆåŠŸè¼‰å…¥æ™‚æ‰å„²å­˜
        saveProfile(); 
        
        // BMR/TDEE/Water è¨ˆç®—é‚è¼¯
        let bmr = 0;
        if (gender === 'male') {
            bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
        } else {
            bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
        }

        currentTDEE = Math.round(bmr * activity);
        const water = Math.round(weight * 35);
        dietCalories = currentTDEE - 500;
        if (dietCalories < bmr) {
             dietCalories = Math.round(bmr); 
        }

        // æ›´æ–° UI é¡¯ç¤º
        document.getElementById('tdee-val').innerText = currentTDEE;
        document.getElementById('water-val').innerText = water;
        document.getElementById('diet-cal-val').innerText = dietCalories;
        
        // ç˜¦èº«å»ºè­°
        const adviceDiv = document.getElementById('advice-text');
        adviceDiv.style.display = 'block';
        adviceDiv.innerHTML = `
            <strong>ğŸ’¡ ç˜¦èº«å°å»ºè­°ï¼š</strong><br>
            ç‚ºäº†é”åˆ°æ¯é€±ç´„æ¸›é‡ 0.5 å…¬æ–¤ï¼Œå»ºè­°æ‚¨æ¯æ—¥æ”å– <b>${dietCalories}</b> å¤§å¡ã€‚<br>
            è«‹è¨˜å¾—æ¯å¤©è‡³å°‘å– <b>${water}cc</b> çš„æ°´ä¾†å¹«åŠ©ä»£è¬ï¼
        `;

        document.getElementById('result-section').style.display = 'block';
        
        updateRemaining();
    }

    // --- AI æ ¸å¿ƒåŠŸèƒ½ ---
    async function previewAndAnalyze(input) {
        const file = input.files[0];
        const preview = document.getElementById('image-preview');
        const loading = document.getElementById('ai-loading');

        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);

        loading.style.display = 'block';
        try {
            const base64Image = await toBase64(file);
            // å‘¼å« Cloudflareï¼Œä¸å†å‚³ API Key
            const result = await callGeminiAI(base64Image); 
            
            if (result) {
                // é€™è£¡ AI å›å‚³äº†è©³ç´°ç‡Ÿé¤Šç´ ï¼Œä½†ç›®å‰çš„ UI åªæœ‰ç†±é‡æ¬„ä½
                // æˆ‘å€‘å–ç”¨å®ƒçš„ç†±é‡ (calories) ä¸¦é¡¯ç¤ºè©³ç´°è³‡è¨Šçµ¦ä½¿ç”¨è€…çœ‹
                const msg = `AI åˆ†æå®Œæˆï¼\né£Ÿç‰©ï¼š${result.foodName}\nç†±é‡ï¼š${result.calories} kcal\n\n(è©³ç´°è³‡è¨Šï¼šè›‹ç™½è³ª ${result.protein}g, è„‚è‚ª ${result.fat}g, ç¢³æ°´ ${result.carbohydrate}g)\n\næ˜¯å¦åŠ å…¥æ¸…å–®ï¼Ÿ`;
                
                if (confirm(msg)) {
                    // è‡ªå‹•å¡«å…¥ç†±é‡ä¸¦åŠ å…¥
                    addFoodToDOM(result.foodName, result.calories, true);
                }
            }
        } catch (error) {
            console.error(error);
            // é¡¯ç¤ºè©³ç´°éŒ¯èª¤ï¼Œæ–¹ä¾¿é™¤éŒ¯
            alert("âš ï¸ AI åˆ†æå¤±æ•—ï¼š\n" + error.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    // å‘¼å« Cloudflare Worker
    async function callGeminiAI(base64Data) {
        // ğŸ‘‡ æ‚¨çš„ Cloudflare Worker ç¶²å€ (è«‹ç¢ºä¿é€™è¡Œæ˜¯æ­£ç¢ºçš„)
        const workerUrl = "https://nameless-meadow-cf7b.jtwen12345us.workers.dev/"; 
        
        const prompt = `
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­ç‡Ÿé¤Šå¸«ã€‚è«‹åˆ†æåœ–ç‰‡ä¸­çš„é£Ÿç‰©ï¼Œä¸¦å›å‚³ä¸€ä»½åŒ…å«ã€Œå…«å¤§ç‡Ÿé¤ŠæŒ‡æ¨™ã€çš„ JSON è³‡æ–™ã€‚
        è¦å‰‡ï¼š
        1. ä¼°ç®—æ•´ä»½é£Ÿç‰©çš„ç¸½é‡ã€‚
        2. è‹¥ç„¡æ³•ç²¾ç¢ºåˆ¤æ–·ï¼Œè«‹ä¾æ“šå¸¸è¦‹ç‡Ÿé¤Šè³‡æ–™åº«ä¼°ç®—ã€‚
        3. å›å‚³æ ¼å¼å¿…é ˆæ˜¯ç´” JSONï¼Œä¸è¦åŒ…å« Markdown (\`\`\`) æˆ–å…¶ä»–æ–‡å­—ã€‚
        4. JSON æ¬„ä½å¦‚ä¸‹ (æ•¸å€¼ç‚ºæ•¸å­—ï¼Œå–®ä½å¦‚æ‹¬è™Ÿ)ï¼š
        {
            "foodName": "é£Ÿç‰©åç¨± (å­—ä¸²)",
            "calories": ç†±é‡ (kcal),
            "protein": è›‹ç™½è³ª (g),
            "fat": ç¸½è„‚è‚ª (g),
            "saturatedFat": é£½å’Œè„‚è‚ª (g),
            "transFat": åå¼è„‚è‚ª (g),
            "carbohydrate": ç¢³æ°´åŒ–åˆç‰© (g),
            "sugar": ç³– (g),
            "sodium": éˆ‰ (mg)
        }
        `;

        const response = await fetch(workerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                    ]
                }]
            })
        });

        const data = await response.json();
        
        // è™•ç† Cloudflare æˆ– Google çš„éŒ¯èª¤
        if (data.error) {
            let errorMsg = data.error.message || JSON.stringify(data.error);
            // é€™è£¡æœƒæŠŠéŒ¯èª¤ä¸Ÿå‡ºå»ï¼Œè¢« previewAndAnalyze çš„ catch æŠ“åˆ°ä¸¦ alert
            throw new Error("Google API éŒ¯èª¤: " + errorMsg);
        }

        if (!data.candidates || data.candidates.length === 0) throw new Error("AI ç„¡æ³•è¾¨è­˜åœ–ç‰‡ (æ²’æœ‰å›å‚³å…§å®¹)");

        let textResult = data.candidates[0].content.parts[0].text;
        textResult = textResult.replace(/```json|```/g, '').trim();
        return JSON.parse(textResult);
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }

    // åŠŸèƒ½ï¼šç•¶é¸æ“‡å¸¸è¦‹é£Ÿç‰©æ™‚ï¼Œè‡ªå‹•å¡«å…¥ç†±é‡
    function fillCalorie() {
        const cal = document.getElementById('quick-food').value;
        document.getElementById('quick-food-cal').value = cal > 0 ? cal : '';
    }

    // åŠŸèƒ½ï¼šåŠ å…¥å¸¸è¦‹é£Ÿç‰©
    function addQuickFood() {
        const selectElement = document.getElementById('quick-food');
        const cal = parseFloat(selectElement.value);
        const name = selectElement.options[selectElement.selectedIndex].text;

        if (cal <= 0 || name === '--- è«‹é¸æ“‡é£Ÿç‰© ---') {
            alert("è«‹é¸æ“‡ä¸€å€‹é£Ÿç‰©é …ç›®ï¼");
            return;
        }

        addFoodToDOM(name, cal, true); // å„²å­˜æ¸…å–®
        
        selectElement.value = '0';
        document.getElementById('quick-food-cal').value = '';
    }
    
    // åŠŸèƒ½ï¼šæ™ºæ…§æœå°‹ç†±é‡
    function searchCalorie() {
        const foodName = document.getElementById('food-name').value;
        if (!foodName) {
            alert("è«‹å…ˆè¼¸å…¥æ‚¨è¦æŸ¥è©¢çš„é£Ÿç‰©åç¨±ï¼");
            return;
        }
        
        const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(foodName + " ç†±é‡ å¤§å¡")}`;
        window.open(searchUrl, '_blank');
    }

    // åŠŸèƒ½ï¼šåŠ å…¥æ‰‹å‹•è¼¸å…¥çš„é£Ÿç‰©
    function addFood() {
        const name = document.getElementById('food-name').value;
        const cal = parseFloat(document.getElementById('food-cal').value);

        if (!name || isNaN(cal) || cal <= 0) {
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„é£Ÿç‰©åç¨±å’Œç†±é‡æ•¸å­—ï¼");
            return;
        }

        addFoodToDOM(name, cal, true); // å„²å­˜æ¸…å–®

        document.getElementById('food-name').value = '';
        document.getElementById('food-cal').value = '';
    }

    // æ ¸å¿ƒï¼šå°‡é£Ÿç‰©åŠ å…¥æ¸…å–®çš„å…±ç”¨é‚è¼¯
    function addFoodToDOM(name, cal, shouldSave) {
        // å¦‚æœæ˜¯æ–°å¢ï¼Œå‰‡åŠ å…¥ foodItems é™£åˆ—ä¸¦é‡æ–°è¨ˆç®—ç¸½ç†±é‡
        if (shouldSave) {
            // å°‡é£Ÿç‰©ç‰©ä»¶åŠ å…¥åˆ°å…¨åŸŸé™£åˆ—
            foodItems.push({ name: name, cal: cal }); 
            totalIntake += cal; // ç´¯ç©ç¸½ç†±é‡
            saveProfile(); // å„²å­˜åˆ° LocalStorage
        }

        // æ–°å¢åˆ°åˆ—è¡¨ UI
        const list = document.getElementById('food-list');
        const li = document.createElement('li');
        // ç‚ºæ¯å€‹ li è¨­ç½®ä¸€å€‹å±¬æ€§ï¼Œç”¨æ–¼å¾ŒçºŒåˆªé™¤æ™‚è­˜åˆ¥
        li.setAttribute('data-name', name);
        li.setAttribute('data-cal', cal);

        li.innerHTML = `
            <span>${name}</span> 
            <span>${cal} kcal
                <button onclick="deleteFood(this)" style="width: auto; padding: 2px 5px; margin-left: 10px; background-color: #e74c3c;">X</button>
            </span>
        `;
        list.appendChild(li);

        document.getElementById('total-intake').innerText = totalIntake;
        updateRemaining();
    }

    // åŠŸèƒ½ï¼šåˆªé™¤é£Ÿç‰©é …ç›®
    function deleteFood(buttonElement) {
        const listItem = buttonElement.closest('li');
        const calToRemove = parseFloat(listItem.getAttribute('data-cal'));
        const nameToRemove = listItem.getAttribute('data-name');
        
        // 1. å¾ foodItems é™£åˆ—ä¸­ç§»é™¤è©²é …ç›®
        // æ‰¾å‡ºç¬¬ä¸€å€‹ç¬¦åˆåç¨±å’Œç†±é‡çš„é …ç›®ä¸¦ç§»é™¤
        const index = foodItems.findIndex(item => item.name === nameToRemove && item.cal === calToRemove);
        if (index > -1) {
            foodItems.splice(index, 1);
        }

        // 2. å¾ç¸½è¨ˆä¸­æ‰£é™¤ç†±é‡
        totalIntake -= calToRemove;
        document.getElementById('total-intake').innerText = totalIntake;

        // 3. å¾ DOM ä¸­ç§»é™¤åˆ—è¡¨é …
        listItem.remove();

        // 4. é‡æ–°å„²å­˜æ¸…å–®
        saveProfile(); 

        // 5. æ›´æ–°å‰©é¤˜é¡åº¦
        updateRemaining();
    }
    
    // æ›´æ–°å‰©é¤˜å¡è·¯é‡Œ
    function updateRemaining() {
        const remainingSpan = document.getElementById('remaining-cal');

        if (dietCalories === 0) {
            remainingSpan.innerText = "è«‹å…ˆè¨ˆç®—å€‹äººæ•¸æ“š";
            remainingSpan.style.color = "#666";
            return;
        }

        const remaining = dietCalories - totalIntake;
        
        remainingSpan.innerText = remaining;

        if (remaining < 0) {
            remainingSpan.style.color = "red";
            remainingSpan.innerText = Math.abs(remaining) + " (å·²è¶…æ¨™!)";
        } else {
            remainingSpan.style.color = "var(--secondary-color)";
        }
    }
</script>

</body>
</html>
