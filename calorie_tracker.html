<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½ç‡Ÿé¤Šç®¡å®¶ (å®‰å…¨ç‰ˆ)</title>
    <style>
        /* CSS ç¾åŒ–å€åŸŸ */
        :root {
            --primary-color: #2ecc71; /* å¥åº·ç¶  */
            --secondary-color: #27ae60;
            --accent-color: #6c5ce7; /* AI ç´« */
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            display: grid;
            gap: 20px;
        }

        h1, h2 { text-align: center; color: var(--secondary-color); margin-bottom: 10px;}
        h3 { margin-top: 0; margin-bottom: 15px; }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* AI å€å¡Šæ¨£å¼ */
        .ai-section {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            border: 2px dashed var(--accent-color);
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; 
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        button:hover { background-color: var(--secondary-color); }
        
        button.btn-ai {
            background-color: var(--accent-color);
        }
        button.btn-ai:hover {
            background-color: #5b4cc4;
        }

        /* çµæœå„€è¡¨æ¿ç¶²æ ¼ (TDEE) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        /* å…«å¤§æŒ‡æ¨™å„€è¡¨æ¿ */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            background-color: #fafafa;
            padding: 15px;
            border-radius: 10px;
        }
        
        @media (min-width: 600px) {
            .nutrition-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .nutri-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            text-align: center;
            font-size: 14px;
        }
        .nutri-item .val {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
            margin-top: 5px;
        }
        .nutri-item.main-stat {
            border-bottom: 3px solid var(--primary-color);
        }

        .stat-box {
            background: #e8f8f5;
            padding: 15px;
            border-radius: 10px;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: var(--secondary-color); }
        .stat-label { font-size: 14px; color: #7f8c8d; }

        /* é£Ÿç‰©æ¸…å–® */
        #food-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        #food-list li {
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .advice-box {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            color: #856404;
            border-radius: 5px;
            display: none; 
        }

        .loading-spinner {
            display: none;
            text-align: center;
            color: var(--accent-color);
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¥— AI æ™ºèƒ½ç‡Ÿé¤Šç®¡å®¶ ğŸ¥—</h1>

    <div class="card">
        <h2>æ­¥é©Ÿä¸€ï¼šè¨­å®šå€‹äººæª”æ¡ˆ</h2>
        <div class="form-group">
            <label>æ€§åˆ¥</label>
            <select id="gender">
                <option value="male">ç”·</option>
                <option value="female">å¥³</option>
            </select>
        </div>
        <div class="form-group">
            <label>å¹´é½¡ (æ­²)</label>
            <input type="number" id="age" placeholder="ä¾‹å¦‚: 25">
        </div>
        <div class="form-group">
            <label>èº«é«˜ (cm)</label>
            <input type="number" id="height" placeholder="ä¾‹å¦‚: 175">
        </div>
        <div class="form-group">
            <label>é«”é‡ (kg)</label>
            <input type="number" id="weight" placeholder="ä¾‹å¦‚: 70">
        </div>
        <div class="form-group">
            <label>æ—¥å¸¸æ´»å‹•é‡</label>
            <select id="activity">
                <option value="1.2">ä¹…å (å¹¾ä¹ä¸é‹å‹•)</option>
                <option value="1.375">è¼•åº¦æ´»å‹• (æ¯é€±é‹å‹• 1-3 å¤©)</option>
                <option value="1.55">ä¸­åº¦æ´»å‹• (æ¯é€±é‹å‹• 3-5 å¤©)</option>
                <option value="1.725">é«˜åº¦æ´»å‹• (æ¯é€±é‹å‹• 6-7 å¤©)</option>
            </select>
        </div>
        <button onclick="calculateProfile()">è¨ˆç®—æˆ‘çš„å¥åº·æ•¸æ“š</button>
    </div>

    <div class="card" id="result-section" style="display:none;">
        <h2>æ‚¨çš„æ¯æ—¥ç›®æ¨™</h2>
        <div class="dashboard-grid">
            <div class="stat-box">
                <div class="stat-value" id="tdee-val">0</div>
                <div class="stat-label">TDEE (ç¶­æŒé«”é‡)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="water-val">0</div>
                <div class="stat-label">å»ºè­°é£²æ°´é‡ (ml)</div>
            </div>
            <div class="stat-box" style="background-color: #d4edda;">
                <div class="stat-value" id="diet-cal-val">0</div>
                <div class="stat-label">æ¸›é‡å»ºè­°æ”å–</div>
            </div>
        </div>
        <div class="advice-box" id="advice-text"></div>
    </div>

    <div class="card ai-section">
        <h2 style="color: var(--accent-color);">ğŸ“¸ æ­¥é©ŸäºŒï¼šAI é£²é£Ÿç´€éŒ„</h2>
        
        <div style="text-align: center; margin-top: 10px;">
            <input type="file" id="image-upload" accept="image/*" capture="environment" style="display: none;" onchange="previewAndAnalyze(this)">
            <button class="btn-ai" onclick="document.getElementById('image-upload').click()">ğŸ“¸ æ‹ç…§æˆ–ä¸Šå‚³é£Ÿç‰©åœ–ç‰‡</button>
        </div>

        <div class="loading-spinner" id="ai-loading">
            ğŸ¤– AI æ­£åœ¨åˆ†æå…«å¤§ç‡Ÿé¤ŠæŒ‡æ¨™ä¸­ï¼Œè«‹ç¨å€™... â³
        </div>
        <img id="image-preview" style="max-width: 100%; border-radius: 10px; display: none; margin-top: 15px; margin-bottom: 15px;">
    </div>

    <div class="card">
        <h3>ğŸ“ æ‰‹å‹•è£œå…… / å¿«é€Ÿç´€éŒ„</h3>
        <div class="form-group">
            <label>å¿«é€Ÿé¸æ“‡ (åƒ…ç†±é‡)</label>
            <div style="display: flex; gap: 10px;">
                <select id="quick-food" style="flex: 2;">
                    <option value="0">--- å¸¸è¦‹é£Ÿç‰© ---</option>
                </select>
                <button onclick="addQuickFood()" style="flex: 1; margin-top:0;">åŠ å…¥</button>
            </div>
        </div>

        <div class="form-group" style="border-top: 1px solid #eee; padding-top: 15px;">
            <label>æ‰‹å‹•è¼¸å…¥ (åƒ…ç†±é‡)</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="food-name" placeholder="é£Ÿç‰©åç¨±">
                <input type="number" id="food-cal" placeholder="ç†±é‡">
                <button onclick="addFood()" style="width: auto; margin-top:0; white-space: nowrap;">åŠ å…¥</button>
            </div>
        </div>

        <h3>ğŸ“‹ ä»Šæ—¥æ”å–æ¸…å–®</h3>
        <ul id="food-list">
            </ul>
    </div>

    <div class="card" style="border: 2px solid var(--primary-color);">
        <h2>ğŸ“Š ä»Šæ—¥å…«å¤§ç‡Ÿé¤Šç¸½è¦½</h2>
        
        <div class="nutrition-grid">
            <div class="nutri-item main-stat">ğŸ”¥ ç†±é‡ <span class="val" id="sum-cal">0</span> <small>kcal</small></div>
            <div class="nutri-item main-stat">ğŸ¥© è›‹ç™½è³ª <span class="val" id="sum-protein">0</span> <small>g</small></div>
            <div class="nutri-item main-stat">ğŸ¥‘ è„‚è‚ª <span class="val" id="sum-fat">0</span> <small>g</small></div>
            <div class="nutri-item main-stat">ğŸ ç¢³æ°´ <span class="val" id="sum-carb">0</span> <small>g</small></div>
            
            <div class="nutri-item">ğŸ¬ ç³–åˆ† <span class="val" id="sum-sugar">0</span> <small>g</small></div>
            <div class="nutri-item">ğŸ§‚ éˆ‰å«é‡ <span class="val" id="sum-sodium">0</span> <small>mg</small></div>
            <div class="nutri-item">ğŸ¥“ é£½å’Œè„‚è‚ª <span class="val" id="sum-sat-fat">0</span> <small>g</small></div>
            <div class="nutri-item">ğŸš« åå¼è„‚è‚ª <span class="val" id="sum-trans-fat">0</span> <small>g</small></div>
        </div>

        <div style="margin-top: 15px; text-align: center; color: #666;">
            æ¸›é‡ç›®æ¨™å‰©é¤˜ç†±é‡: <span id="remaining-cal" style="font-weight: bold; font-size: 1.2em;">è«‹å…ˆè¨ˆç®—</span>
        </div>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentTDEE = 0;
    let dietCalories = 0;
    let foodItems = []; 

    // ç°¡æ˜“é£Ÿç‰©è³‡æ–™åº«
    const FOOD_DB = {
        'æ°´ç…®è›‹ (1é¡†)': 78, 'é¦™è•‰ (1æ ¹)': 105, 'å¾¡é£¯ç³° (é®ªé­š)': 200,
        'é›èƒ¸è‚‰ (100å…‹)': 165, 'ç™½é£¯ (1ç¢—)': 280, 'ç‡™é’èœ': 40,
        'çç å¥¶èŒ¶ (å…¨ç³–)': 550, 'ç¾å¼å’–å•¡': 10
    };

    document.addEventListener('DOMContentLoaded', () => {
        // 1. ç”Ÿæˆå¿«é€Ÿé¸å–®
        const select = document.getElementById('quick-food');
        for (const [name, cal] of Object.entries(FOOD_DB)) {
            const option = document.createElement('option');
            option.value = cal; 
            option.textContent = name;
            select.appendChild(option);
        }
        // 2. è¼‰å…¥å€‹äººæª”æ¡ˆèˆ‡ç´€éŒ„
        loadProfile();
    });

    // --- AI æ ¸å¿ƒåŠŸèƒ½ ---
    async function previewAndAnalyze(input) {
        const file = input.files[0];
        const preview = document.getElementById('image-preview');
        const loading = document.getElementById('ai-loading');

        if (!file) return;

        // é¡¯ç¤ºé è¦½
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);

        // é–‹å§‹åˆ†æ
        loading.style.display = 'block';
        try {
            const base64Image = await toBase64(file);
            const result = await callGeminiAI(base64Image); // ä¸å†éœ€è¦å‚³ API Key
            
            if (result) {
                const msg = `AI åˆ†æå®Œæˆï¼\né£Ÿç‰©ï¼š${result.foodName}\nç†±é‡ï¼š${result.calories} kcal\nè›‹ç™½è³ªï¼š${result.protein} g\n\næ˜¯å¦åŠ å…¥æ¸…å–®ï¼Ÿ`;
                if (confirm(msg)) {
                    addFoodItem(result.foodName, result);
                }
            }
        } catch (error) {
            console.error(error);
            alert("AI åˆ†æå¤±æ•—ï¼š" + error.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    // å‘¼å« Cloudflare Worker
    async function callGeminiAI(base64Data) {
        // [è¨­å®š] ä½¿ç”¨æ‚¨éƒ¨ç½²çš„ Cloudflare Worker ç¶²å€
        const workerUrl = "https://nameless-meadow-cf7b.jtwen12345us.workers.dev/"; 
        
        const prompt = `
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­ç‡Ÿé¤Šå¸«ã€‚è«‹åˆ†æåœ–ç‰‡ä¸­çš„é£Ÿç‰©ï¼Œä¸¦å›å‚³ä¸€ä»½åŒ…å«ã€Œå…«å¤§ç‡Ÿé¤ŠæŒ‡æ¨™ã€çš„ JSON è³‡æ–™ã€‚
        è¦å‰‡ï¼š
        1. ä¼°ç®—æ•´ä»½é£Ÿç‰©çš„ç¸½é‡ã€‚
        2. è‹¥ç„¡æ³•ç²¾ç¢ºåˆ¤æ–·ï¼Œè«‹ä¾æ“šå¸¸è¦‹ç‡Ÿé¤Šè³‡æ–™åº«ä¼°ç®—ã€‚
        3. å›å‚³æ ¼å¼å¿…é ˆæ˜¯ç´” JSONï¼Œä¸è¦åŒ…å« Markdown (\`\`\`) æˆ–å…¶ä»–æ–‡å­—ã€‚
        4. JSON æ¬„ä½å¦‚ä¸‹ (æ•¸å€¼ç‚ºæ•¸å­—ï¼Œå–®ä½å¦‚æ‹¬è™Ÿ)ï¼š
        {
            "foodName": "é£Ÿç‰©åç¨± (å­—ä¸²)",
            "calories": ç†±é‡ (kcal),
            "protein": è›‹ç™½è³ª (g),
            "fat": ç¸½è„‚è‚ª (g),
            "saturatedFat": é£½å’Œè„‚è‚ª (g),
            "transFat": åå¼è„‚è‚ª (g),
            "carbohydrate": ç¢³æ°´åŒ–åˆç‰© (g),
            "sugar": ç³– (g),
            "sodium": éˆ‰ (mg)
        }
        `;

        // å‚³é€è³‡æ–™çµ¦ Worker (ä¸ç›´æ¥å° Google)
        const response = await fetch(workerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                    ]
                }]
            })
        });

        const data = await response.json();
        
        // è™•ç†éŒ¯èª¤
        if (data.error) throw new Error(data.error.message || data.error);
        if (!data.candidates || data.candidates.length === 0) throw new Error("AI ç„¡æ³•è¾¨è­˜åœ–ç‰‡");

        let textResult = data.candidates[0].content.parts[0].text;
        textResult = textResult.replace(/```json|```/g, '').trim();
        return JSON.parse(textResult);
    }

    // --- è³‡æ–™è™•ç†é‚è¼¯ ---
    function addFoodItem(name, nutritionData) {
        const safeData = {
            calories: Number(nutritionData.calories) || 0,
            protein: Number(nutritionData.protein) || 0,
            fat: Number(nutritionData.fat) || 0,
            saturatedFat: Number(nutritionData.saturatedFat) || 0,
            transFat: Number(nutritionData.transFat) || 0,
            carbohydrate: Number(nutritionData.carbohydrate) || 0,
            sugar: Number(nutritionData.sugar) || 0,
            sodium: Number(nutritionData.sodium) || 0
        };

        foodItems.push({ name: name, nutrition: safeData });
        saveProfile();
        renderFoodList();
    }

    function renderFoodList() {
        const list = document.getElementById('food-list');
        list.innerHTML = '';
        let totals = { calories:0, protein:0, fat:0, saturatedFat:0, transFat:0, carbohydrate:0, sugar:0, sodium:0 };

        foodItems.forEach((item, index) => {
            for (let key in totals) totals[key] += item.nutrition[key];
            const li = document.createElement('li');
            li.innerHTML = `
                <div>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div style="font-size:12px; color:#888;">
                        ğŸ”¥${item.nutrition.calories} | P:${item.nutrition.protein} | F:${item.nutrition.fat} | C:${item.nutrition.carbohydrate}
                    </div>
                </div>
                <div>
                    <button onclick="deleteFood(${index})" style="background:#e74c3c; padding:5px 10px; margin:0;">åˆªé™¤</button>
                </div>
            `;
            list.appendChild(li);
        });
        updateDashboard(totals);
    }

    function updateDashboard(totals) {
        document.getElementById('sum-cal').innerText = Math.round(totals.calories);
        document.getElementById('sum-protein').innerText = totals.protein.toFixed(1);
        document.getElementById('sum-fat').innerText = totals.fat.toFixed(1);
        document.getElementById('sum-carb').innerText = totals.carbohydrate.toFixed(1);
        document.getElementById('sum-sugar').innerText = totals.sugar.toFixed(1);
        document.getElementById('sum-sodium').innerText = Math.round(totals.sodium);
        document.getElementById('sum-sat-fat').innerText = totals.saturatedFat.toFixed(1);
        document.getElementById('sum-trans-fat').innerText = totals.transFat.toFixed(1);

        const remainingSpan = document.getElementById('remaining-cal');
        if (dietCalories > 0) {
            const remaining = dietCalories - totals.calories;
            remainingSpan.innerText = `${Math.round(remaining)} kcal`;
            remainingSpan.style.color = remaining < 0 ? "#e74c3c" : "#27ae60";
            if (remaining < 0) remainingSpan.innerText += " (å·²è¶…æ¨™)";
        }
    }

    function deleteFood(index) {
        foodItems.splice(index, 1);
        saveProfile();
        renderFoodList();
    }

    function addQuickFood() {
        const select = document.getElementById('quick-food');
        const cal = parseFloat(select.value);
        const name = select.options[select.selectedIndex].text;
        if (cal > 0) addFoodItem(name, { calories: cal });
        else alert("è«‹é¸æ“‡é£Ÿç‰©");
    }

    function addFood() {
        const name = document.getElementById('food-name').value;
        const cal = parseFloat(document.getElementById('food-cal').value);
        if (name && cal > 0) {
            addFoodItem(name, { calories: cal });
            document.getElementById('food-name').value = '';
            document.getElementById('food-cal').value = '';
        } else {
            alert("è«‹è¼¸å…¥åç¨±èˆ‡ç†±é‡");
        }
    }

    function calculateProfile(isAuto = false) {
        const gender = document.getElementById('gender').value;
        const age = parseFloat(document.getElementById('age').value);
        const height = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);
        const activity = parseFloat(document.getElementById('activity').value);

        if (!isAuto && (!age || !height || !weight)) { alert("è«‹å®Œæ•´å¡«å¯«å€‹äººè³‡æ–™ï¼"); return; }
        if (age && height && weight) {
            saveProfile();
            let bmr = (10 * weight) + (6.25 * height) - (5 * age) + (gender === 'male' ? 5 : -161);
            currentTDEE = Math.round(bmr * activity);
            dietCalories = currentTDEE - 500;
            if (dietCalories < bmr) dietCalories = Math.round(bmr);
            const water = Math.round(weight * 35);

            document.getElementById('tdee-val').innerText = currentTDEE;
            document.getElementById('water-val').innerText = water;
            document.getElementById('diet-cal-val').innerText = dietCalories;
            document.getElementById('result-section').style.display = 'block';
            document.getElementById('advice-text').style.display = 'block';
            document.getElementById('advice-text').innerHTML = `ğŸ’¡ å»ºè­°æ‚¨æ¯æ—¥æ”å– <b>${dietCalories}</b> å¤§å¡ï¼Œä¸¦å–æ°´ <b>${water}cc</b>ã€‚`;
            renderFoodList();
        }
    }

    function saveProfile() {
        const profile = {
            gender: document.getElementById('gender').value,
            age: document.getElementById('age').value,
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            activity: document.getElementById('activity').value,
            foodItems: foodItems
        };
        localStorage.setItem('calories_profile_v2', JSON.stringify(profile));
    }

    function loadProfile() {
        const data = localStorage.getItem('calories_profile_v2');
        if (data) {
            const profile = JSON.parse(data);
            document.getElementById('gender').value = profile.gender;
            document.getElementById('age').value = profile.age;
            document.getElementById('height').value = profile.height;
            document.getElementById('weight').value = profile.weight;
            document.getElementById('activity').value = profile.activity;
            if (profile.foodItems) foodItems = profile.foodItems;
            calculateProfile(true);
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }
</script>

</body>
</html>
