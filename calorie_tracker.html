<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ å¿«æ¨‚å°ç‹—ç‡Ÿé¤Šç®¡å®¶</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <link rel="apple-touch-icon" href="calorie_icon.png">
    <link rel="icon" type="image/png" href="calorie_icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('App æº–å‚™å°±ç·’'))
                .catch((error) => console.log('App è¨»å†Šå¤±æ•—:', error));
        }
    </script>

    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ (CSS è®Šæ•¸ç³»çµ±) --- */
        :root {
            /* é è¨­äº®è‰²ä¸»é¡Œ */
            --primary-color: #2ecc71; 
            --primary-dark: #27ae60;
            --accent-color: #6c5ce7;  
            --bg-color: #f0f2f5;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --meal-header-bg: #f1f8e9;
            --input-bg: #ffffff;
            --input-border: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.05);
            --modal-bg: #ffffff;
        }

        /* æ·±è‰²ä¸»é¡Œå®šç¾© */
        [data-theme="dark"] {
            --primary-color: #2ecc71; 
            --primary-dark: #27ae60; /* ä¿æŒç¶ è‰²ç³»ï¼Œæˆ–è€…å¯ä»¥å¾®èª¿æ›´äº®ä¸€é» */
            --accent-color: #a29bfe;  /* ç¨å¾®èª¿äº®ç´«è‰²ä»¥ä¾¿åœ¨æ·±è‰²èƒŒæ™¯é¡¯ç¤º */
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --meal-header-bg: #2d3436;
            --input-bg: #2d2d2d;
            --input-border: #444444;
            --shadow-color: rgba(0,0,0,0.5);
            --modal-bg: #2d2d2d;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            padding-bottom: 90px;
            display: flex;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s; /* å¹³æ»‘éæ¸¡ */
        }

        .container { max-width: 800px; width: 100%; display: grid; gap: 20px; }

        h1, h2, h3 { text-align: center; margin: 0 0 15px 0; color: var(--primary-dark); transition: color 0.3s; }
        h1 { font-size: 1.8em; margin-bottom: 20px; }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        /* --- æ—¥æœŸé¸æ“‡å™¨ --- */
        .date-control {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            background: var(--card-bg); padding: 10px; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: background-color 0.3s;
        }
        .date-control input { 
            width: auto; padding: 8px; 
            border: 1px solid var(--input-border); 
            background: var(--input-bg);
            color: var(--text-color);
            border-radius: 8px; font-size: 16px; 
        }

        /* --- å„€è¡¨æ¿ --- */
        .dashboard-header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white; padding: 20px; border-radius: 16px; text-align: center; margin-bottom: 10px;
        }
        .dashboard-header .label { font-size: 0.9em; opacity: 0.9; }
        .dashboard-header .big-cal { font-size: 3em; font-weight: bold; line-height: 1.2; }
        
        .nutrition-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px;
        }
        .nutri-box {
            background: rgba(255,255,255,0.2); padding: 8px 4px; border-radius: 8px;
            text-align: center; backdrop-filter: blur(5px);
        }
        .nutri-box .n-val { display: block; font-weight: bold; font-size: 1.1em; }
        .nutri-box .n-label { font-size: 0.75em; opacity: 0.9; }

        /* --- åœ–è¡¨ --- */
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 600px) { .chart-grid { grid-template-columns: 1fr 1fr; } }
        /* åœ–è¡¨æ¨™é¡Œåœ¨æ·±è‰²æ¨¡å¼ä¸‹ä¹Ÿè¦è®Šè‰² */
        .chart-title { text-align:center; font-size:0.9em; color: #888; transition: color 0.3s; }
        [data-theme="dark"] .chart-title { color: #bbb; }

        /* --- é¤é»å€å¡Š --- */
        .meal-section { border: 1px solid var(--input-border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; transition: all 0.3s; }
        .meal-header {
            background-color: var(--meal-header-bg); padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--input-border);
            transition: background-color 0.3s;
        }
        .meal-title { font-weight: bold; font-size: 1.1em; color: var(--primary-dark); }
        .meal-goal { font-size: 0.85em; color: #7f8c8d; }
        .meal-progress { font-size: 0.9em; font-weight: bold; }
        
        .meal-list { list-style: none; padding: 0; margin: 0; }
        .meal-list li {
            padding: 12px 15px; border-bottom: 1px solid var(--input-border); 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--card-bg); /* è·Ÿéš¨å¡ç‰‡èƒŒæ™¯ */
            transition: background-color 0.3s;
        }
        .meal-list li:last-child { border-bottom: none; }
        .food-info .name { font-weight: bold; }
        .food-info .detail { font-size: 0.8em; color: #888; margin-top: 2px; }

        /* --- å…ƒä»¶ --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; }
        
        input, select { 
            width: 100%; padding: 12px; 
            border: 2px solid var(--input-border); 
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 10px; box-sizing: border-box; font-size: 16px; 
            transition: all 0.3s;
        }
        
        button {
            width: 100%; padding: 14px; background-color: var(--primary-color);
            color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        button.btn-ai { background: linear-gradient(135deg, #6c5ce7 0%, #5b4cc4 100%); }
        button.btn-analyze {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            margin-top: 15px; display: none; box-shadow: 0 4px 10px rgba(214, 48, 49, 0.3);
        }
        button.btn-delete { width: auto; padding: 4px 10px; background-color: #ff7675; font-size: 12px; border-radius: 6px; margin-left: 10px; }

        /* æ–°å¢ï¼šæœ€æ„›æŒ‰éˆ•æ¨£å¼ */
        .fav-controls { display: flex; gap: 8px; margin-top: 8px; }
        .btn-fav-save { background-color: #ff7675; width: auto; padding: 10px; flex:1; font-size: 14px; }
        .btn-fav-load { background-color: #0984e3; width: auto; padding: 10px; flex:1; font-size: 14px; }
        
        /* æœ€æ„›æ¸…å–®é …ç›® */
        .fav-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--input-border); }
        .fav-item-row:last-child { border-bottom: none; }
        .fav-item-name { font-weight: bold; cursor: pointer; flex-grow: 1; color: var(--text-color); }
        
        /* --- å½ˆè·³è¦–çª— --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal {
            background: var(--modal-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; text-align: center;
            color: var(--text-color);
        }
        .analysis-result { background: var(--bg-color); padding: 15px; border-radius: 10px; text-align: left; margin: 15px 0; }
        .meal-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .meal-btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* é¤é»æŒ‰éˆ•é¡è‰² (å›ºå®šé¡è‰²æˆ–å¾®èª¿) */
        .meal-btn.breakfast { background-color: #fab1a0; color: #2d3436; }
        .meal-btn.lunch { background-color: #55efc4; color: #2d3436; }
        .meal-btn.dinner { background-color: #74b9ff; color: #2d3436; }
        .meal-btn.snack { background-color: #ffeaa7; color: #2d3436; }

        .loading-spinner { display: none; text-align: center; padding: 20px; color: var(--accent-color); font-weight: bold; }
        #image-preview { width: 100%; border-radius: 10px; margin-top: 15px; display: none; }
        .goal-section { display: none; margin-top: 20px; background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 10px; text-align: center; }

        /* --- æ‡¸æµ®é¸å–® --- */
        .fab-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 999;
            display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 10px;
        }
        .fab-main {
            width: 56px; height: 56px; background-color: var(--text-color); border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center;
            cursor: pointer; color: var(--card-bg); font-size: 24px; transition: transform 0.3s;
        }
        .fab-main:active { transform: scale(0.9); }
        .fab-menu { display: none; flex-direction: column; gap: 10px; align-items: flex-end; }
        .fab-menu.show { display: flex; }
        .fab-item {
            background-color: var(--card-bg); color: var(--text-color); padding: 8px 15px; border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 14px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; border: 1px solid var(--input-border);
        }
        .fab-divider { height: 1px; background: #eee; width: 100%; margin: 5px 0; }
        
        .lang-btn {
            padding: 5px 10px; font-size: 12px; border: 1px solid var(--input-border); background: var(--bg-color); 
            border-radius: 15px; margin-left: 5px; cursor: pointer; color: var(--text-color);
        }
        .lang-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="date-control">
        <label id="txt-date-label">ğŸ“… ç´€éŒ„æ—¥æœŸï¼š</label>
        <input type="date" id="current-date" onchange="changeDate()">
    </div>

    <div class="dashboard-header">
        <div class="label" id="txt-total-intake">ä»Šæ—¥æ”å–</div>
        <div class="big-cal" id="total-cal-display">0</div>
        <div class="label"><span id="txt-kcal-unit">kcal</span> / <span id="txt-goal-label">ç›®æ¨™</span> <span id="target-cal-display">--</span></div>

        <div class="nutrition-grid">
            <div class="nutri-box"><span class="n-val" id="sum-protein">0</span><span class="n-label" id="lbl-pro">è›‹ç™½è³ª</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-fat">0</span><span class="n-label" id="lbl-fat">è„‚è‚ª</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-carb">0</span><span class="n-label" id="lbl-carb">ç¢³æ°´</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-sugar">0</span><span class="n-label" id="lbl-sugar">ç³–</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-sodium">0</span><span class="n-label" id="lbl-sod">éˆ‰(mg)</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-sat-fat">0</span><span class="n-label" id="lbl-sat">é£½å’Œè„‚</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-trans-fat">0</span><span class="n-label" id="lbl-trans">åå¼è„‚</span></div>
            <div class="nutri-box"><span class="n-val" id="water-val">--</span><span class="n-label" id="lbl-water">ç›®æ¨™æ°´</span></div>
        </div>
    </div>

    <div class="card">
        <h3 id="txt-chart-title">ğŸ“Š ç‡Ÿé¤Šèˆ‡ç†±é‡åˆ†æ</h3>
        <div class="chart-grid">
            <div>
                <h4 class="chart-title" id="txt-chart-macro">ä»Šæ—¥ä¸‰å¤§ç‡Ÿé¤Šç´  (PFC)</h4>
                <div class="chart-container" style="height:200px;">
                    <canvas id="macroChart"></canvas>
                </div>
            </div>
            <div>
                <h4 class="chart-title" id="txt-chart-weekly">æœ¬é€±ç†±é‡è¶¨å‹¢</h4>
                <div class="chart-container" style="height:200px;">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 style="color: var(--accent-color);" id="txt-ai-title">ğŸ“¸ AI é£²é£Ÿåˆ†æ</h2>
        <div style="text-align: center;">
            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleFileSelect(this)">
            
            <button class="btn-ai" onclick="document.getElementById('image-upload').click()" id="btn-take-photo">ğŸ“¸ 1. æ‹ç…§ / é¸æ“‡åœ–ç‰‡</button>
            <button id="analyze-btn" class="btn-analyze" onclick="startAnalysis()">âœ¨ 2. <span id="txt-analyze-btn">é€å‡ºåœ–ç‰‡åˆ†æ</span></button>
        </div>

        <div class="loading-spinner" id="ai-loading">ğŸ¤– <span id="txt-ai-loading">AI æ­£åœ¨åˆ†æé£Ÿç‰©ç‡Ÿé¤Šï¼Œè«‹ç¨å€™...</span></div>
        <img id="image-preview">
    </div>

    <div class="card">
        <h3>ğŸ½ï¸ <span id="display-date-text">ä»Šæ—¥</span> <span id="txt-record-title">é£²é£Ÿç´€éŒ„</span></h3>
        
        <div class="meal-section" id="section-breakfast">
            <div class="meal-header">
                <div><span class="meal-title" id="title-breakfast">ğŸ³ æ—©é¤</span> <span class="meal-goal">(<span class="txt-suggest">å»ºè­°</span>: <span id="goal-breakfast">0</span>)</span></div>
                <div class="meal-progress" id="prog-breakfast">0 kcal</div>
            </div>
            <ul class="meal-list" id="list-breakfast"></ul>
        </div>

        <div class="meal-section" id="section-lunch">
            <div class="meal-header">
                <div><span class="meal-title" id="title-lunch">ğŸ± åˆé¤</span> <span class="meal-goal">(<span class="txt-suggest">å»ºè­°</span>: <span id="goal-lunch">0</span>)</span></div>
                <div class="meal-progress" id="prog-lunch">0 kcal</div>
            </div>
            <ul class="meal-list" id="list-lunch"></ul>
        </div>

        <div class="meal-section" id="section-dinner">
            <div class="meal-header">
                <div><span class="meal-title" id="title-dinner">ğŸ² æ™šé¤</span> <span class="meal-goal">(<span class="txt-suggest">å»ºè­°</span>: <span id="goal-dinner">0</span>)</span></div>
                <div class="meal-progress" id="prog-dinner">0 kcal</div>
            </div>
            <ul class="meal-list" id="list-dinner"></ul>
        </div>

        <div class="meal-section" id="section-snack">
            <div class="meal-header">
                <div><span class="meal-title" id="title-snack">ğŸª é»å¿ƒ</span> <span class="meal-goal">(<span class="txt-suggest">å»ºè­°</span>: <span id="goal-snack">0</span>)</span></div>
                <div class="meal-progress" id="prog-snack">0 kcal</div>
            </div>
            <ul class="meal-list" id="list-snack"></ul>
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd;">
            <label id="txt-manual-label">æ‰‹å‹•è£œå…… (åƒ…ç†±é‡)</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="manual-name" placeholder="é£Ÿç‰©åç¨±">
                <input type="number" id="manual-cal" placeholder="å¡è·¯é‡Œ">
            </div>
            <select id="manual-type" style="margin-bottom: 10px;"></select>
            
            <button onclick="addManualFood()" style="background-color: #95a5a6;" id="btn-add-record">â• åŠ å…¥ç´€éŒ„</button>
            
            <div class="fav-controls">
                <button class="btn-fav-save" onclick="saveToFavorites()">â¤ï¸ <span id="btn-fav-save">åŠ å…¥æœ€æ„›</span></button>
                <button class="btn-fav-load" onclick="openFavModal()">ğŸ“‚ <span id="btn-fav-load">é¸æ“‡å¸¸åƒé£Ÿç‰©</span></button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 id="txt-settings-title">âš™ï¸ å€‹äººæ•¸æ“šè¨­å®š</h3>
        <div class="form-group">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label id="lbl-gender">æ€§åˆ¥</label><select id="gender"><option value="male" id="opt-male">ç”·</option><option value="female" id="opt-female">å¥³</option></select></div>
                <div><label id="lbl-age">å¹´é½¡</label><input type="number" id="age" placeholder="25"></div>
                <div><label id="lbl-height">èº«é«˜</label><input type="number" id="height" placeholder="170"></div>
                <div><label id="lbl-weight">é«”é‡</label><input type="number" id="weight" placeholder="60"></div>
            </div>
            
            <label style="margin-top: 10px;" id="lbl-activity">æ´»å‹•é‡</label>
            <select id="activity">
                <option value="1.2" id="opt-act-1">ä¹…å (è¾¦å…¬å®¤)</option>
                <option value="1.375" id="opt-act-2">è¼•åº¦ (æ¯é€±é‹å‹•1-3å¤©)</option>
                <option value="1.55" id="opt-act-3">ä¸­åº¦ (æ¯é€±é‹å‹•3-5å¤©)</option>
                <option value="1.725" id="opt-act-4">é«˜åº¦ (æ¯é€±é‹å‹•6-7å¤©)</option>
            </select>
            
            <label style="margin-top: 10px; color: var(--accent-color);" id="lbl-meal-mode">ğŸ½ï¸ æ¯æ—¥é¤æ•¸æ¨¡å¼</label>
            <select id="meal-mode" onchange="calculateProfile()">
                <option value="4" selected id="opt-mode-4">æ¨™æº– (3é¤+é»å¿ƒ)</option>
                <option value="3" id="opt-mode-3">3é¤ (ç„¡é»å¿ƒ)</option>
                <option value="2" id="opt-mode-2">2é¤ (168æ–·é£Ÿ)</option>
                <option value="1" id="opt-mode-1">1é¤ (OMAD)</option>
            </select>

            <button onclick="calculateProfile()" style="margin-top: 15px;" id="btn-calc">ğŸ”„ å„²å­˜ä¸¦æ›´æ–°ä»‹é¢</button>
        </div>
        
        <div id="goal-result" class="goal-section">
            <span id="txt-res-tdee">TDEE</span>ï¼š<span id="tdee-val">0</span> kcal | <span id="txt-res-target">æ¸›é‡ç›®æ¨™</span>ï¼š<span id="target-cal-val">0</span> kcal
        </div>
    </div>
</div>

<div class="modal-overlay" id="analysis-modal">
    <div class="modal">
        <h3>âœ¨ <span id="txt-modal-title">AI åˆ†æå ±å‘Š</span></h3>
        <div class="analysis-result" id="analysis-content"></div>
        <p id="txt-modal-ask">è«‹å•é€™æ˜¯å“ªä¸€é¤ï¼Ÿ</p>
        <div class="meal-selector" id="modal-meal-buttons"></div>
        <button onclick="closeModal('analysis-modal')" style="margin-top: 15px; background: #95a5a6;" id="btn-cancel">å–æ¶ˆ</button>
    </div>
</div>

<div class="modal-overlay" id="fav-modal">
    <div class="modal">
        <h3>â¤ï¸ <span id="txt-fav-title">å¸¸åƒé£Ÿç‰©æ¸…å–®</span></h3>
        <div style="max-height: 300px; overflow-y: auto; text-align: left;" id="fav-list-container">
            </div>
        <button onclick="closeModal('fav-modal')" style="margin-top: 15px; background: #95a5a6;" id="btn-fav-close">é—œé–‰</button>
    </div>
</div>

<div class="fab-container">
    <div class="fab-menu" id="fab-menu">
        
        <div class="fab-item" onclick="toggleTheme()">
            ğŸŒ“ <span id="menu-theme">æ·±è‰²æ¨¡å¼</span>
        </div>

        <div class="fab-item" style="cursor: default;">
            ğŸŒ 
            <span class="lang-btn" onclick="setLang('zh-TW')">ç¹</span>
            <span class="lang-btn" onclick="setLang('zh-CN')">ç®€</span>
            <span class="lang-btn" onclick="setLang('en')">EN</span>
            <span class="lang-btn" onclick="setLang('ja')">æ—¥</span>
        </div>
        
        <label class="fab-item" onclick="triggerImport()">
            ğŸ“¥ <span id="menu-import">åŒ¯å…¥é‚„åŸ</span>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)" accept=".json">
        </label>
        <div class="fab-item" onclick="exportData()">ğŸ“¤ <span id="menu-export">åŒ¯å‡ºå‚™ä»½</span></div>
    </div>
    <div class="fab-main" onclick="toggleFabMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
    </div>
</div>

<script>
    // --- å¤šåœ‹èªè¨€è¨­å®š (i18n) ---
    const i18n = {
        "zh-TW": {
            dateLabel: "ğŸ“… ç´€éŒ„æ—¥æœŸï¼š", totalIntake: "ä»Šæ—¥æ”å–", goal: "ç›®æ¨™",
            pro: "è›‹ç™½è³ª", fat: "è„‚è‚ª", carb: "ç¢³æ°´", sugar: "ç³–", sod: "éˆ‰(mg)", sat: "é£½å’Œè„‚", trans: "åå¼è„‚", water: "ç›®æ¨™æ°´",
            chartTitle: "ğŸ“Š ç‡Ÿé¤Šèˆ‡ç†±é‡åˆ†æ", chartMacro: "ä»Šæ—¥ä¸‰å¤§ç‡Ÿé¤Šç´  (PFC)", chartWeekly: "æœ¬é€±ç†±é‡è¶¨å‹¢",
            aiTitle: "ğŸ“¸ AI é£²é£Ÿåˆ†æ", btnPhoto: "ğŸ“¸ 1. æ‹ç…§ / é¸æ“‡åœ–ç‰‡", btnAnalyze: "é€å‡ºåœ–ç‰‡åˆ†æ", aiLoading: "AI æ­£åœ¨åˆ†æé£Ÿç‰©ç‡Ÿé¤Šï¼Œè«‹ç¨å€™...",
            recordTitle: "é£²é£Ÿç´€éŒ„", manualLabel: "æ‰‹å‹•è£œå…… (åƒ…ç†±é‡)", placeholderName: "é£Ÿç‰©åç¨±", placeholderCal: "å¡è·¯é‡Œ",
            btnAdd: "â• åŠ å…¥ç´€éŒ„", btnFavSave: "åŠ å…¥æœ€æ„›", btnFavLoad: "é¸æ“‡å¸¸åƒé£Ÿç‰©",
            settingsTitle: "âš™ï¸ å€‹äººæ•¸æ“šè¨­å®š", gender: "æ€§åˆ¥", male: "ç”·", female: "å¥³", age: "å¹´é½¡", height: "èº«é«˜", weight: "é«”é‡",
            activity: "æ´»å‹•é‡", act1: "ä¹…å (è¾¦å…¬å®¤)", act2: "è¼•åº¦ (æ¯é€±é‹å‹•1-3å¤©)", act3: "ä¸­åº¦ (æ¯é€±é‹å‹•3-5å¤©)", act4: "é«˜åº¦ (æ¯é€±é‹å‹•6-7å¤©)",
            mealMode: "ğŸ½ï¸ æ¯æ—¥é¤æ•¸æ¨¡å¼", mode4: "æ¨™æº– (3é¤+é»å¿ƒ)", mode3: "3é¤ (ç„¡é»å¿ƒ)", mode2: "2é¤ (168æ–·é£Ÿ)", mode1: "1é¤ (OMAD)",
            btnCalc: "ğŸ”„ å„²å­˜ä¸¦æ›´æ–°ä»‹é¢", resTdee: "TDEE", resTarget: "æ¸›é‡ç›®æ¨™",
            modalTitle: "AI åˆ†æå ±å‘Š", modalAsk: "è«‹å•é€™æ˜¯å“ªä¸€é¤ï¼Ÿ", btnCancel: "å–æ¶ˆ",
            favTitle: "å¸¸åƒé£Ÿç‰©æ¸…å–®", btnClose: "é—œé–‰",
            menuImport: "åŒ¯å…¥é‚„åŸ", menuExport: "åŒ¯å‡ºå‚™ä»½", menuTheme: "åˆ‡æ›ä¸»é¡Œ", suggest: "å»ºè­°",
            meals: { breakfast: "ğŸ³ æ—©é¤", lunch: "ğŸ± åˆé¤", dinner: "ğŸ² æ™šé¤", snack: "ğŸª é»å¿ƒ", meal1: "ğŸ½ï¸ ç¬¬ä¸€é¤", meal2: "ğŸ½ï¸ ç¬¬äºŒé¤", mealBig: "ğŸ† å”¯ä¸€å¤§é¤" },
            alertDel: "ç¢ºå®šè¦åˆªé™¤ï¼Ÿ", alertFavAdded: "å·²åŠ å…¥æœ€æ„›ï¼", alertFavExist: "é€™å€‹é£Ÿç‰©å·²ç¶“åœ¨æœ€æ„›æ¸…å–®å›‰ï¼", alertSelImg: "è«‹å…ˆé¸æ“‡åœ–ç‰‡ï¼", alertAiFail: "AI åˆ†æå¤±æ•—ï¼š", alertFill: "è«‹å¡«å¯«è³‡æ–™", alertNameCal: "è«‹è¼¸å…¥åç¨±èˆ‡ç†±é‡", alertImportOk: "ğŸ‰ è³‡æ–™é‚„åŸæˆåŠŸï¼", alertImportFail: "âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤"
        },
        "zh-CN": {
            dateLabel: "ğŸ“… è®°å½•æ—¥æœŸï¼š", totalIntake: "ä»Šæ—¥æ‘„å–", goal: "ç›®æ ‡",
            pro: "è›‹ç™½è´¨", fat: "è„‚è‚ª", carb: "ç¢³æ°´", sugar: "ç³–", sod: "é’ (mg)", sat: "é¥±å’Œè„‚", trans: "åå¼è„‚", water: "ç›®æ ‡æ°´",
            chartTitle: "ğŸ“Š è¥å…»ä¸çƒ­é‡åˆ†æ", chartMacro: "ä»Šæ—¥ä¸‰å¤§è¥å…»ç´  (PFC)", chartWeekly: "æœ¬å‘¨çƒ­é‡è¶‹åŠ¿",
            aiTitle: "ğŸ“¸ AI é¥®é£Ÿåˆ†æ", btnPhoto: "ğŸ“¸ 1. æ‹ç…§ / é€‰æ‹©å›¾ç‰‡", btnAnalyze: "å‘é€å›¾ç‰‡åˆ†æ", aiLoading: "AI æ­£åœ¨åˆ†æé£Ÿç‰©è¥å…»ï¼Œè¯·ç¨å€™...",
            recordTitle: "é¥®é£Ÿè®°å½•", manualLabel: "æ‰‹åŠ¨è¡¥å…… (ä»…çƒ­é‡)", placeholderName: "é£Ÿç‰©åç§°", placeholderCal: "å¡è·¯é‡Œ",
            btnAdd: "â• åŠ å…¥è®°å½•", btnFavSave: "åŠ å…¥æ”¶è—", btnFavLoad: "é€‰æ‹©å¸¸åƒé£Ÿç‰©",
            settingsTitle: "âš™ï¸ ä¸ªäººæ•°æ®è®¾å®š", gender: "æ€§åˆ«", male: "ç”·", female: "å¥³", age: "å¹´é¾„", height: "èº«é«˜", weight: "ä½“é‡",
            activity: "æ´»åŠ¨é‡", act1: "ä¹…å (åŠå…¬å®¤)", act2: "è½»åº¦ (æ¯å‘¨è¿åŠ¨1-3å¤©)", act3: "ä¸­åº¦ (æ¯å‘¨è¿åŠ¨3-5å¤©)", act4: "é«˜åº¦ (æ¯å‘¨è¿åŠ¨6-7å¤©)",
            mealMode: "ğŸ½ï¸ æ¯æ—¥é¤æ•°æ¨¡å¼", mode4: "æ ‡å‡† (3é¤+ç‚¹å¿ƒ)", mode3: "3é¤ (æ— ç‚¹å¿ƒ)", mode2: "2é¤ (168æ–­é£Ÿ)", mode1: "1é¤ (OMAD)",
            btnCalc: "ğŸ”„ ä¿å­˜å¹¶æ›´æ–°ç•Œé¢", resTdee: "TDEE", resTarget: "å‡é‡ç›®æ ‡",
            modalTitle: "AI åˆ†ææŠ¥å‘Š", modalAsk: "è¯·é—®è¿™æ˜¯å“ªä¸€é¤ï¼Ÿ", btnCancel: "å–æ¶ˆ",
            favTitle: "å¸¸åƒé£Ÿç‰©æ¸…å•", btnClose: "å…³é—­",
            menuImport: "å¯¼å…¥è¿˜åŸ", menuExport: "å¯¼å‡ºå¤‡ä»½", menuTheme: "åˆ‡æ¢ä¸»é¢˜", suggest: "å»ºè®®",
            meals: { breakfast: "ğŸ³ æ—©é¤", lunch: "ğŸ± åˆé¤", dinner: "ğŸ² æ™šé¤", snack: "ğŸª ç‚¹å¿ƒ", meal1: "ğŸ½ï¸ ç¬¬ä¸€é¤", meal2: "ğŸ½ï¸ ç¬¬äºŒé¤", mealBig: "ğŸ† å”¯ä¸€å¤§é¤" },
            alertDel: "ç¡®å®šè¦åˆ é™¤ï¼Ÿ", alertFavAdded: "å·²åŠ å…¥æ”¶è—ï¼", alertFavExist: "è¿™ä¸ªé£Ÿç‰©å·²ç»åœ¨æ”¶è—æ¸…å•å•°ï¼", alertSelImg: "è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼", alertAiFail: "AI åˆ†æå¤±è´¥ï¼š", alertFill: "è¯·å¡«å†™èµ„æ–™", alertNameCal: "è¯·è¾“å…¥åç§°ä¸çƒ­é‡", alertImportOk: "ğŸ‰ èµ„æ–™è¿˜åŸæˆåŠŸï¼", alertImportFail: "âŒ æ¡£æ¡ˆæ ¼å¼é”™è¯¯"
        },
        "en": {
            dateLabel: "ğŸ“… Date:", totalIntake: "Total Intake", goal: "Goal",
            pro: "Protein", fat: "Fat", carb: "Carb", sugar: "Sugar", sod: "Sodium", sat: "Sat. Fat", trans: "Trans Fat", water: "Water",
            chartTitle: "ğŸ“Š Nutrition Analysis", chartMacro: "Macros (PFC)", chartWeekly: "Weekly Calories",
            aiTitle: "ğŸ“¸ AI Analysis", btnPhoto: "ğŸ“¸ 1. Select Photo", btnAnalyze: "Analyze", aiLoading: "AI is analyzing...",
            recordTitle: "Food Log", manualLabel: "Manual Entry (Calorie only)", placeholderName: "Food Name", placeholderCal: "Calories",
            btnAdd: "â• Add Log", btnFavSave: "Save Favorite", btnFavLoad: "Load Favorite",
            settingsTitle: "âš™ï¸ Profile Settings", gender: "Gender", male: "Male", female: "Female", age: "Age", height: "Height", weight: "Weight",
            activity: "Activity Level", act1: "Sedentary", act2: "Lightly Active", act3: "Moderately Active", act4: "Very Active",
            mealMode: "ğŸ½ï¸ Meal Mode", mode4: "Standard (3+Snack)", mode3: "3 Meals", mode2: "2 Meals (168)", mode1: "OMAD",
            btnCalc: "ğŸ”„ Save & Update", resTdee: "TDEE", resTarget: "Target",
            modalTitle: "AI Report", modalAsk: "Which meal is this?", btnCancel: "Cancel",
            favTitle: "Favorite Foods", btnClose: "Close",
            menuImport: "Import Data", menuExport: "Export Data", menuTheme: "Switch Theme", suggest: "Goal",
            meals: { breakfast: "ğŸ³ Breakfast", lunch: "ğŸ± Lunch", dinner: "ğŸ² Dinner", snack: "ğŸª Snack", meal1: "ğŸ½ï¸ Meal 1", meal2: "ğŸ½ï¸ Meal 2", mealBig: "ğŸ† Big Meal" },
            alertDel: "Delete this item?", alertFavAdded: "Saved to favorites!", alertFavExist: "Already in favorites!", alertSelImg: "Select image first!", alertAiFail: "AI Failed: ", alertFill: "Fill all fields", alertNameCal: "Enter name and calories", alertImportOk: "ğŸ‰ Data Restored!", alertImportFail: "âŒ Invalid File"
        },
        "ja": {
            dateLabel: "ğŸ“… æ—¥ä»˜ï¼š", totalIntake: "æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼", goal: "ç›®æ¨™",
            pro: "ã‚¿ãƒ³ãƒ‘ã‚¯è³ª", fat: "è„‚è³ª", carb: "ç‚­æ°´åŒ–ç‰©", sugar: "ç³–è³ª", sod: "å¡©åˆ†", sat: "é£½å’Œè„‚è‚ª", trans: "ãƒˆãƒ©ãƒ³ã‚¹è„‚è‚ª", water: "æ°´åˆ†ç›®æ¨™",
            chartTitle: "ğŸ“Š æ „é¤Šåˆ†æ", chartMacro: "ä¸‰å¤§æ „é¤Šç´  (PFC)", chartWeekly: "é€±é–“ã‚«ãƒ­ãƒªãƒ¼",
            aiTitle: "ğŸ“¸ AIé£Ÿäº‹åˆ†æ", btnPhoto: "ğŸ“¸ 1. å†™çœŸã‚’é¸æŠ", btnAnalyze: "åˆ†æé–‹å§‹", aiLoading: "AIåˆ†æä¸­...",
            recordTitle: "é£Ÿäº‹è¨˜éŒ²", manualLabel: "æ‰‹å‹•å…¥åŠ› (ã‚«ãƒ­ãƒªãƒ¼ã®ã¿)", placeholderName: "é£Ÿå“å", placeholderCal: "kcal",
            btnAdd: "â• è¨˜éŒ²è¿½åŠ ", btnFavSave: "ãŠæ°—ã«å…¥ã‚Šä¿å­˜", btnFavLoad: "ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰é¸æŠ",
            settingsTitle: "âš™ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š", gender: "æ€§åˆ¥", male: "ç”·æ€§", female: "å¥³æ€§", age: "å¹´é½¢", height: "èº«é•·", weight: "ä½“é‡",
            activity: "æ´»å‹•ãƒ¬ãƒ™ãƒ«", act1: "åº§ã‚Šä»•äº‹", act2: "è»½ã„é‹å‹• (é€±1-3)", act3: "ä¸­ç¨‹åº¦ã®é‹å‹• (é€±3-5)", act4: "æ¿€ã—ã„é‹å‹• (é€±6-7)",
            mealMode: "ğŸ½ï¸ é£Ÿäº‹å›æ•°", mode4: "æ¨™æº– (3é£Ÿ+é–“é£Ÿ)", mode3: "3é£Ÿã®ã¿", mode2: "2é£Ÿ (168æ–­é£Ÿ)", mode1: "1é£Ÿ (OMAD)",
            btnCalc: "ğŸ”„ ä¿å­˜ã—ã¦æ›´æ–°", resTdee: "TDEE", resTarget: "ç›®æ¨™",
            modalTitle: "AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ", modalAsk: "ã©ã®é£Ÿäº‹ã§ã™ã‹ï¼Ÿ", btnCancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
            favTitle: "ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆ", btnClose: "é–‰ã˜ã‚‹",
            menuImport: "å¾©å…ƒ", menuExport: "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—", menuTheme: "ãƒ†ãƒ¼ãƒåˆ‡æ›¿", suggest: "ç›®å®‰",
            meals: { breakfast: "ğŸ³ æœé£Ÿ", lunch: "ğŸ± æ˜¼é£Ÿ", dinner: "ğŸ² å¤•é£Ÿ", snack: "ğŸª é–“é£Ÿ", meal1: "ğŸ½ï¸ é£Ÿäº‹1", meal2: "ğŸ½ï¸ é£Ÿäº‹2", mealBig: "ğŸ† å¤§ç››ã‚Š" },
            alertDel: "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", alertFavAdded: "ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜ã—ã¾ã—ãŸï¼", alertFavExist: "æ—¢ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™", alertSelImg: "ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„", alertAiFail: "AIã‚¨ãƒ©ãƒ¼: ", alertFill: "å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", alertNameCal: "åç§°ã¨ã‚«ãƒ­ãƒªãƒ¼ã‚’å…¥åŠ›", alertImportOk: "ğŸ‰ å¾©å…ƒå®Œäº†ï¼", alertImportFail: "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼"
        }
    };

    let curLang = localStorage.getItem('appLang') || "zh-TW";
    let curTheme = localStorage.getItem('appTheme') || "light";

    // --- å…¨åŸŸè®Šæ•¸ ---
    let foodItems = []; 
    let targetCalories = 2000;
    let tempAIResult = null;
    let selectedDate = new Date().toISOString().split('T')[0];
    let currentMealMode = "4";
    let favoriteFoods = JSON.parse(localStorage.getItem('myFavorites') || "[]");

    let macroChart = null;
    let weeklyChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        setTheme(curTheme);
        setLang(curLang);
        document.getElementById('current-date').value = selectedDate;
        loadProfile();
        loadFoodData(selectedDate);
        initCharts();
    });

    // --- ä¸»é¡Œåˆ‡æ› ---
    function toggleTheme() {
        const newTheme = curTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
    }
    function setTheme(theme) {
        curTheme = theme;
        localStorage.setItem('appTheme', theme);
        document.documentElement.setAttribute('data-theme', theme);
        // æ›´æ–°åœ–è¡¨é¡è‰²
        updateChartTheme(theme);
    }
    
    // --- èªè¨€åˆ‡æ›é‚è¼¯ ---
    function setLang(lang) {
        curLang = lang;
        localStorage.setItem('appLang', lang);
        const t = i18n[lang];

        // ç°¡å–®å°æ‡‰ ID èˆ‡ æ–‡å­—
        const mapping = {
            'txt-date-label': t.dateLabel, 'txt-total-intake': t.totalIntake, 'txt-goal-label': t.goal,
            'lbl-pro': t.pro, 'lbl-fat': t.fat, 'lbl-carb': t.carb, 'lbl-sugar': t.sugar, 'lbl-sod': t.sod, 'lbl-sat': t.sat, 'lbl-trans': t.trans, 'lbl-water': t.water,
            'txt-chart-title': t.chartTitle, 'txt-chart-macro': t.chartMacro, 'txt-chart-weekly': t.chartWeekly,
            'txt-ai-title': t.aiTitle, 'btn-take-photo': t.btnPhoto, 'txt-analyze-btn': t.btnAnalyze, 'txt-ai-loading': t.aiLoading,
            'txt-record-title': t.recordTitle, 'txt-manual-label': t.manualLabel, 'btn-add-record': t.btnAdd, 'btn-fav-save': t.btnFavSave, 'btn-fav-load': t.btnFavLoad,
            'txt-settings-title': t.settingsTitle, 'lbl-gender': t.gender, 'opt-male': t.male, 'opt-female': t.female,
            'lbl-age': t.age, 'lbl-height': t.height, 'lbl-weight': t.weight, 'lbl-activity': t.activity,
            'opt-act-1': t.act1, 'opt-act-2': t.act2, 'opt-act-3': t.act3, 'opt-act-4': t.act4,
            'lbl-meal-mode': t.mealMode, 'opt-mode-4': t.mode4, 'opt-mode-3': t.mode3, 'opt-mode-2': t.mode2, 'opt-mode-1': t.mode1,
            'btn-calc': t.btnCalc, 'txt-res-tdee': t.resTdee, 'txt-res-target': t.resTarget,
            'txt-modal-title': t.modalTitle, 'txt-modal-ask': t.modalAsk, 'btn-cancel': t.btnCancel,
            'txt-fav-title': t.favTitle, 'btn-fav-close': t.btnClose, 'menu-import': t.menuImport, 'menu-export': t.menuExport, 'menu-theme': t.menuTheme
        };

        for(let id in mapping) {
            const el = document.getElementById(id);
            if(el) el.innerText = mapping[id];
        }

        document.getElementById('manual-name').placeholder = t.placeholderName;
        document.getElementById('manual-cal').placeholder = t.placeholderCal;
        document.querySelectorAll('.txt-suggest').forEach(el => el.innerText = t.suggest);
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        
        updateMealUI(); 
        if(macroChart) {
            macroChart.data.labels = [t.pro, t.fat, t.carb];
            macroChart.update();
        }
    }

    // --- æˆ‘çš„æœ€æ„› ---
    function saveToFavorites() {
        const name = document.getElementById('manual-name').value;
        const cal = document.getElementById('manual-cal').value;
        if(!name || !cal) { alert(i18n[curLang].alertNameCal); return; }
        if(favoriteFoods.some(f => f.name === name)) { alert(i18n[curLang].alertFavExist); return; }
        favoriteFoods.push({ name: name, cal: parseFloat(cal) });
        localStorage.setItem('myFavorites', JSON.stringify(favoriteFoods));
        alert(i18n[curLang].alertFavAdded);
    }
    function openFavModal() {
        const list = document.getElementById('fav-list-container');
        list.innerHTML = '';
        if(favoriteFoods.length === 0) { list.innerHTML = '<p style="color:#888; text-align:center;">(Empty)</p>'; } 
        else {
            favoriteFoods.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'fav-item-row';
                div.innerHTML = `<div class="fav-item-name" onclick="pickFav(${index})">${item.name} <span style="font-size:0.9em; opacity:0.8;">(${item.cal} kcal)</span></div><button class="btn-delete" onclick="deleteFav(${index})">X</button>`;
                list.appendChild(div);
            });
        }
        document.getElementById('fav-modal').style.display = 'flex';
    }
    function pickFav(index) {
        const item = favoriteFoods[index];
        document.getElementById('manual-name').value = item.name;
        document.getElementById('manual-cal').value = item.cal;
        closeModal('fav-modal');
    }
    function deleteFav(index) {
        if(confirm(i18n[curLang].alertDel)) {
            favoriteFoods.splice(index, 1);
            localStorage.setItem('myFavorites', JSON.stringify(favoriteFoods));
            openFavModal();
        }
    }

    // --- åœ–è¡¨ ---
    function initCharts() {
        const t = i18n[curLang];
        Chart.defaults.color = curTheme === 'dark' ? '#e0e0e0' : '#2c3e50';
        
        const ctxMacro = document.getElementById('macroChart').getContext('2d');
        macroChart = new Chart(ctxMacro, {
            type: 'doughnut',
            data: {
                labels: [t.pro, t.fat, t.carb],
                datasets: [{ data: [0, 0, 0], backgroundColor: ['#ff7675', '#fdcb6e', '#74b9ff'], borderColor: 'transparent' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const ctxWeekly = document.getElementById('weeklyChart').getContext('2d');
        weeklyChart = new Chart(ctxWeekly, {
            type: 'bar',
            data: {
                labels: [], datasets: [{ label: 'kcal', data: [], backgroundColor: '#2ecc71', borderRadius: 5 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.1)' } } } }
        });
        
        updateChartTheme(curTheme);
    }

    function updateChartTheme(theme) {
        const textColor = theme === 'dark' ? '#e0e0e0' : '#2c3e50';
        const gridColor = theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        
        Chart.defaults.color = textColor;
        if(weeklyChart) {
            weeklyChart.options.scales.x.ticks.color = textColor;
            weeklyChart.options.scales.y.ticks.color = textColor;
            weeklyChart.options.scales.y.grid.color = gridColor;
            weeklyChart.update();
        }
        if(macroChart) {
            macroChart.options.plugins.legend.labels.color = textColor;
            macroChart.update();
        }
    }

    function updateCharts(totalNutri) {
        if (macroChart) {
            macroChart.data.datasets[0].data = [Math.round(totalNutri.pro), Math.round(totalNutri.fat), Math.round(totalNutri.carb)];
            macroChart.update();
        }
        if (weeklyChart) {
            const labels = []; const data = []; const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                labels.push(dateStr.slice(5));
                const stored = localStorage.getItem(`record_${dateStr}`);
                let dayCal = 0;
                if(stored) { JSON.parse(stored).forEach(item => dayCal += (item.nutri.calories || 0)); }
                data.push(Math.round(dayCal));
            }
            weeklyChart.data.labels = labels; weeklyChart.data.datasets[0].data = data; weeklyChart.update();
        }
    }

    // --- UI æ›´æ–°èˆ‡æ ¸å¿ƒé‚è¼¯ ---
    function updateMealUI() {
        const t = i18n[curLang].meals;
        const configs = {
            "4": { sections: ['breakfast', 'lunch', 'dinner', 'snack'], titles: { breakfast: t.breakfast, lunch: t.lunch, dinner: t.dinner, snack: t.snack }, ratios: { breakfast: 0.25, lunch: 0.35, dinner: 0.30, snack: 0.10 } },
            "3": { sections: ['breakfast', 'lunch', 'dinner'], titles: { breakfast: t.breakfast, lunch: t.lunch, dinner: t.dinner }, ratios: { breakfast: 0.30, lunch: 0.40, dinner: 0.30 } },
            "2": { sections: ['lunch', 'dinner'], titles: { lunch: t.meal1, dinner: t.meal2 }, ratios: { lunch: 0.50, dinner: 0.50 } },
            "1": { sections: ['dinner'], titles: { dinner: t.mealBig }, ratios: { dinner: 1.0 } }
        };

        const config = configs[currentMealMode];
        const allTypes = ['breakfast', 'lunch', 'dinner', 'snack'];

        allTypes.forEach(type => {
            const section = document.getElementById(`section-${type}`);
            if (config.sections.includes(type)) {
                section.style.display = 'block';
                document.getElementById(`title-${type}`).innerText = config.titles[type];
                const goal = Math.round(targetCalories * (config.ratios[type] || 0));
                document.getElementById(`goal-${type}`).innerText = goal;
            } else {
                section.style.display = 'none';
            }
        });

        const manualSelect = document.getElementById('manual-type');
        manualSelect.innerHTML = '';
        config.sections.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.text = config.titles[type];
            manualSelect.appendChild(option);
        });

        const modalBtns = document.getElementById('modal-meal-buttons');
        modalBtns.innerHTML = '';
        config.sections.forEach(type => {
            const btn = document.createElement('button');
            btn.className = `meal-btn ${type}`;
            btn.innerText = config.titles[type];
            btn.onclick = () => confirmAddFood(type);
            modalBtns.appendChild(btn);
        });
    }

    function calculateProfile(auto=false) {
        const h = parseFloat(document.getElementById('height').value);
        const w = parseFloat(document.getElementById('weight').value);
        const a = parseFloat(document.getElementById('age').value);
        const act = parseFloat(document.getElementById('activity').value);
        const g = document.getElementById('gender').value;
        const mode = document.getElementById('meal-mode').value;

        if (!h || !w || !a) { if(!auto) alert(i18n[curLang].alertFill); return; }

        let bmr = (g === 'male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161);
        let tdee = Math.round(bmr * act);
        targetCalories = tdee - 500; if(targetCalories < bmr) targetCalories = Math.round(bmr);
        
        currentMealMode = mode;
        document.getElementById('tdee-val').innerText = tdee;
        document.getElementById('target-cal-val').innerText = targetCalories;
        document.getElementById('target-cal-display').innerText = targetCalories;
        document.getElementById('water-val').innerText = Math.round(w * 35);
        document.getElementById('goal-result').style.display = 'block';

        saveProfile(); updateMealUI(); renderListAndStats(); 
    }

    function handleFileSelect(input) {
        const file = input.files[0]; if (!file) return;
        const preview = document.getElementById('image-preview');
        preview.src = URL.createObjectURL(file); preview.style.display = 'block';
        document.getElementById('analyze-btn').style.display = 'inline-block';
        document.getElementById('ai-loading').style.display = 'none';
    }

    async function startAnalysis() {
        const input = document.getElementById('image-upload');
        const file = input.files[0]; if (!file) { alert(i18n[curLang].alertSelImg); return; }
        document.getElementById('analyze-btn').style.display = 'none';
        document.getElementById('ai-loading').style.display = 'block';

        try {
            const base64 = await toBase64(file);
            const result = await callCloudflareAI(base64);
            if (result) {
                tempAIResult = {
                    name: result.foodName,
                    nutri: {
                        calories: Number(result.calories) || 0, protein: Number(result.protein) || 0, fat: Number(result.fat) || 0,
                        carbohydrate: Number(result.carbohydrate) || 0, sugar: Number(result.sugar) || 0, sodium: Number(result.sodium) || 0,
                        saturatedFat: Number(result.saturatedFat) || 0, transFat: Number(result.transFat) || 0
                    }
                }; showModal();
            }
        } catch (e) {
            console.error(e); alert(i18n[curLang].alertAiFail + e.message);
            document.getElementById('analyze-btn').style.display = 'inline-block';
        } finally { document.getElementById('ai-loading').style.display = 'none'; }
    }

    function changeDate() { selectedDate = document.getElementById('current-date').value; document.getElementById('display-date-text').innerText = selectedDate; loadFoodData(selectedDate); }
    function saveFoodData() { localStorage.setItem(`record_${selectedDate}`, JSON.stringify(foodItems)); }
    function loadFoodData(date) { const stored = localStorage.getItem(`record_${date}`); foodItems = stored ? JSON.parse(stored) : []; renderListAndStats(); }
    
    function saveProfile() {
        const profile = { gender: document.getElementById('gender').value, age: document.getElementById('age').value, height: document.getElementById('height').value, weight: document.getElementById('weight').value, activity: document.getElementById('activity').value, mealMode: document.getElementById('meal-mode').value };
        localStorage.setItem('myProfile_v5', JSON.stringify(profile));
    }
    function loadProfile() {
        const stored = localStorage.getItem('myProfile_v5');
        if (stored) {
            const p = JSON.parse(stored);
            document.getElementById('gender').value = p.gender; document.getElementById('age').value = p.age; document.getElementById('height').value = p.height;
            document.getElementById('weight').value = p.weight; document.getElementById('activity').value = p.activity;
            if(p.mealMode) document.getElementById('meal-mode').value = p.mealMode;
            calculateProfile(true);
        } else { updateMealUI(); }
    }

    function renderListAndStats() {
        ['breakfast', 'lunch', 'dinner', 'snack'].forEach(type => { const el = document.getElementById(`list-${type}`); if(el) el.innerHTML = ''; });
        let total = { cal:0, pro:0, fat:0, carb:0, sugar:0, sod:0, sat:0, trans:0 };
        let mealTotals = { breakfast:0, lunch:0, dinner:0, snack:0 };

        foodItems.forEach((item, index) => {
            total.cal += (Number(item.nutri.calories) || 0); total.pro += (Number(item.nutri.protein) || 0);
            total.fat += (Number(item.nutri.fat) || 0); total.carb += (Number(item.nutri.carbohydrate) || 0);
            total.sugar += (Number(item.nutri.sugar) || 0); total.sod += (Number(item.nutri.sodium) || 0);
            total.sat += (Number(item.nutri.saturatedFat) || 0); total.trans += (Number(item.nutri.transFat) || 0);
            if(mealTotals[item.type] !== undefined) mealTotals[item.type] += (Number(item.nutri.calories) || 0);
            const li = document.createElement('li');
            li.innerHTML = `<div class="food-info"><div class="name">${item.name}</div><div class="detail">ğŸ”¥${Math.round(item.nutri.calories)} | P:${item.nutri.protein} F:${item.nutri.fat} C:${item.nutri.carbohydrate}</div></div><button class="btn-delete" onclick="deleteItem(${index})">X</button>`;
            const listEl = document.getElementById(`list-${item.type}`); if(listEl) listEl.appendChild(li);
        });

        for(let type in mealTotals) {
            const el = document.getElementById(`prog-${type}`); const goalEl = document.getElementById(`goal-${type}`);
            if(el && goalEl && el.offsetParent !== null) {
                const current = Math.round(mealTotals[type]); const goal = parseInt(goalEl.innerText) || 0;
                el.innerText = `${current} kcal`; el.style.color = (goal > 0 && current > goal) ? '#e74c3c' : 'var(--text-color)';
            }
        }
        document.getElementById('total-cal-display').innerText = Math.round(total.cal);
        ['pro','fat','carb','sugar','sodium','sat-fat','trans-fat'].forEach((k,i) => {
            const val = Object.values(total)[i+1];
            const el = document.getElementById(`sum-${k}`);
            if(el) el.innerText = (k === 'sodium') ? Math.round(val) : val.toFixed(1);
        });
        updateCharts(total);
    }

    function deleteItem(index) { if(confirm(i18n[curLang].alertDel)) { foodItems.splice(index, 1); saveFoodData(); renderListAndStats(); } }
    
    // æ‡¸æµ®é¸å–®èˆ‡æª”æ¡ˆ
    function toggleFabMenu() { document.getElementById('fab-menu').classList.toggle('show'); }
    function exportData() {
        const data = {};
        for(let i=0; i<localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key.startsWith('record_') || key.startsWith('myProfile') || key === 'myFavorites') {
                data[key] = localStorage.getItem(key);
            }
        }
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `nutrition_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); toggleFabMenu();
    }
    function triggerImport() { document.getElementById('import-file').click(); }
    function importData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                for(let key in data) localStorage.setItem(key, data[key]);
                alert(i18n[curLang].alertImportOk); location.reload();
            } catch(err) { alert(i18n[curLang].alertImportFail); }
        }; reader.readAsText(file); toggleFabMenu();
    }

    async function callCloudflareAI(base64) {
        const url = "https://nameless-meadow-cf7b.jtwen12345us.workers.dev/";
        const promptMap = {
            "zh-TW": "ä½ æ˜¯ä¸€ä½ç‡Ÿé¤Šå¸«ã€‚è«‹åˆ†æåœ–ç‰‡é£Ÿç‰©çš„ã€Œå…«å¤§ç‡Ÿé¤ŠæŒ‡æ¨™ã€ã€‚å›å‚³ç´” JSON æ ¼å¼ã€‚æ¬„ä½ï¼šfoodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFatã€‚",
            "zh-CN": "ä½ æ˜¯ä¸€ä½è¥å…»å¸ˆã€‚è¯·åˆ†æå›¾ç‰‡é£Ÿç‰©çš„ã€Œå…«å¤§è¥å…»æŒ‡æ ‡ã€ã€‚å›ä¼ çº¯ JSON æ ¼å¼ã€‚æ ä½ï¼šfoodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFatã€‚",
            "en": "You are a nutritionist. Analyze the image for 8 nutritional metrics. Return PURE JSON. Fields: foodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFat.",
            "ja": "ã‚ãªãŸã¯æ „é¤Šå£«ã§ã™ã€‚ç”»åƒã®é£Ÿå“ã®8ã¤ã®æ „é¤ŠæŒ‡æ¨™ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚ç´”ç²‹ãªJSONã§è¿”ã—ã¦ãã ã•ã„ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šfoodName, calories, protein, fat, carbohydrate, sugar, sodium, saturatedFat, transFatã€‚"
        };
        const resp = await fetch(url, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [ { text: promptMap[curLang] }, { inline_data: { mime_type: "image/jpeg", data: base64 } } ] }] })
        });
        const data = await resp.json();
        if (data.error) throw new Error(JSON.stringify(data.error));
        let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        return JSON.parse(text);
    }

    function showModal() {
        const d = tempAIResult;
        document.getElementById('analysis-content').innerHTML = `<strong>${d.name}</strong><br>ğŸ”¥ ${d.nutri.calories}<br>ğŸ¥© ${d.nutri.protein} | ğŸ¥‘ ${d.nutri.fat} | ğŸ ${d.nutri.carbohydrate}`;
        document.getElementById('analysis-modal').style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; if(id==='analysis-modal') tempAIResult = null; }
    function confirmAddFood(type) { foodItems.push({ type: type, name: tempAIResult.name, nutri: tempAIResult.nutri }); saveFoodData(); renderListAndStats(); closeModal('analysis-modal'); }
    function addManualFood() {
        const name = document.getElementById('manual-name').value; const cal = parseFloat(document.getElementById('manual-cal').value); const type = document.getElementById('manual-type').value;
        if (name && cal) {
            foodItems.push({ type: type, name: name, nutri: { calories: cal, protein:0, fat:0, carbohydrate:0, sugar:0, sodium:0, saturatedFat:0, transFat:0 } });
            saveFoodData(); renderListAndStats();
            document.getElementById('manual-name').value = ''; document.getElementById('manual-cal').value = '';
        } else { alert(i18n[curLang].alertNameCal); }
    }
    function toBase64(file) { return new Promise((r, j) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result.split(',')[1]); reader.onerror = j; }); }
</script>

</body>
</html>
