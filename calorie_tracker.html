<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ å¿«æ¨‚å°ç‹—ç‡Ÿé¤Šç®¡å®¶</title>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼è¨­å®š --- */
        :root {
            --primary-color: #2ecc71; /* æ¸…çˆ½ç¶  */
            --primary-dark: #27ae60;
            --accent-color: #6c5ce7;  /* ç§‘æŠ€ç´« */
            --bg-color: #f0f2f5;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            display: grid;
            gap: 20px;
        }

        h1, h2, h3 { text-align: center; margin: 0 0 15px 0; color: var(--primary-dark); }
        h1 { font-size: 1.8em; margin-bottom: 20px; }
        
        /* å¡ç‰‡æ¨¡çµ„ */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        /* --- å„€è¡¨æ¿æ¨£å¼ (é‡é») --- */
        .dashboard-header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 10px;
        }
        .dashboard-header h2 { color: white; margin-bottom: 5px; font-size: 1.4em; }
        .dashboard-header .big-cal { font-size: 3em; font-weight: bold; line-height: 1.2; }
        .dashboard-header .label { font-size: 0.9em; opacity: 0.9; }

        /* å…«å¤§æŒ‡æ¨™ç¶²æ ¼ */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* æ‰‹æ©Ÿç‰ˆä¸€è¡Œ4å€‹ */
            gap: 10px;
            margin-top: 15px;
        }
        
        .nutri-box {
            background: rgba(255,255,255,0.2);
            padding: 8px 5px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        .nutri-box .n-val { display: block; font-weight: bold; font-size: 1.1em; }
        .nutri-box .n-label { font-size: 0.75em; opacity: 0.9; }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ–ï¼šç¨å¾®æ“ ä¸€é»æ²’é—œä¿‚ï¼Œä½†è¦çœ‹å¾—åˆ° */
        @media (max-width: 400px) {
            .nutrition-grid { grid-template-columns: repeat(4, 1fr); gap: 5px; }
            .nutri-box { padding: 5px 2px; }
            .nutri-box .n-val { font-size: 0.9em; }
        }

        /* --- è¡¨å–®èˆ‡æŒ‰éˆ• --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            box-sizing: border-box; 
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary-color); outline: none; }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(46, 204, 113, 0.2);
            transition: all 0.2s;
        }
        button:active { transform: scale(0.98); }
        
        button.btn-ai {
            background: linear-gradient(135deg, #6c5ce7 0%, #5b4cc4 100%);
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
        }

        button.btn-delete {
            width: auto;
            padding: 6px 12px;
            background-color: #ff7675;
            font-size: 13px;
            margin: 0;
            box-shadow: none;
        }

        /* --- é£Ÿç‰©æ¸…å–® --- */
        #food-list { list-style: none; padding: 0; margin-top: 10px; }
        #food-list li {
            background: white;
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .food-info { flex: 1; }
        .food-name { font-weight: bold; font-size: 1.1em; color: var(--text-color); }
        .food-detail { font-size: 0.85em; color: #7f8c8d; margin-top: 4px; }

        /* è¼‰å…¥å‹•ç•« */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--accent-color);
            font-weight: bold;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .preview-box img { 
            width: 100%; 
            border-radius: 10px; 
            margin-top: 15px; 
            display: none; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* ç›®æ¨™èˆ‡å»ºè­° */
        .goal-section { 
            display: none; 
            margin-top: 20px;
            background: #e8f8f5;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .remaining-cal { font-size: 1.2em; font-weight: bold; color: var(--primary-dark); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="dashboard-header">
        <div class="label">ä»Šæ—¥å·²æ”å–ç†±é‡</div>
        <div class="big-cal" id="total-cal-display">0</div>
        <div class="label">kcal</div>

        <div class="nutrition-grid">
            <div class="nutri-box"><span class="n-val" id="sum-protein">0</span><span class="n-label">è›‹ç™½è³ª</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-fat">0</span><span class="n-label">è„‚è‚ª</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-carb">0</span><span class="n-label">ç¢³æ°´</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-sugar">0</span><span class="n-label">ç³–</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-sodium">0</span><span class="n-label">éˆ‰(mg)</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-sat-fat">0</span><span class="n-label">é£½å’Œè„‚</span></div>
            <div class="nutri-box"><span class="n-val" id="sum-trans-fat">0</span><span class="n-label">åå¼è„‚</span></div>
            <div class="nutri-box"><span class="n-val" id="water-val">2000</span><span class="n-label">ç›®æ¨™æ°´</span></div>
        </div>
    </div>

    <div class="card ai-section">
        <h2 style="color: var(--accent-color);">ğŸ“¸ AI é£²é£Ÿç´€éŒ„</h2>
        <div style="text-align: center;">
            <input type="file" id="image-upload" accept="image/*" capture="environment" style="display: none;" onchange="previewAndAnalyze(this)">
            <button class="btn-ai" onclick="document.getElementById('image-upload').click()">ğŸ“¸ æ‹ç…§ / ä¸Šå‚³é£Ÿç‰©ç…§</button>
        </div>

        <div class="preview-box">
            <div class="loading-spinner" id="ai-loading">ğŸ¤– AI æ­£åœ¨åˆ†æç…§ç‰‡ä¸­çš„ç‡Ÿé¤Šæˆåˆ†...</div>
            <img id="image-preview">
        </div>
    </div>

    <div class="card">
        <h3>ğŸ½ï¸ ä»Šæ—¥é£²é£Ÿæ¸…å–®</h3>
        <ul id="food-list">
            </ul>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd;">
            <label>æ‰‹å‹•è£œå…… (åƒ…ç†±é‡)</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="manual-name" placeholder="é£Ÿç‰©åç¨±">
                <input type="number" id="manual-cal" placeholder="å¡è·¯é‡Œ">
            </div>
            <button onclick="addManualFood()" style="margin-top: 10px; background-color: #95a5a6;">â• åŠ å…¥æ‰‹å‹•ç´€éŒ„</button>
        </div>
    </div>

    <div class="card">
        <h3>âš™ï¸ å€‹äººæª”æ¡ˆè¨­å®š</h3>
        <div class="form-group">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label>æ€§åˆ¥</label>
                    <select id="gender"><option value="male">ç”·</option><option value="female">å¥³</option></select>
                </div>
                <div>
                    <label>å¹´é½¡</label>
                    <input type="number" id="age" placeholder="25">
                </div>
                <div>
                    <label>èº«é«˜ (cm)</label>
                    <input type="number" id="height" placeholder="170">
                </div>
                <div>
                    <label>é«”é‡ (kg)</label>
                    <input type="number" id="weight" placeholder="60">
                </div>
            </div>
            <label style="margin-top: 10px;">æ´»å‹•é‡</label>
            <select id="activity">
                <option value="1.2">ä¹…å (è¾¦å…¬å®¤)</option>
                <option value="1.375">è¼•åº¦ (æ¯é€±é‹å‹•1-3å¤©)</option>
                <option value="1.55">ä¸­åº¦ (æ¯é€±é‹å‹•3-5å¤©)</option>
                <option value="1.725">é«˜åº¦ (æ¯é€±é‹å‹•6-7å¤©)</option>
            </select>
            <button onclick="calculateProfile()" style="margin-top: 15px;">ğŸ”„ æ›´æ–°ç›®æ¨™æ•¸æ“š</button>
        </div>
        
        <div id="goal-result" class="goal-section">
            æ‚¨çš„ TDEE (ç¶­æŒé«”é‡)ï¼š<span id="tdee-val">0</span> kcal<br>
            <div style="margin-top: 5px; font-size: 1.1em;">
                ğŸ¯ æ¸›é‡ç›®æ¨™å‰©é¤˜ï¼š<span id="remaining-cal" class="remaining-cal">0</span> kcal
            </div>
        </div>
    </div>

</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let foodItems = []; 
    let targetCalories = 2000; // é è¨­ç›®æ¨™

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    // --- æ ¸å¿ƒåŠŸèƒ½ 1: å­˜å–è³‡æ–™ ---
    function saveData() {
        localStorage.setItem('myFoodItems', JSON.stringify(foodItems));
        
        // å„²å­˜å€‹äººè³‡æ–™
        const profile = {
            gender: document.getElementById('gender').value,
            age: document.getElementById('age').value,
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            activity: document.getElementById('activity').value
        };
        localStorage.setItem('myProfile', JSON.stringify(profile));
    }

    function loadData() {
        // è¼‰å…¥é£Ÿç‰©
        const storedFoods = localStorage.getItem('myFoodItems');
        if (storedFoods) {
            foodItems = JSON.parse(storedFoods);
            renderListAndStats();
        }

        // è¼‰å…¥å€‹äººè³‡æ–™
        const storedProfile = localStorage.getItem('myProfile');
        if (storedProfile) {
            const p = JSON.parse(storedProfile);
            document.getElementById('gender').value = p.gender;
            document.getElementById('age').value = p.age;
            document.getElementById('height').value = p.height;
            document.getElementById('weight').value = p.weight;
            document.getElementById('activity').value = p.activity;
            calculateProfile(true);
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 2: æ¸²æŸ“ç•«é¢èˆ‡è¨ˆç®—ç¸½å’Œ ---
    function renderListAndStats() {
        const list = document.getElementById('food-list');
        list.innerHTML = '';
        
        // æº–å‚™ç´¯åŠ è®Šæ•¸
        let total = { cal:0, pro:0, fat:0, carb:0, sugar:0, sod:0, sat:0, trans:0 };

        foodItems.forEach((item, index) => {
            // ç´¯åŠ æ•¸å€¼ (ç¢ºä¿æ˜¯æ•¸å­—)
            total.cal += (Number(item.nutri.calories) || 0);
            total.pro += (Number(item.nutri.protein) || 0);
            total.fat += (Number(item.nutri.fat) || 0);
            total.carb += (Number(item.nutri.carbohydrate) || 0);
            total.sugar += (Number(item.nutri.sugar) || 0);
            total.sod += (Number(item.nutri.sodium) || 0);
            total.sat += (Number(item.nutri.saturatedFat) || 0);
            total.trans += (Number(item.nutri.transFat) || 0);

            // ç”¢ç”Ÿåˆ—è¡¨é …ç›®
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="food-info">
                    <div class="food-name">${item.name}</div>
                    <div class="food-detail">
                        ğŸ”¥${Math.round(item.nutri.calories)} | 
                        P:${item.nutri.protein}g | F:${item.nutri.fat}g | C:${item.nutri.carbohydrate}g
                    </div>
                </div>
                <button class="btn-delete" onclick="deleteItem(${index})">åˆªé™¤</button>
            `;
            list.appendChild(li);
        });

        // æ›´æ–°ä¸Šæ–¹å„€è¡¨æ¿
        updateDashboard(total);
    }

    function updateDashboard(t) {
        // æ•¸å­—å‹•ç•«æ•ˆæœ (ç°¡å–®ç‰ˆï¼šç›´æ¥æ›´æ–°)
        document.getElementById('total-cal-display').innerText = Math.round(t.cal);
        
        document.getElementById('sum-protein').innerText = t.pro.toFixed(1);
        document.getElementById('sum-fat').innerText = t.fat.toFixed(1);
        document.getElementById('sum-carb').innerText = t.carb.toFixed(1);
        document.getElementById('sum-sugar').innerText = t.sugar.toFixed(1);
        document.getElementById('sum-sodium
